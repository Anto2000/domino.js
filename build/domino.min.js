/* domino.js - a JS fast dashboard prototyping framework - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(J){function V(){y.strict?S.apply(this,arguments):W.apply(this,arguments)}function S(){var a="",g;for(g in arguments)a+=arguments[g];throw Error(a);}function W(){if(y.verbose){var a=[],g;for(g in arguments)a.push(arguments[g]);y.displayTime&&a.unshift(("00000000"+((new Date).getTime()-T)).substr(-8));console.log.apply(console,a)}}var T=new Date;if(J.domino)throw Error("domino already exists");J.domino=function(a,g){function i(b){var b=b||{},j={getEvents:T,getLabel:J,expand:D,dump:z,warn:q,
die:p,get:l,events:[],services:[]};b.request&&(j.request=function(b,j){this.services.push({service:b,params:j})});b.full&&(j.addModule=n,j.request=C,j.update=c);return j}function d(b,j){var v,f=j||{};void 0===b&&p("Property name not specified");void 0!==E[b]&&p('Property "'+b+'" already exists');void 0!==O[b]&&p('"'+b+'" can not be used to name a property');X[b]=f.label||b;void 0!==f.type&&(k.isValid(f.type)?F[b]=f.type:q('Property "'+b+'": Type not valid'));void 0!==f.setter&&("function"!==k.get(f.setter)?
q('Property "'+b+'": Setter is not a function'):(A[b]=f.setter,Y[b]=!0));A[b]=A[b]||function(v){if(k.deepScalar(F[b])&&k.compare(v,E[b],F[b]))return!1;F[b]&&!k.check(F[b],v)?q('Property "'+b+'": Wrong type error'):E[b]=v;return!0};void 0!==f.getter&&("function"!==k.get(f.getter)?q('Property "'+b+'": Getter is not a function'):(x[b]=f.getter,Z[b]=!0));x[b]=x[b]||function(){return E[b]};if(void 0!==f.value||F[b])void 0!==f.value?$(b,f.value):z('Property "'+b+'": Initial value is missing');if(void 0!==
f.triggers)for(v in!k.check("array|string",f.triggers)&&q('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),H[b]=w.array(f.triggers),H[b]||[])K[H[b][v]]=K[H[b][v]]||[],K[H[b][v]].push(b);void 0!==f.dispatch&&(!k.check("array|string",f.dispatch)?q('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):P[b]=w.array(f.dispatch));return r}function h(b){var j=b||{};(void 0===j.id||"string"!==k.get(j.id))&&
p("The service id is not indicated.");k.check("function|string",j.url)||p("The service URL is not valid.");void 0!==Q[j.id]&&p('The service "'+j.id+'" already exists.');Q[j.id]=function(b){z('Calling service "'+j.id+'".');var f=b||{},b={contentType:f.contentType||j.contentType,dataType:f.dataType||j.dataType,type:(f.type||j.type||"GET").toString().toUpperCase(),data:"function"===k.get(j.data)?j.data.call(i(),f):f.data||j.data,url:"function"===k.get(j.url)?j.url.call(i(),f):j.url,error:function(b,
a){r.dispatchEvent("domino.ajaxFailed");var c=f.error||j.error,v=[],e=[],m={},d={},h=!1,g;if("function"===k.get(c)){var s=B(c,{parameters:[b,a,f],scope:{request:!0}}),c=w.array(s.events);for(g in c)h=!0,d[c[g]]=1;for(g in s.properties)void 0===m[g]?(m[g]=s.properties[g],h=!0):q('The property "'+g+'" is not a method nor a property.');if((s.services||[]).length)h=!0,e=e.concat(s.services)}else z('Loading failed with message "'+b+'" and status '+a.status+".");for(l in d)r.dispatchEvent(l,i()),v.push(r.getEvent(l,
i()));h&&o({events:v,update:m,services:e})}},a,c,m,e=y.shortcutPrefix,g=RegExp(e+"(\\w+)","g"),e=RegExp("^"+e+"(\\w+)$"),d=null,h;for("string"!==k.get(b.url)&&p('The URL is no more a string (typed "'+k.get(b.url)+'")');(h=b.url.match(g))&&b.url!==d;)for(a in d=b.url,h)c=D(h[a],f.params),b.url=b.url.replace(RegExp(h[a],"g"),c);a=!0;"string"===k.get(b.data)&&b.data.match(e)&&(b.data=D(b.data,f.params));if("object"===k.get(b.data))for(;a;)for(m in a=!1,b.data)"string"===k.get(b.data[m])&&b.data[m].match(e)&&
(b.data[m]=D(b.data[m],f.params),a=!0);b.success=function(b){z('Service "'+j.id+'" successfull.');var a,c,v,e,g={},h=[];e=[];var d={},s=!1,l=f.path||j.path,G=f.setter||j.setter,aa=f.success||j.success;"string"===k.get(G)&&(G=D(G,f.params));"string"===k.get(l)&&(l=D(l,f.params));e=b;(l||"").match(/^(?:\w+\.)*\w+$/)?c=k.get(l,"string")?l.split("."):void 0:"string"===k.get(l)&&q('Path "'+l+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(c)for(a in c)e=e[c[a]],void 0===e&&q('Wrong path "'+l+'" for service "'+
j.id+'".');c=w.array(j.events);for(a in c)g[c[a]]=1,s=!0;c=w.array(f.events);for(a in c)g[c[a]]=1,s=!0;G&&A[G]&&void 0!==e&&(d[G]=e,s=!0);if("function"===k.get(aa)){b=B(aa,{parameters:[b,f],scope:{request:!0}});c=w.array(b.events);for(m in c)g[c[m]]=1;for(m in b.properties)void 0===d[m]?(d[m]=b.properties[m],s=!0):q('The property "'+m+'" is not a method nor a property.');if((b.services||[]).length)s=!0,h=h.concat(b.services)}e=[];for(v in g)r.dispatchEvent(v,i()),e.push(r.getEvent(v,i()));s&&o({events:e,
update:d,services:h})};h=f.before||j.before;if(null!=h&&"function"===k.get(h)){var l;a={};g=[];e=[];c={};var d=!1,n=B(h,{parameters:[f]});h=w.array(n.events);for(m in h)c[h[m]]=1,d=!0;for(m in n.properties)void 0===a[m]?(a[m]=n.properties[m],d=!0):q('The key "'+m+'" is not a method nor a property.');if((n.services||[]).length)d=!0,e=e.concat(n.services);h=[];for(l in c)r.dispatchEvent(l,i()),h.push(r.getEvent(l,i()));d&&o({events:g,update:a,services:e})}f.abort&&U[j.id]&&U[j.id].abort();U[j.id]=w.ajax(b)};
return r}function n(b,c){var a,f={},g={},s,m,d;void 0===b&&p("Module class not specified.");"function"!==k.get(b)&&p("First parameter must be a function.");b.apply(f,(c||[]).concat(i()));s=f.triggers||{};for(d in s.events||{})L[d]=L[d]||[],L[d].push(s.events[d]);for(m in s.properties||{}){for(a in P[m]||[])M[m]=M[m]||[],M[m].push(s.properties[m]);void 0!==x[m]&&(l(m),B(s.properties[m],{parameters:[r.getEvent("domino.initialUpdate",i())]}))}for(d in K||{})g[d]=1;for(d in I||{})g[d]=1;for(d in N||{})g[d]=
1;for(d in g)f.addEventListener(d,e);ca.push(f);return f}function c(b){o({update:b});return this}function e(b){o({events:[b]})}function o(b){var c,a,f,e,d,g,h,l=!1,k=[],n=[],b=b||{},p={},t={};b.loop=(+b.loop||0)+1;var u=w.array(b.events);g=w.array(b.services);var x=b.update||{};if(y.verbose){z("Iteration "+b.loop+" (main loop)");if(u.length){h=[];for(a in u)h.push(u[a].type);z(" -> Events: ",h)}if(g.length){h=[];for(a in g)h.push(g[a].service);z(" -> Services: ",h)}h=[];for(a in x)h.push(a);h.length&&
z(" -> Update: ",h)}for(c in x)if(void 0===A[c])q('The property "'+c+'" is not referenced.');else if(h=$(c,x[c])||!!b.force){for(a in M[c])B(M[c][a],{parameters:[r.getEvent(c,i())]});for(a in P[c]||[])p[P[c][a]]=1}for(a in g||[])C(g[a].service,g[a].params);for(d in p)r.dispatchEvent(d,i()),k.push(r.getEvent(d,i())),l=!0;for(a in u){d=u[a];for(f in g=d.data||{},c=K[d.type]||[],c)void 0!==g[c[f]]&&(l=!0,t[c[f]]=g[c[f]]);for(e in L[d.type])B(L[d.type][e],{parameters:[d]});for(f in I[d.type]||[]){g=B(I[d.type][f],
{parameters:[d],scope:{request:!0}});c=w.array(g.events);for(e in c)p[c[e]]=1;for(e in g.properties)void 0===t[e]?(l=!0,t[e]=g.properties[e]):q('The property "'+e+'" is not a method nor a property.');if((g.services||[]).length)l=!0,n=n.concat(g.services)}for(f in N[d.type]||[])p[N[d.type][f]]=1}l&&o({events:k,update:t,services:n,loop:b.loop})}function l(b){if(x[b]){if(Z[b]){for(var c=[],a={},f=1,d=arguments.length;f<d;f++)c.push(arguments[f]);a[b]=E[b];return B(x[b],{parameters:c,inputValues:a}).returned}return x[b]()}q('Property "'+
b+'" not referenced.')}function $(b,c){if(A[b]){if(Y[b]){var a,f;a=[];f={};f[b]=c;for(var d=1,e=arguments.length;d<e;d++)a.push(arguments[d]);f=B(A[b],{parameters:a,inputValues:f});(a="boolean"!==k.get(f.returned)||f.returned)&&(E[b]=f.properties[b]);return a}return A[b].call(i(),c)}q('Property "'+b+'" not referenced.');return!1}function C(b,c){if(Q[b])Q[b](c);else q('Service "'+b+'" not referenced.');return this}function B(b,c){var a,f,d=c||{},e=i(d.scope);"function"!==k.get(b)&&p("The first parameter must be a function");
for(a in d.inputValues||{})e[a]=d.inputValues[a];f={returned:b.apply(e,d.parameters||[]),properties:{},events:{},services:[]};null!=e.events&&!k.check("array",e.events)?q("Events must be stored in an array."):f.events=e.events;for(a in e)void 0!==A[a]?f.properties[a]=e[a]:void 0===O[a]&&q('The key "'+a+'" is not a method nor a property.');for(a in d.inputValues)f.properties[a]=e[a];for(a in e.services)f.services[a]=e.services[a];return f}function J(b){return X[b]}function T(b){return H[b]}function q(b){var a=
["["+r.name+"]"];y.strict||a.push("WARNING");for(var c in arguments)a.push(arguments[c]);V.apply(r,a)}function p(b){var a=["["+r.name+"]"],c;for(c in arguments)a.push(arguments[c]);S.apply(r,a)}function z(){var b=["["+r.name+"]"],a;for(a in arguments)b.push(arguments[a]);W.apply(r,b)}function D(b){var a=arguments.length,c=(b||"").toString().match(RegExp("^"+y.shortcutPrefix+"(\\w+)$"));if(!c||!c.length)return b;c=c[1];if("function"===k.get(R[c]))return R[c].call(i());if("function"===k.get(x[c]))return l(c);
for(var f=1;f<a;f++)if(void 0!==(arguments[f]||{})[c])return arguments[f][c];return b}ba.call(this);var r=this,w=u.utils,k=u.struct,F={},X={},H={},x={},A={},E={},Z={},Y={},ca=[],K={},P={},L={},M={},I={},N={},Q={},U={},R={},O={events:1,services:1,hacks:1};(function(){for(var a in Object.prototype)O[a]=1;for(a in i({full:1}))O[a]=1})();var t={};this.name="domino";"string"===k.get(a)?this.name=a:void 0!==a&&"object"===k.get(a)?t=a:void 0!==g&&"object"===k.get(g)&&(t=g);this.name=t.name||this.name;(function(){for(var a in t.properties||
[])d(t.properties[a].id,t.properties[a]);for(a in t.hacks||[]){var c=void 0,e=void 0,f=t.hacks[a]||{};void 0===f.triggers&&p("A hack requires at least one trigger to be added");void 0===f.method&&void 0===f.dispatch&&p('A hack requires at least a method or a "dispatch" value to be added');c=w.array(f.triggers);for(e in c)f.method&&(I[c[e]]=I[c[e]]||[],I[c[e]].push(f.method)),f.dispatch&&(N[c[e]]=(N[c[e]]||[]).concat(w.array(f.dispatch)))}for(a in t.services||[])h(t.services[a]);for(a in t.shortcuts||
[])c=t.shortcuts[a].id,e=t.shortcuts[a].method,void 0===c&&p("Shortcut ID not specified."),R[c]&&p('Shortcut "'+c+'" already exists.'),void 0===e&&p("Shortcut method not specified."),R[c]=e})();return i({full:!0})};var u=J.domino;u.utils={array:function(a,g){var i="string"===u.struct.get(a)?a.split(g||" "):"array"===u.struct.get(a)?a:[a],d=[],h;for(h in i)i[h]&&d.push(i[h]);return d},ajax:function(a,g){"string"===typeof a?a={url:a,ok:g}:"object"!==this.type.get(a)&&S("[domino.global] Invalid parameter given to AJAX");
var i=a.type||"GET",d=a.url||"",h=a.contentType||"application/x-www-form-urlencoded",n=a.dataType||"json",c=new XMLHttpRequest,e,o,l;if(a.data){if("string"===typeof a.data)o=a.data;else if(/json/.test(h))o=JSON.stringify(a.data);else{o=[];for(l in a.data)o.push(encodeURIComponent(l)+"="+encodeURIComponent(a.data[l]));o=o.join("&")}/GET|DEL/i.test(i)&&(d+=/\?/.test(d)?"&"+o:"?"+o,o="")}c.onreadystatechange=function(){if(4==c.readyState)if(e&&clearTimeout(e),/^2/.test(c.status)){o=c.responseText;if(/json/.test(n))try{o=
JSON.parse(c.responseText)}catch(d){return a.error&&a.error("JSON parse error: "+d.message,c)}a.success&&a.success(o,c)}else{var g=+c.status?c.responseText:c.responseText.length?"Aborted: "+c.responseText:"Aborted";a.error&&a.error(g,c)}};c.open(i,d,!0);c.setRequestHeader("Content-Type",h);if(a.headers)for(l in a.headers)c.setRequestHeader(l,a.headers[l]);a.timeout&&(e=setTimeout(function(){c.onreadystatechange=function(){};c.abort();a.error&&a.error&&a.error("timeout",c)},1E3*a.timeout));c.send(o);
return c}};u.struct=function(){var a=["number","string","boolean","null","undefined"],g="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),i={},d=["*"],h;for(h in g){var n=g[h];d.push(n.toLowerCase());i["[object "+n+"]"]=n.toLowerCase()}return{get:function(a){return null==a?""+a:i[Object.prototype.toString.call(a)]||"object"},check:function(a,e){var g,h,i=this.get(e);if("string"===this.get(a)){g=a.replace(/^\?/,"").split(/\|/);for(h in g)0>d.indexOf(g[h])&&V("[domino.global] Invalid type");
if(null==e)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");h=a.split(/\|/);return!(!~h.indexOf("*")&&!~h.indexOf(i))}if("object"===this.get(a)){if("object"!==i)return!1;for(g in a)if(!this.check(a[g],e[g]))return!1;for(g in e)if(void 0===a[g])return!1;return!0}return!1},deepScalar:function(c){var e;if("string"===this.get(c)){c=c.replace(/^\?/,"").split(/\|/);for(e in c)if(0>a.indexOf(c[e]))return!1;return!0}if("object"===this.get(c)){for(e in c)if(!this.deepScalar(c[e]))return!1;return!0}return!1},
compare:function(a,e,d){this.get(a);this.get(e);var g;if(!this.deepScalar(d)||!this.check(d,a)||!this.check(d,e))return!1;if("string"===this.get(d))return a===e;if("object"===this.get(d)){for(g in d)if(!this.compare(a[g],e[g],d[g]))return!1;return!0}return!1},isValid:function(a){var e,g;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(g in a)if(0>d.indexOf(a[g]))return!1;return!0}if("object"===this.get(a)){for(e in a)if(!this.isValid(a[e]))return!1;return!0}return!1}}}();var C=u.utils,
y={strict:!1,verbose:!1,shortcutPrefix:":",displayTime:!1};u.settings=function(a,g){if("string"===typeof a&&void 0===g)return y[a];var i="object"===typeof a&&void 0===g?a||{}:{};"string"===typeof a&&(i[a]=g);for(var d in i)void 0!==y[d]&&(y[d]=i[d]);return this};u.EventDispatcher=function(){var a={};this.removeEventListener=function(g,i){if(!arguments.length)return this._handlers_={},this;var d,h,n,c,e=C.array(g);if(i)for(d in e){c=e[d];if(a[c]){n=[];for(h in a[c])a[c][h].handler!==i&&n.push(a[c][h]);
a[c]=n}a[c]&&0===a[c].length&&delete a[c]}else for(d in e)delete a[e[d]];return this};this.addEventListener=function(g,i){if(arguments.length)if(1===arguments.length&&"object"===C.type.get(arguments[0]))for(g in arguments[0])this.addEventListener(g,arguments[0][g]);else if(1<arguments.length){var d,g=arguments[0],i=arguments[1],h=C.array(g),n;for(n in h)d=h[n],a[d]||(a[d]=[]),a[d].push({handler:i})}return this};this.dispatchEvent=function(g,i){var d,h,n,c,e,o=C.array(g),i=void 0===i?{}:i;for(d in o)if(e=
o[d],a[e]){c=this.getEvent(e,i);n=[];for(h in a[e])a[e][h].handler(c),a[e][h].one||n.push(a[e][h]);a[e]=n}return this};this.getEvent=function(a,i){return{type:a,data:i,target:this}}};var ba=u.EventDispatcher;u.module=function(){ba.call(this);this.triggers={properties:{},events:{}}}})(window);
