/* domino.js - a JS fast dashboard prototyping framework - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(J){function X(){u.strict?T.apply(this,arguments):Y.apply(this,arguments)}function T(){var a="",d;for(d in arguments)a+=(a?" ":"")+arguments[d];throw Error(a);}function Y(){if(u.verbose){var a=[],d;for(d in arguments)a.push(arguments[d]);u.displayTime&&a.unshift(("00000000"+((new Date).getTime()-U)).substr(-8));console.log.apply(console,a)}}var U=new Date;if(J.domino)throw Error("domino already exists");J.domino=function(a,d){function h(b){var b=b||{},y={getEvents:J,getLabel:I,expand:C,warn:q,
log:x,die:n,get:k};b.full?(y.update=c,y.addModule=m,y.request=B,y.dispatchEvent=function(b,e){l({events:s.getEvent(b,e)})}):b.interact&&(y.request=function(b,e){this.services=this.services||[];this.services.push({service:b,params:e})},y.dispatchEvent=function(b,e){this.events=this.events||[];this.events.push({type:b,data:e})});return y}function f(b,y){var a,e=y||{};void 0===b&&n("Property name not specified");void 0!==D[b]&&n('Property "'+b+'" already exists');void 0!==O[b]&&n('"'+b+'" can not be used to name a property');
Z[b]=e.label||b;void 0!==e.type&&(j.isValid(e.type)?E[b]=e.type:q('Property "'+b+'": Type not valid'));void 0!==e.setter&&("function"!==j.get(e.setter)?q('Property "'+b+'": Setter is not a function'):(z[b]=e.setter,$[b]=!0));z[b]=z[b]||function(e){if(j.deepScalar(E[b])&&j.compare(e,D[b],E[b]))return!1;E[b]&&!j.check(E[b],e)?q('Property "'+b+'": Wrong type error'):D[b]=e;return!0};void 0!==e.getter&&("function"!==j.get(e.getter)?q('Property "'+b+'": Getter is not a function'):(v[b]=e.getter,aa[b]=
!0));v[b]=v[b]||function(){return D[b]};if(void 0!==e.value||E[b])void 0!==e.value?ba(b,e.value):x('Property "'+b+'": Initial value is missing');if(void 0!==e.triggers)for(a in!j.check("array|string",e.triggers)&&q('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),F[b]=t.array(e.triggers),F[b]||[])K[F[b][a]]=K[F[b][a]]||[],K[F[b][a]].push(b);void 0!==e.dispatch&&(!j.check("array|string",e.dispatch)?q('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):
Q[b]=t.array(e.dispatch));return s}function g(b){var a=b||{};(void 0===a.id||"string"!==j.get(a.id))&&n("The service id is not indicated.");j.check("function|string",a.url)||n("The service URL is not valid.");void 0!==R[a.id]&&n('The service "'+a.id+'" already exists.');R[a.id]=function(b){x('Calling service "'+a.id+'".');var e=b||{},b={contentType:e.contentType||a.contentType,dataType:e.dataType||a.dataType,type:(e.type||a.type||"GET").toString().toUpperCase(),data:"function"===j.get(a.data)?a.data.call(h(),
e):e.data||a.data,url:"function"===j.get(a.url)?a.url.call(h(),e):a.url,error:function(b,c){s.dispatchEvent("domino.ajaxFailed");var r=e.error||a.error;"function"===j.get(r)?A(r,{parameters:[b,c,e],loop:!0,scope:{interact:!0}}):x('Loading failed with message "'+b+'" and status '+c.status+".");for(event in dispatch)s.dispatchEvent(event,h()),events.push(s.getEvent(event,h()))}},c,d,w,i=u.shortcutPrefix,f=RegExp(i+"(\\w+)","g"),i=RegExp("^"+i+"(\\w+)$"),g=null,k;for("string"!==j.get(b.url)&&n('The URL is no more a string (typed "'+
j.get(b.url)+'")');(k=b.url.match(f))&&b.url!==g;)for(c in g=b.url,k)d=C(k[c],e.params),b.url=b.url.replace(RegExp(k[c],"g"),d);c=!0;"string"===j.get(b.data)&&b.data.match(i)&&(b.data=C(b.data,e.params));if("object"===j.get(b.data))for(;c;)for(w in c=!1,b.data)"string"===j.get(b.data[w])&&b.data[w].match(i)&&(b.data[w]=C(b.data[w],e.params),c=!0);b.success=function(b){x('Service "'+a.id+'" successfull.');var c,r,d,i,f={},V=[];i=[];var P={},k=!1,g=e.path||a.path,G=e.setter||a.setter,m=e.success||a.success;
"string"===j.get(G)&&(G=C(G,e.params));"string"===j.get(g)&&(g=C(g,e.params));i=b;(g||"").match(/^(?:\w+\.)*\w+$/)?r=j.get(g,"string")?g.split("."):void 0:"string"===j.get(g)&&q('Path "'+g+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(r)for(c in r)i=i[r[c]],void 0===i&&q('Wrong path "'+g+'" for service "'+a.id+'".');r=t.array(a.events);for(c in r)f[r[c]]=1,k=!0;r=t.array(e.events);for(c in r)f[r[c]]=1,k=!0;G&&z[G]&&void 0!==i&&(P[G]=i,k=!0);if("function"===j.get(m)){b=A(m,{parameters:[b,e],scope:{interact:!0}});
r=t.array(b.events);for(w in r)k=!0,f[r[w]]=1;for(w in b.update)void 0===P[w]?(P[w]=b.update[w],k=!0):q('The key "'+w+'" is nor a method neither a property.');if((b.services||[]).length)k=!0,V=V.concat(b.services)}i=[];for(d in f)s.dispatchEvent(d,h()),i.push(s.getEvent(d,h()));k&&l({events:i,update:P,services:V})};c=e.before||a.before;null!=c&&"function"===j.get(c)&&A(c,{parameters:[e],loop:!0});e.abort&&W[a.id]&&W[a.id].abort();W[a.id]=t.ajax(b)};return s}function m(b,a){var c,e={},d={},l,f,g;void 0===
b&&n("Module class not specified.");"function"!==j.get(b)&&n("First parameter must be a function.");b.apply(e,(a||[]).concat(h()));l=e.triggers||{};for(g in l.events||{})L[g]=L[g]||[],L[g].push(l.events[g]);for(f in l.properties||{}){for(c in Q[f]||[])M[f]=M[f]||[],M[f].push(l.properties[f]);void 0!==v[f]&&(k(f),A(l.properties[f],{parameters:[h()]}))}for(g in K||{})d[g]=1;for(g in H||{})d[g]=1;for(g in N||{})d[g]=1;for(g in d)e.addEventListener(g,i);U.push(e);return e}function c(b){l({update:b});
return this}function i(b){l({events:[b]})}function l(b){var a,c,e,i,d,f,g,k=!1,j=[],m=[],b=b||{},n={},p={};b.loop=(+b.loop||0)+1;var o=t.array(b.events);f=t.array(b.services);var v=b.update||{};if(u.verbose){x("Iteration "+b.loop+" (main loop)");if(o.length){g=[];for(c in o)g.push(o[c].type);x(" -> Events: ",g)}if(f.length){g=[];for(c in f)g.push(f[c].service);x(" -> Services: ",g)}g=[];for(c in v)g.push(c);g.length&&x(" -> Update: ",g)}for(a in v)if(void 0===z[a])q('The property "'+a+'" is not referenced.');
else if(g=ba(a,v[a])||!!b.force){for(c in M[a])A(M[a][c],{parameters:[h({interact:!0})]});for(c in Q[a]||[])n[Q[a][c]]=1}for(c in f||[])B(f[c].service,f[c].params);for(d in n)s.dispatchEvent(d,h()),j.push(s.getEvent(d,h())),k=!0;for(c in o){d=o[c];for(e in f=d.data||{},a=K[d.type]||[],a)void 0!==f[a[e]]&&(k=!0,p[a[e]]=f[a[e]]);for(i in L[d.type])A(L[d.type][i],{parameters:[h({interact:!0})]});for(e in H[d.type]||[]){f=A(H[d.type][e],{parameters:[d],scope:{interact:!0}});a=t.array(f.events);for(i in a)n[a[i]]=
1;for(i in f.update)void 0===p[i]?(k=!0,p[i]=f.update[i]):q('The property "'+i+'" is not a method nor a property.');if((f.services||[]).length)k=!0,m=m.concat(f.services)}for(e in N[d.type]||[])n[N[d.type][e]]=1}k&&l({events:j,update:p,services:m,loop:b.loop})}function k(b){if(v[b]){if(aa[b]){for(var a=[],c={},e=1,d=arguments.length;e<d;e++)a.push(arguments[e]);c[b]=D[b];a=A(v[b],{parameters:a,inputValues:c});return u.clone?t.clone(a.returned):a.returned}return u.clone?t.clone(v[b]()):v[b]()}q('Property "'+
b+'" not referenced.')}function ba(b,a){if(z[b]){if($[b]){var c,e;c=[];e={};u.clone&&(a=t.clone(a));e[b]=k(b);for(var d=1,f=arguments.length;d<f;d++)c.push(arguments[d]);e=A(z[b],{parameters:c,inputValues:e});(c="boolean"!==j.get(e.returned)||e.returned)&&(D[b]=e.update[b]);return c}return z[b].call(h(),u.clone?t.clone(a):a)}q('Property "'+b+'" not referenced.');return!1}function B(b,a){if(R[b])R[b](a);else q('Service "'+b+'" not referenced.');return this}function A(b,a){var c,e,d=a||{},f=h(d.scope);
"function"!==j.get(b)&&n("The first parameter must be a function");for(c in d.inputValues||{})f[c]=d.inputValues[c];e={returned:b.apply(f,d.parameters||[]),update:{},events:[],services:[]};null!=f.events&&!j.check("array",f.events)?q("Events must be stored in an array."):e.events=f.events;for(c in f)void 0!==z[c]?e.update[c]=f[c]:void 0===O[c]&&q('The key "'+c+'" is not a method nor a property.');for(c in d.inputValues)e.update[c]=f[c];for(c in f.services)e.services[c]=f.services[c];if(d.loop){d=
(e.services||[]).length||(e.events||[]).length;if(!d)for(c in e.update)d=!0;d&&l(e)}else return e}function I(b){return Z[b]}function J(b){return F[b]}function C(b){var a=arguments.length,c=(b||"").toString().match(RegExp("^"+u.shortcutPrefix+"(\\w+)$"));if(!c||!c.length)return b;c=c[1];if("function"===j.get(S[c]))return S[c].call(h());if("function"===j.get(v[c]))return k(c);for(var e=1;e<a;e++)if(void 0!==(arguments[e]||{})[c])return arguments[e][c];return b}function q(){var b=["["+s.name+"]"];u.strict||
b.push("WARNING");for(var a in arguments)b.push(arguments[a]);X.apply(s,b)}function n(){var b=["["+s.name+"]"],a;for(a in arguments)b.push(arguments[a]);T.apply(s,b)}function x(){var a=["["+s.name+"]"],c;for(c in arguments)a.push(arguments[c]);Y.apply(s,a)}ca.call(this);var s=this,t=o.utils,j=o.struct,E={},Z={},F={},v={},z={},D={},aa={},$={},U=[],K={},Q={},L={},M={},H={},N={},R={},W={},S={},O={events:1,services:1,hacks:1};(function(){for(var a in Object.prototype)O[a]=1;for(a in h({full:!0}))O[a]=
1})();var p={};this.name="domino";"string"===j.get(a)?this.name=a:void 0!==a&&"object"===j.get(a)?p=a:void 0!==d&&"object"===j.get(d)&&(p=d);this.name=p.name||this.name;(function(){for(var a in p.properties||[])f(p.properties[a].id,p.properties[a]);for(a in p.hacks||[]){var c=void 0,d=void 0,e=p.hacks[a]||{};void 0===e.triggers&&n("A hack requires at least one trigger to be added");void 0===e.method&&void 0===e.dispatch&&n('A hack requires at least a method or a "dispatch" value to be added');c=t.array(e.triggers);
for(d in c)e.method&&(H[c[d]]=H[c[d]]||[],H[c[d]].push(e.method)),e.dispatch&&(N[c[d]]=(N[c[d]]||[]).concat(t.array(e.dispatch)))}for(a in p.services||[])g(p.services[a]);for(a in p.shortcuts||[])c=p.shortcuts[a].id,d=p.shortcuts[a].method,void 0===c&&n("Shortcut ID not specified."),S[c]&&n('Shortcut "'+c+'" already exists.'),void 0===d&&n("Shortcut method not specified."),S[c]=d})();return h({full:!0})};var o=J.domino;o.utils={array:function(a,d){var h="string"===o.struct.get(a)?a.split(d||" "):
"array"===o.struct.get(a)?a:[a],f=[],g;for(g in h)h[g]&&f.push(h[g]);return f},clone:function(a){if(!a)return a;var d,h;if("array"===B.get(a))for(h in d=[],a)d[h]=this.clone(a[h]);else if("date"===B.get(a))d=new Date(a.getTime());else if("object"===B.get(a))if(a.prototype)d=a;else{d={};for(var f in a)d[f]=this.clone(a[f])}else d=a;return d},ajax:function(a,d){"string"===typeof a?a={url:a,ok:d}:"object"!==B.get(a)&&T("[domino.global] Invalid parameter given to AJAX");var h=a.type||"GET",f=a.url||"",
g=a.contentType||"application/x-www-form-urlencoded",m=a.dataType||"json",c=new XMLHttpRequest,i,l,k;if(a.data){if("string"===typeof a.data)l=a.data;else if(/json/.test(g))l=JSON.stringify(a.data);else{l=[];for(k in a.data)l.push(encodeURIComponent(k)+"="+encodeURIComponent(a.data[k]));l=l.join("&")}/GET|DEL/i.test(h)&&(f+=/\?/.test(f)?"&"+l:"?"+l,l="")}c.onreadystatechange=function(){if(4==c.readyState)if(i&&clearTimeout(i),/^2/.test(c.status)){l=c.responseText;if(/json/.test(m))try{l=JSON.parse(c.responseText)}catch(d){return a.error&&
a.error("JSON parse error: "+d.message,c)}a.success&&a.success(l,c)}else{var f=+c.status?c.responseText:c.responseText.length?"Aborted: "+c.responseText:"Aborted";a.error&&a.error(f,c)}};c.open(h,f,!0);c.setRequestHeader("Content-Type",g);if(a.headers)for(k in a.headers)c.setRequestHeader(k,a.headers[k]);a.timeout&&(i=setTimeout(function(){c.onreadystatechange=function(){};c.abort();a.error&&a.error&&a.error("timeout",c)},1E3*a.timeout));c.send(l);return c}};o.struct=function(){var a=["number","string",
"boolean","null","undefined"],d="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),h={},f=["*"],g;for(g in d){var m=d[g];f.push(m.toLowerCase());h["[object "+m+"]"]=m.toLowerCase()}return{get:function(a){return null==a?""+a:h[Object.prototype.toString.call(a)]||"object"},check:function(a,d){var g,h,m=this.get(d);if("string"===this.get(a)){g=a.replace(/^\?/,"").split(/\|/);for(h in g)0>f.indexOf(g[h])&&X("[domino.global] Invalid type");if(null==d)return!!a.match(/^\?/,"");a=a.replace(/^\?/,
"");h=a.split(/\|/);return!(!~h.indexOf("*")&&!~h.indexOf(m))}if("object"===this.get(a)){if("object"!==m)return!1;for(g in a)if(!this.check(a[g],d[g]))return!1;for(g in d)if(void 0===a[g])return!1;return!0}return!1},deepScalar:function(c){var d;if("string"===this.get(c)){c=c.replace(/^\?/,"").split(/\|/);for(d in c)if(0>a.indexOf(c[d]))return!1;return!0}if("object"===this.get(c)){for(d in c)if(!this.deepScalar(c[d]))return!1;return!0}return!1},compare:function(a,d,f){this.get(a);this.get(d);var g;
if(!this.deepScalar(f)||!this.check(f,a)||!this.check(f,d))return!1;if("string"===this.get(f))return a===d;if("object"===this.get(f)){for(g in f)if(!this.compare(a[g],d[g],f[g]))return!1;return!0}return!1},isValid:function(a){var d,g;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(g in a)if(0>f.indexOf(a[g]))return!1;return!0}if("object"===this.get(a)){for(d in a)if(!this.isValid(a[d]))return!1;return!0}return!1}}}();var I=o.utils,B=o.struct,u={strict:!1,verbose:!1,shortcutPrefix:":",
displayTime:!1,clone:!0};o.settings=function(a,d){if("string"===typeof a&&void 0===d)return u[a];var h="object"===typeof a&&void 0===d?a||{}:{};"string"===typeof a&&(h[a]=d);for(var f in h)void 0!==u[f]&&(u[f]=h[f]);return this};o.EventDispatcher=function(){var a={};this.removeEventListener=function(d,h){if(!arguments.length)return this._handlers_={},this;var f,g,m,c,i=I.array(d);if(h)for(f in i){c=i[f];if(a[c]){m=[];for(g in a[c])a[c][g].handler!==h&&m.push(a[c][g]);a[c]=m}a[c]&&0===a[c].length&&
delete a[c]}else for(f in i)delete a[i[f]];return this};this.addEventListener=function(d,h){if(arguments.length)if(1===arguments.length&&"object"===I.type.get(arguments[0]))for(d in arguments[0])this.addEventListener(d,arguments[0][d]);else if(1<arguments.length){var f,d=arguments[0],h=arguments[1],g=I.array(d),m;for(m in g)f=g[m],a[f]||(a[f]=[]),a[f].push({handler:h})}return this};this.dispatchEvent=function(d,h){var f,g,m,c,i,l=I.array(d),h=void 0===h?{}:h;for(f in l)if(i=l[f],a[i]){c=this.getEvent(i,
h);m=[];for(g in a[i])a[i][g].handler(c),a[i][g].one||m.push(a[i][g]);a[i]=m}return this};this.getEvent=function(a,h){return{type:a,data:h,target:this}}};var ca=o.EventDispatcher;o.module=function(){ca.call(this);this.triggers={properties:{},events:{}}}})(window);
