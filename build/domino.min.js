/* domino.js - a JS fast dashboard prototyping framwork - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(y){function D(){w.strict?E.apply(this,arguments):F.apply(this,arguments)}function E(){var a="",d;for(d in arguments)a+=arguments[d];throw Error(a);}function F(){w.verbose&&console.log.apply(console,arguments)}if(y.domino)throw Error("domino already exists");y.domino=function(a,d){function i(){return{get:n,events:D,label:y,dump:j.dump,expand:x}}function f(){return{get:n,set:z,events:D,label:y,dump:j.dump,warn:j.warn,die:j.die,update:h,expand:x,call:C,addModule:c}}function l(b,a){var e,g=
a||{};void 0===b&&j.die("Property name not specified");void 0!==G[b]&&j.die('Property "'+b+'" already exists');void 0!==M[b]&&j.die('"'+b+'" can not be used to name a property');E[b]=g.label||b;void 0!==g.type&&(m.isValid(g.type)?J[b]=g.type:j.warn('Property "'+b+'": Type not valid'));void 0!==g.setter&&("function"!==m.get(g.setter)?j.warn('Property "'+b+'": Setter is not a function'):(r[b]=g.setter,O[b]=!0));r[b]=r[b]||function(e){if(e===G[b])return!1;J[b]&&!m.check(J[b],e)?j.warn('Property "'+b+
'": Wrong type error'):G[b]=e;return!0};void 0!==g.getter&&("function"!==!m.get(g.getter)?j.warn('Property "'+b+'": Getter is not a function'):(v[b]=g.getter,F[b]=!0));v[b]=v[b]||function(){return G[b]};if(void 0!==g.value||J[b])void 0!==g.value?z(b,g.value):j.warn('Property "'+b+'": Initial value is missing');if(void 0!==g.triggers)for(e in!m.check("array|string",g.triggers)&&j.warn('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),A[b]=t.array(g.triggers),
A[b]||[])H[A[b][e]]=H[A[b][e]]||[],H[A[b][e]].push(b);void 0!==g.dispatch&&(!m.check("array|string",g.dispatch)?j.warn('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):s[b]=t.array(g.dispatch));return j}function k(b){var a=b||{};(void 0===a.id||"string"!==m.get(a.id))&&j.die("The service id is not indicated.");m.check("function|string",a.url)||j.die("The service URL is not valid.");void 0!==K[a.id]&&j.die('The service "'+a.id+'" already exists.');
K[a.id]=function(b){for(var g=b||{},b={contentType:g.contentType||a.contentType,dataType:g.dataType||a.dataType,type:(g.type||a.type||"GET").toString().toUpperCase(),data:"function"===m.get(a.data)?a.data.apply(i(),g.data||[]):g.data||a.data,url:"function"===m.get(a.url)?a.url.call(i()):a.url,error:function(b,e){j.dispatchEvent("domino.ajaxFailed");var c=g.error||a.error;"function"===m.get(c)?c.call(f(),b,e):j.die('Loading failed with message "'+b+'".')}},c,d,k,h=w.shortcutPrefix,l=RegExp(h+"(\\w+)",
"g"),h=RegExp("^"+h+"(\\w+)$"),n=null,o;(o=b.url.match(l))&&b.url!==n;)for(c in n=b.url,o)d=x(o[c],g.params),b.url=b.url.replace(RegExp(o[c],"g"),d);c=!0;"string"===m.get(b.data)&&b.data.match(h)&&(b.data=x(b.data,g.params));if("object"===m.get(b.data))for(;c;)for(k in c=!1,b.data)"string"===m.get(b.data[k])&&b.data[k].match(h)&&(b.data[k]=x(b.data[k],g.params),c=!0);b.success=function(b){var e,c,d,h,l={},u=g.path||a.path,n=g.setter||a.setter,o=g.success||a.success;"string"===m.get(n)&&(n=x(n,g.params));
"string"===m.get(u)&&(u=x(u,g.params));h=b;u.match(/^(?:\w+\.)*\w+$/)?c=m.get(u,"string")?u.split("."):void 0:"string"===m.get(u)&&j.warn('Path "'+u+'" does not match regExp /^(?:\\w+\\.)*\\w+$/');if(c)for(e in c)h=h[c[e]],void 0===h&&j.warn('Wrong path "'+u+'" for service "'+a.id+'".');c=t.array(a.events);for(e in c)l[c[e]]=1;c=t.array(g.events);for(e in c)l[c[e]]=1;if(n&&r[n]&&z(n,h))for(k in s[n]||[])l[s[n][k]]=1;"function"===m.get(o)&&o.call(f(),b,g);c=[];for(d in l)j.dispatchEvent(d,i()),c.push(j.getEvent(d,
i()));c.length&&p(c)};g.abort&&N[a.id]&&N[a.id].abort();N[a.id]=t.ajax(b)};return j}function c(b,a){var e,g={},c={},k,d,f;void 0===b&&j.die("Module class not specified.");"function"!==m.get(b)&&j.die("First parameter must be a function.");b.apply(g,(a||[]).concat(i()));k=g.triggers||{};for(f in k.events||{})j.addEventListener(f,k.events[f]);for(d in k.properties||{}){for(e in s[d]||[])j.addEventListener(s[d][e],k.properties[d]);void 0!==v[d]&&(n(d),k.properties[d](j.getEvent("domino.initialUpdate",
i())))}for(f in H||{})c[f]=1;for(f in B||{})c[f]=1;for(f in I||{})c[f]=1;for(f in c)g.addEventListener(f,p);Q.push(g);return g}function p(b,a){var e,c,d,k,h,l,n,m=[],o=a||{},q={};o.loop=(o.loop||0)+1;var r=t.array(b);for(c in r){h=r[c];l=h.data||{};m.push(h.type);if(l||o.force)for(d in e=H[h.type]||[],e)if(n=!!o.force,void 0!==l[e[d]]&&(n=z(e[d],l[e[d]])||n),n)for(k in s[e[d]]||[])q[s[e[d]][k]]=1;for(d in B[h.type]||[])for(k in e=f(),B[h.type][d].call(e,h),e=t.array(e.dispatch),e)q[e[k]]=1;for(d in I[h.type]||
[])q[I[h.type][d]]=1}j.dump("Main loop "+o.loop+":",m);e=[];for(h in q)j.dispatchEvent(h,i()),e.push(j.getEvent(h,i()));e.length&&p(e,o)}function h(b){var a,e,c,d=[],k={};null==b&&j.warn("Nothing to update.");if("array"===m.get(b))for(e in b)if(d.push(e),void 0===r[b[e].property])j.warn("The property is not specified.");else{if(z(b[e].property,b[e].value))for(a in s[b[e].property]||[])k[s[e][a]]=1}else if("object"===m.get(b))for(e in b)if(d.push(e),r[e]&&z(e,b[e]))for(a in s[e]||[])k[s[e][a]]=1;j.dump("Updating properties :",
d);a=[];for(c in k)j.dispatchEvent(c,i()),a.push(j.getEvent(c,i()));a.length&&p(a,b)}function n(b){if(v[b]){if(F[b]){for(var a=[],e=1,c=arguments.length;e<c;e++)a.push(arguments[e]);return v[b].apply(i(),a)}return v[b].call(i())}j.warn('Property "'+b+'" not referenced.')}function z(b,a){if(r[b]){if(O[b]){var e=f();e[b]=n(b);for(var c=[],d=1,k=arguments.length;d<k;d++)c.push(arguments[d]);(c=r[b].apply(e,c))&&(G[b]=e[b]);return c}return r[b].call(f(),a)}j.warn('Property "'+b+'" not referenced.');return!1}
function C(b,a){if(K[b])return K[b](a);j.warn('Service "'+b+'" not referenced.');return!1}function y(b){return E[b]}function D(b){return A[b]}function x(b){var a=arguments.length,c=(b||"").toString().match(RegExp("^"+w.shortcutPrefix+"(\\w+)$"));if(!c||!c.length)return b;c=c[1];if("function"===m.get(L[c]))return L[c].call(f());if("function"===m.get(v[c]))return n(c);for(var d=1;d<a;d++)if(void 0!==(arguments[d]||{})[c])return arguments[d][c];return b}P.call(this);var j=this,t=q.utils,m=t.type,J={},
E={},A={},v={},r={},G={},F={},O={},Q=[],H={},s={},B={},I={},K={},N={},L={},M={dispatch:1};(function(){for(var a in i())M[a]=1;for(a in f())M[a]=1})();var o={};this.name="domino";"string"===m.get(a)?this.name=a:void 0!==a&&"object"===m.get(a)?o=a:void 0!==d&&"object"===m.get(d)&&(o=d);this.name=o.name||this.name;(function(){for(var a in o.properties||[])l(o.properties[a].id,o.properties[a]);for(a in o.hacks||[]){var c=void 0,d=void 0,g=o.hacks[a]||{};void 0===g.triggers&&j.die("A hack requires at least one trigger to be added");
c=t.array(g.triggers);for(d in c)g.method&&(B[c[d]]=B[c[d]]||[],B[c[d]].push(g.method)),g.dispatch&&(I[c[d]]=(I[c[d]]||[]).concat(t.array(g.dispatch)))}for(a in o.services||[])k(o.services[a]);for(a in o.shortcuts||[])c=o.shortcuts[a].id,d=o.shortcuts[a].method,void 0===c&&j.die("Shortcut ID not specified."),L[c]&&j.die('Shortcut "'+c+'" already exists.'),void 0===d&&j.die("Shortcut method not specified."),L[c]=d})();return f()};var q=y.domino;q.prototype.warn=function(a){var d=["["+this.name+"] "],
i;for(i in arguments)d.push(arguments[i]);D.apply(this,d)};q.prototype.die=function(a){var d=["["+this.name+"] "],i;for(i in arguments)d.push(arguments[i]);E.apply(this,d)};q.prototype.dump=function(){var a=["["+this.name+"] "],d;for(d in arguments)a.push(arguments[d]);F.apply(this,a)};q.utils={array:function(a,d){var i="string"===q.utils.type.get(a)?a.split(d||" "):"array"===q.utils.type.get(a)?a:[a],f=[],l;for(l in i)i[l]&&f.push(i[l]);return f},ajax:function(a,d){"string"===typeof a&&(a={url:a,
ok:d});var i=a.type||"GET",f=a.url||"",l=a.contentType||"application/x-www-form-urlencoded",k=a.dataType||"json",c=new XMLHttpRequest,p,h,n;if(a.data){if("string"===typeof a.data)h=a.data;else if(/json/.test(l))h=JSON.stringify(a.data);else{h=[];for(n in a.data)h.push(encodeURIComponent(n)+"="+encodeURIComponent(a.data[n]));h=h.join("&")}/GET|DEL/i.test(i)&&(f+=/\?/.test(f)?"&"+h:"?"+h,h="")}c.onreadystatechange=function(){if(4==c.readyState)if(p&&clearTimeout(p),/^2/.test(c.status)){h=c.responseText;
if(/json/.test(k))try{h=JSON.parse(c.responseText)}catch(d){return a.error&&a.error("JSON parse error: "+d.message,c)}a.success&&a.success(h,c)}else a.error&&a.error(c.responseText,c)};c.open(i,f,!0);c.setRequestHeader("Content-Type",l);if(a.headers)for(n in a.headers)c.setRequestHeader(n,a.headers[n]);a.timeout&&(p=setTimeout(function(){c.onreadystatechange=function(){};c.abort();a.error&&a.error&&a.error("timeout",c)},1E3*a.timeout));c.send(h);return c},type:function(){var a="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),
d={},i=["*"],f;for(f in a){var l=a[f];i.push(l.toLowerCase());d["[object "+l+"]"]=l.toLowerCase()}return{get:function(a){return null==a?""+a:d[Object.prototype.toString.call(a)]||"object"},check:function(a,c){var d,h,f=this.get(c);if("string"===this.get(a)){d=a.replace(/^\?/,"").split(/\|/);for(h in d)0>i.indexOf(d[h])&&D("[domino.global] Invalid type");if(null==c)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");h=a.split(/\|/);return!(!~h.indexOf("*")&&!~h.indexOf(f))}if("object"===this.get(a)){if("object"!==
f)return!1;for(d in a)if(!this.check(a[d],c[d]))return!1;for(d in c)if(void 0===a[d])return!1;return!0}return!1},isValid:function(a){var c,d;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(d in a)if(0>i.indexOf(a[d]))return!1;return!0}if("object"===this.get(a)){for(c in a)if(!this.isValid(a[c]))return!1;return!0}return!1}}}()};var C=q.utils,w={strict:!1,verbose:!1,shortcutPrefix:":"};q.settings=function(a,d){if("string"===typeof a&&void 0===d)return w[a];var i="object"===typeof a&&
void 0===d?a||{}:{};"string"===typeof a&&(i[a]=d);for(var f in i)void 0!==w[f]&&(w[f]=i[f]);return this};q.EventDispatcher=function(){var a={};this.removeEventListener=function(d,i){if(!arguments.length)return this._handlers_={},this;var f,l,k,c,p=C.array(d);if(i)for(f in p){c=p[f];if(a[c]){k=[];for(l in a[c])a[c][l].handler!==i&&k.push(a[c][l]);a[c]=k}a[c]&&0===a[c].length&&delete a[c]}else for(f in p)delete a[p[f]];return this};this.addEventListener=function(d,i){if(arguments.length)if(1===arguments.length&&
"object"===C.type.get(arguments[0]))for(d in arguments[0])this.addEventListener(d,arguments[0][d]);else if(1<arguments.length){var f,d=arguments[0],i=arguments[1],l=C.array(d),k;for(k in l)f=l[k],a[f]||(a[f]=[]),a[f].push({handler:i})}return this};this.dispatchEvent=function(d,i){var f,l,k,c,p,h=C.array(d),i=void 0===i?{}:i;for(f in h)if(p=h[f],a[p]){c=this.getEvent(p,i);k=[];for(l in a[p])a[p][l].handler(c),a[p][l].one||k.push(a[p][l]);a[p]=k}return this};this.getEvent=function(a,i){return{type:a,
data:i,target:this}}};var P=q.EventDispatcher;q.module=function(){P.call(this);this.triggers={properties:{},events:{}}}})(window);
