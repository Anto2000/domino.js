/* domino.js - a JS fast dashboard prototyping framwork - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(B){function F(){x.strict?L.apply(this,arguments):M.apply(this,arguments)}function L(){var a="",e;for(e in arguments)a+=arguments[e];throw Error(a);}function M(){x.verbose&&console.log.apply(console,arguments)}if(B.domino)throw Error("domino already exists");B.domino=function(a,e){function f(g,a){var i,q=a||{};void 0===g&&k.die("Property name not specified");void 0!==G[g]&&k.die('Property "'+g+'" already exists');void 0!==K[g]&&k.die('"'+g+'" can not be used to name a property');B[g]=q.label||
g;void 0!==q.type&&(!l.isValid(q.type)?k.warn('Property "'+g+'": Type not valid'):t[g]=q.type);void 0!==q.setter&&("function"!==!l.get(q.setter)?k.warn('Property "'+g+'": Setter is not a function'):y[g]=q.setter);y[g]=y[g]||function(a){if(a===G[g])return!1;t[g]&&!l.check(t[g],a)?k.warn('Property "'+g+'": Wrong type error'):G[g]=a;return!0};void 0!==q.getter&&("function"!==!l.get(q.getter)?k.warn('Property "'+g+'": Getter is not a function'):z[g]=q.getter);z[g]=z[g]||function(){return G[g]};if(void 0!==
q.value||t[g])void 0!==q.value?j(g,q.value):k.warn('Property "'+g+'": Initial value is missing');if(void 0!==q.triggers)for(i in!l.check("array|string",q.triggers)&&k.warn('Property "'+g+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),C[g]=u.array(q.triggers),C[g]||[])E[C[g][i]]=E[C[g][i]]||[],E[C[g][i]].push(g);void 0!==q.dispatch&&(!l.check("array|string",q.dispatch)?k.warn('Property "'+g+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):
v[g]=u.array(q.dispatch));return k}function h(a){var o=a||{};(void 0===o.id||"string"!==l.get(o.id))&&k.die("The service id is not indicated.");l.check("function|string",o.url)||k.die("The service URL is not valid.");void 0!==H[o.id]&&k.die('The service "'+o.id+'" already exists.');H[o.id]=function(a){for(var g=a||{},a={contentType:g.contentType||o.contentType,dataType:g.dataType||o.dataType,type:(g.type||o.type||"GET").toString().toUpperCase(),data:"function"===l.get(o.data)?o.data.apply(s,g.data||
[]):g.data||o.data,url:"function"===l.get(o.url)?o.url.call(s):o.url,error:function(a,d){k.dispatchEvent("domino.ajaxFailed");var i=g.error||o.error;"function"===l.get(i)?i.call(A,a,d):k.die('Loading failed with message "'+a+'".')}},d,e,f,b=x.shortcutPrefix,h=RegExp(b+"(\\w+)","g"),b=RegExp("^"+b+"(\\w+)$"),c=null,n;(n=a.url.match(h))&&a.url!==c;)for(d in c=a.url,n)e=p(n[d],g.params),a.url=a.url.replace(RegExp(n[d],"g"),e);d=!0;"string"===l.get(a.data)&&a.data.match(b)&&(a.data=p(a.data,g.params));
if("object"===l.get(a.data))for(;d;)for(f in d=!1,a.data)"string"===l.get(a.data[f])&&a.data[f].match(b)&&(a.data[f]=p(a.data[f],g.params),d=!0);a.success=function(a){var i,d,e,b,h={},c=g.path||o.path,w=g.setter||o.setter,n=g.success||o.success;"string"===l.get(w)&&(w=p(w,g.params));"string"===l.get(c)&&(c=p(c,g.params));b=a;c.match(/^(?:\w+\.)*\w+$/)?d=l.get(c,"string")?c.split("."):void 0:"string"===l.get(c)&&k.warn('Path "'+c+'" does not match regExp /^(?:\\w+\\.)*\\w+$/');if(d)for(i in d)b=b[d[i]],
void 0===b&&k.warn('Wrong path "'+c+'" for service "'+o.id+'".');d=u.array(o.events);for(i in d)h[d[i]]=1;d=u.array(g.events);for(i in d)h[d[i]]=1;if(w&&y[w]&&j(w,b))for(f in v[w]||[])h[v[w][f]]=1;"function"===l.get(n)&&n.call(A,a,g);d=[];for(e in h)k.dispatchEvent(e,s),d.push(k.getEvent(e,s));d.length&&m(d)};u.ajax(a)};return k}function m(a,d){var i,e,b,f,c,h,l,n=[],p=d||{},r={};p.loop=(p.loop||0)+1;var t=u.array(a);for(e in t){c=t[e];h=c.data||{};n.push(c.type);if(h||p.force)for(b in i=E[c.type]||
[],i)if(l=!!p.force,void 0!==h[i[b]]&&(l=j(i[b],h[i[b]])||l),l)for(f in v[i[b]]||[])r[v[i[b]][f]]=1;for(b in D[c.type]||[])D[c.type][b].call(A,c);for(b in I[c.type]||[])r[I[c.type][b]]=1}k.dump("Main loop "+p.loop+":",n);i=[];for(c in r)k.dispatchEvent(c,s),i.push(k.getEvent(c,s));i.length&&m(i,p)}function d(a){if(z[a])return z[a].call(s);k.warn('Property "'+a+'" not referenced.')}function j(a,d){if(y[a])return y[a].call(A,d);k.warn('Property "'+a+'" not referenced.');return!1}function b(a){return B[a]}
function c(a){return C[a]}function p(a){var b=arguments.length,i=(a||"").toString().match(RegExp("^"+x.shortcutPrefix+"(\\w+)$"));if(!i||!i.length)return a;i=i[1];if("function"===l.get(J[i]))return J[i].call(A);if("function"===l.get(z[i]))return d(i);for(var c=1;c<b;c++)if(void 0!==(arguments[c]||{})[i])return arguments[c][i];return a}N.call(this);var k=this,u=r.utils,l=u.type,t={},B={},C={},z={},y={},G={},F=[],E={},v={},D={},I={},H={},J={},s={get:d,events:c,label:b,dump:k.dump,expand:p},A={get:d,
set:j,events:c,label:b,dump:k.dump,warn:k.warn,die:k.die,update:function(a){var d,i,b,c=[],a=a||{},e={};for(i in a)if(c.push(i),y[i]&&j(i,a[i]))for(d in v[i]||[])e[v[i][d]]=1;k.dump("Updating properties :",c);d=[];for(b in e)k.dispatchEvent(b,s),d.push(k.getEvent(b,s));d.length&&m(d,a)},expand:p,call:function(a,d){if(H[a])return H[a](d);k.warn('Service "'+a+'" not referenced.');return!1},addModule:function(a,b){var c,e={},f,j,h;void 0===a&&k.die("Module class not specified.");"function"!==l.get(a)&&
k.die("First parameter must be a function.");a.apply(e,(b||[]).concat(s));f=e.triggers||{};for(h in f.events||{})k.addEventListener(h,f.events[h]);for(j in f.properties||{}){for(c in v[j]||[])k.addEventListener(v[j][c],f.properties[j]);void 0!==z[j]&&(d(j),f.properties[j](k.getEvent("domino.initialUpdate",s)))}for(h in E||{})e.addEventListener(h,m);for(h in D||{})e.addEventListener(h,m);F.push(e);return e}},K={};(function(){for(var a in s)K[a]=1;for(a in A)K[a]=1})();var n={};this.name="domino";"string"===
l.get(a)?this.name=a:void 0!==a&&"object"===l.get(a)?n=a:void 0!==e&&"object"===l.get(e)&&(n=e);this.name=n.name||this.name;(function(){for(var a in n.properties||[])f(n.properties[a].id,n.properties[a]);for(a in n.hacks||[]){var d=void 0,b=void 0,c=n.hacks[a]||{};void 0===c.triggers&&k.die("A hack requires at least one trigger to be added");d=u.array(c.triggers);for(b in d)c.method&&(D[d[b]]=D[d[b]]||[],D[d[b]].push(c.method)),c.dispatch&&(I[d[b]]=(I[d[b]]||[]).concat(u.array(c.dispatch)))}for(a in n.services||
[])h(n.services[a]);for(a in n.shortcuts||[])d=n.shortcuts[a].id,b=n.shortcuts[a].method,void 0===d&&k.die("Shortcut ID not specified."),J[d]&&k.die('Shortcut "'+d+'" already exists.'),void 0===b&&k.die("Shortcut method not specified."),J[d]=b})();return A};var r=B.domino;r.prototype.warn=function(a){var e=["["+this.name+"]"],f;for(f in arguments)e.push(arguments[f]);F.apply(this,e)};r.prototype.die=function(a){var e=["["+this.name+"]"],f;for(f in arguments)e.push(arguments[f]);L.apply(this,e)};r.prototype.dump=
function(){var a=["["+this.name+"]"],e;for(e in arguments)a.push(arguments[e]);M.apply(this,a)};r.utils={array:function(a,e){var f="string"===r.utils.type.get(a)?a.split(e||" "):"array"===r.utils.type.get(a)?a:[a],h=[],m;for(m in f)f[m]&&h.push(f[m]);return h},ajax:function(a,e){"string"===typeof a&&(a={url:a,ok:e});var f=a.type||"GET",h=a.url||"",m=a.contentType||"application/x-www-form-urlencoded",d=a.dataType||"json",j=new XMLHttpRequest,b,c,p;if(a.data){if("string"===typeof a.data)c=a.data;else if(/json/.test(m))c=
JSON.stringify(a.data);else{c=[];for(p in a.data)c.push(encodeURIComponent(p)+"="+encodeURIComponent(a.data[p]));c=c.join("&")}/GET|DEL/i.test(f)&&(h+=/\?/.test(h)?"&"+c:"?"+c,c="")}j.onreadystatechange=function(){if(4==j.readyState)if(b&&clearTimeout(b),/^2/.test(j.status)){c=j.responseText;if(/json/.test(d))try{c=JSON.parse(j.responseText)}catch(e){return a.error&&a.error("JSON parse error: "+e.message,j)}a.success&&a.success(c,j)}else a.error&&a.error(j.responseText,j)};j.open(f,h,!0);j.setRequestHeader("Content-Type",
m);if(a.headers)for(p in a.headers)j.setRequestHeader(p,a.headers[p]);a.timeout&&(b=setTimeout(function(){j.onreadystatechange=function(){};j.abort();a.error&&a.error&&a.error("timeout",j)},1E3*a.timeout));j.send(c);return j},type:function(){var a="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),e={},f=["*"],h;for(h in a){var m=a[h];f.push(m.toLowerCase());e["[object "+m+"]"]=m.toLowerCase()}return{get:function(a){return null==a?""+a:e[Object.prototype.toString.call(a)]||"object"},
check:function(a,e){var b,c,h=this.get(e);if("string"===this.get(a)){b=a.replace(/^\?/,"").split(/\|/);for(c in b)0>f.indexOf(b[c])&&F("[domino.global] Invalid type");if(null==e)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");c=a.split(/\|/);return!(!~c.indexOf("*")&&!~c.indexOf(h))}if("object"===this.get(a)){if("object"!==h)return!1;for(b in a)if(!this.check(a[b],e[b]))return!1;for(b in e)if(void 0===a[b])return!1;return!0}return!1},isValid:function(a){var e,b;if("string"===this.get(a)){a=a.replace(/^\?/,
"").split(/\|/);for(b in a)if(0>f.indexOf(a[b]))return!1;return!0}if("object"===this.get(a)){for(e in a)if(!this.isValid(a[e]))return!1;return!0}return!1}}}()};var t=r.utils,x={strict:!1,verbose:!1,shortcutPrefix:":"};r.settings=function(a,e){if("string"===typeof a&&void 0===e)return x[a];var f="object"===typeof a&&void 0===e?a||{}:{};"string"===typeof a&&(f[a]=e);for(var h in f)void 0!==x[h]&&(x[h]=f[h]);return this};r.EventDispatcher=function(){var a={};this.removeEventListener=function(e,f){if(!arguments.length)return this._handlers_=
{},this;var h,m,d,j,b=t.array(e);if(f)for(h in b){j=b[h];if(a[j]){d=[];for(m in a[j])a[j][m].handler!==f&&d.push(a[j][m]);a[j]=d}a[j]&&0===a[j].length&&delete a[j]}else for(h in b)delete a[b[h]];return this};this.addEventListener=function(e,f){if(arguments.length)if(1===arguments.length&&"object"===t.type.get(arguments[0]))for(e in arguments[0])this.addEventListener(e,arguments[0][e]);else if(1<arguments.length){var h,e=arguments[0],f=arguments[1],m=t.array(e),d;for(d in m)h=m[d],a[h]||(a[h]=[]),
a[h].push({handler:f})}return this};this.dispatchEvent=function(e,f){var h,m,d,j,b,c=t.array(e),f=void 0===f?{}:f;for(h in c)if(b=c[h],a[b]){j=this.getEvent(b,f);d=[];for(m in a[b])a[b][m].handler(j),a[b][m].one||d.push(a[b][m]);a[b]=d}return this};this.getEvent=function(a,f){return{type:a,data:f,target:this}}};var N=r.EventDispatcher;r.module=function(){N.call(this);this.triggers={properties:{},events:{}}}})(window);
