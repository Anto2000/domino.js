/* domino.js - a JS fast dashboard prototyping framwork - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(I){function T(){C.strict?U.apply(this,arguments):V.apply(this,arguments)}function U(){var a="",j;for(j in arguments)a+=arguments[j];throw Error(a);}function V(){C.verbose&&console.log.apply(console,arguments)}if(I.domino)throw Error("domino already exists");I.domino=function(a,j){function i(b){var b=b||{},n={get:k,getEvents:$,getLabel:I,dump:R,warn:p,die:o,expand:D};if(b.write||b.full)n.set=s,n.call=H;b.full&&(n.addModule=g,n.update=e);return n}function f(b,n){var c,d=n||{};void 0===b&&
o("Property name not specified");void 0!==E[b]&&o('Property "'+b+'" already exists');void 0!==M[b]&&o('"'+b+'" can not be used to name a property');W[b]=d.label||b;void 0!==d.type&&(m.isValid(d.type)?N[b]=d.type:p('Property "'+b+'": Type not valid'));void 0!==d.setter&&("function"!==m.get(d.setter)?p('Property "'+b+'": Setter is not a function'):(v[b]=d.setter,X[b]=!0));v[b]=v[b]||function(c){if(c===E[b])return!1;N[b]&&!m.check(N[b],c)?p('Property "'+b+'": Wrong type error'):E[b]=c;return!0};void 0!==
d.getter&&("function"!==m.get(d.getter)?p('Property "'+b+'": Getter is not a function'):(w[b]=d.getter,Y[b]=!0));w[b]=w[b]||function(){return E[b]};if(void 0!==d.value||N[b])void 0!==d.value?s(b,d.value):p('Property "'+b+'": Initial value is missing');if(void 0!==d.triggers)for(c in!m.check("array|string",d.triggers)&&p('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),F[b]=x.array(d.triggers),F[b]||[])J[F[b][c]]=J[F[b][c]]||[],J[F[b][c]].push(b);
void 0!==d.dispatch&&(!m.check("array|string",d.dispatch)?p('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):u[b]=x.array(d.dispatch));return q}function h(b){var n=b||{};(void 0===n.id||"string"!==m.get(n.id))&&o("The service id is not indicated.");m.check("function|string",n.url)||o("The service URL is not valid.");void 0!==O[n.id]&&o('The service "'+n.id+'" already exists.');O[n.id]=function(b){for(var d=b||{},b={contentType:d.contentType||
n.contentType,dataType:d.dataType||n.dataType,type:(d.type||n.type||"GET").toString().toUpperCase(),data:"function"===m.get(n.data)?n.data.call(i(),d.data):d.data||n.data,url:"function"===m.get(n.url)?n.url.call(i()):n.url,error:function(b,c){q.dispatchEvent("domino.ajaxFailed");var a=d.error||n.error;"function"===m.get(a)?a.call(i({write:!0}),b,c):o('Loading failed with message "'+b+'".')}},a,g,A,e=C.shortcutPrefix,j=RegExp(e+"(\\w+)","g"),e=RegExp("^"+e+"(\\w+)$"),f=null,k;(k=b.url.match(j))&&b.url!==
f;)for(a in f=b.url,k)g=D(k[a],d.params),b.url=b.url.replace(RegExp(k[a],"g"),g);a=!0;"string"===m.get(b.data)&&b.data.match(e)&&(b.data=D(b.data,d.params));if("object"===m.get(b.data))for(;a;)for(A in a=!1,b.data)"string"===m.get(b.data[A])&&b.data[A].match(e)&&(b.data[A]=D(b.data[A],d.params),a=!0);b.success=function(b){var c,a,g,e,P={},z=d.path||n.path,f=d.setter||n.setter,j=d.success||n.success;"string"===m.get(f)&&(f=D(f,d.params));"string"===m.get(z)&&(z=D(z,d.params));e=b;(z||"").match(/^(?:\w+\.)*\w+$/)?
a=m.get(z,"string")?z.split("."):void 0:"string"===m.get(z)&&p('Path "'+z+'" does not match regExp /^(?:\\w+\\.)*\\w+$/');if(a)for(c in a)e=e[a[c]],void 0===e&&p('Wrong path "'+z+'" for service "'+n.id+'".');a=x.array(n.events);for(c in a)P[a[c]]=1;a=x.array(d.events);for(c in a)P[a[c]]=1;if(f&&v[f]&&s(f,e)){for(A in u[f]||[])P[u[f][A]]=1;for(A in y[f])B(y[f][A],{parameters:[q.getEvent(f,i())]})}"function"===m.get(j)&&j.call(i({write:!0}),b,d);a=[];for(g in P)q.dispatchEvent(g,i()),a.push(q.getEvent(g,
i()));a.length&&l(a)};d.abort&&S[n.id]&&S[n.id].abort();S[n.id]=x.ajax(b)};return q}function g(b,a){var c,d={},g={},f,e,j,h;void 0===b&&o("Module class not specified.");"function"!==m.get(b)&&o("First parameter must be a function.");b.apply(d,(a||[]).concat(i({write:!0})));f=d.triggers||{};for(j in f.events||{})for(h in x.array(j))K[h]=K[h]||[],K[h].push(f.events[h]);for(e in f.properties||{}){for(c in u[e]||[])y[e]=y[e]||[],y[e].push(f.properties[e]);void 0!==w[e]&&(k(e),f.properties[e](q.getEvent("domino.initialUpdate",
i())))}for(h in J||{})g[h]=1;for(h in G||{})g[h]=1;for(h in L||{})g[h]=1;for(h in g)d.addEventListener(h,l);aa.push(d);return d}function l(b,a){var c,d,e,f,g,h,j,k,m=[],o=a||{},r={},t={};o.loop=(o.loop||0)+1;var w=x.array(b);for(d in w){g=w[d];h=g.data||{};m.push(g.type);if(h||o.force)for(e in c=J[g.type]||[],c)if(j=!!o.force,void 0!==h[c[e]]&&(j=s(c[e],h[c[e]])||j),j){for(f in y[c[e]])B(y[c[e]][f],{parameters:[q.getEvent(c[e],i())]});for(f in u[c[e]]||[])r[u[c[e]][f]]=1}for(f in K[g.type])B(K[g.type][f],
{parameters:[g]});for(e in G[g.type]||[]){h=B(G[g.type][e],{parameters:[g]});c=x.array(h.events);for(f in c)r[c[f]]=1;for(f in h.properties)void 0===t[f]?t[f]=h.properties[f]:p('The property "'+f+'" is not a method nor a property.')}for(e in L[g.type]||[])r[L[g.type][e]]=1}for(k in t)if(void 0===v[k])p("The property is not referenced.");else if(s.apply(self,[k,t[k]])){for(d in y[k])B(y[k][d],{parameters:[q.getEvent(k,i())]});for(d in u[k]||[])r[u[k][d]]=1}R("Iteration "+o.loop+" (main loop) :",m);
c=[];for(g in r)q.dispatchEvent(g,i()),c.push(q.getEvent(g,i()));c.length&&l(c,o)}function e(b){var a,c,d,e=[],g={};null==b&&p("Nothing to update.");if("array"===m.get(b))for(c in b)if(e.push(b[c].property),void 0===v[b[c].property])p("The property is not referenced.");else{if(s.apply([b[c].property,b[c].value].concat(b[c].parameters||[]))){for(a in y[b[c].property])B(y[b[c].property][a],{parameters:[q.getEvent(b[c].property,i())]});for(a in u[b[c].property]||[])g[u[b[c].property][a]]=1}}else if("object"===
m.get(b))for(c in b){if(e.push(c),v[c]&&s(c,b[c]))for(a in u[c]||[])g[u[c][a]]=1}else p("The properties must be stored in an array or an object.");R("Updating properties :",e);a=[];for(d in g)q.dispatchEvent(d,i()),a.push(q.getEvent(d,i()));a.length&&l(a,b);return this}function k(b){if(w[b]){if(Y[b]){for(var a=[],c={},d=1,e=arguments.length;d<e;d++)a.push(arguments[d]);c[b]=E[b];return B(w[b],{parameters:a,inputValues:c}).returned}return w[b]()}p('Property "'+b+'" not referenced.')}function s(b,a){if(v[b]){if(X[b]){var c,
d;c=[];d={};d[b]=a;for(var e=1,g=arguments.length;e<g;e++)c.push(arguments[e]);d=B(v[b],{parameters:c,inputValues:d});(c="boolean"!==m.get(d.returned)||d.returned)&&(E[b]=d.values[b]);return c}return v[b].call(i({write:!0}),a)}p('Property "'+b+'" not referenced.');return!1}function H(b,a){if(O[b])O[b](a);else p('Service "'+b+'" not referenced.');return this}function B(b,a){var c,d,e=a||{},g=i(e.scope);"function"!==m.get(b)&&o("The first parameter must be a function");for(c in e.inputValues||{})g[c]=
e.inputValues[c];d={returned:b.apply(g,e.parameters||[]),properties:{},events:{}};null!=g.events&&!m.check("array",g.events)?p("Events must be stored in an array."):d.events=g.events;for(c in g)void 0!==v[c]?d.properties[c]=g[c]:void 0===M[c]&&p('The key "'+c+'" is not a method nor a property.');for(c in e.inputValues)d.properties[c]=g[c];return d}function I(b){return W[b]}function $(b){return F[b]}function p(b){var a=["["+q.name+"] WARNING - "],c;for(c in arguments)a.push(arguments[c]);T.apply(q,
a)}function o(b){var a=["["+q.name+"] "],c;for(c in arguments)a.push(arguments[c]);U.apply(q,a)}function R(){var b=["["+q.name+"] "],a;for(a in arguments)b.push(arguments[a]);V.apply(q,b)}function D(b){var a=arguments.length,c=(b||"").toString().match(RegExp("^"+C.shortcutPrefix+"(\\w+)$"));if(!c||!c.length)return b;c=c[1];if("function"===m.get(Q[c]))return Q[c].call(i({write:!0}));if("function"===m.get(w[c]))return k(c);for(var d=1;d<a;d++)if(void 0!==(arguments[d]||{})[c])return arguments[d][c];
return b}Z.call(this);var q=this,x=t.utils,m=x.type,N={},W={},F={},w={},v={},E={},Y={},X={},aa=[],J={},u={},K={},y={},G={},L={},O={},S={},Q={},M={dispatch:1};(function(){for(var b in Object.prototype)M[b]=1;for(b in i({full:1}))M[b]=1})();var r={};this.name="domino";"string"===m.get(a)?this.name=a:void 0!==a&&"object"===m.get(a)?r=a:void 0!==j&&"object"===m.get(j)&&(r=j);this.name=r.name||this.name;(function(){for(var b in r.properties||[])f(r.properties[b].id,r.properties[b]);for(b in r.hacks||[]){var a=
void 0,c=void 0,d=r.hacks[b]||{};void 0===d.triggers&&o("A hack requires at least one trigger to be added");a=x.array(d.triggers);for(c in a)d.method&&(G[a[c]]=G[a[c]]||[],G[a[c]].push(d.method)),d.dispatch&&(L[a[c]]=(L[a[c]]||[]).concat(x.array(d.dispatch)))}for(b in r.services||[])h(r.services[b]);for(b in r.shortcuts||[])a=r.shortcuts[b].id,c=r.shortcuts[b].method,void 0===a&&o("Shortcut ID not specified."),Q[a]&&o('Shortcut "'+a+'" already exists.'),void 0===c&&o("Shortcut method not specified."),
Q[a]=c})();return i({full:!0})};var t=I.domino;t.utils={array:function(a,j){var i="string"===t.utils.type.get(a)?a.split(j||" "):"array"===t.utils.type.get(a)?a:[a],f=[],h;for(h in i)i[h]&&f.push(i[h]);return f},ajax:function(a,j){"string"===typeof a&&(a={url:a,ok:j});var i=a.type||"GET",f=a.url||"",h=a.contentType||"application/x-www-form-urlencoded",g=a.dataType||"json",l=new XMLHttpRequest,e,k,s;if(a.data){if("string"===typeof a.data)k=a.data;else if(/json/.test(h))k=JSON.stringify(a.data);else{k=
[];for(s in a.data)k.push(encodeURIComponent(s)+"="+encodeURIComponent(a.data[s]));k=k.join("&")}/GET|DEL/i.test(i)&&(f+=/\?/.test(f)?"&"+k:"?"+k,k="")}l.onreadystatechange=function(){if(4==l.readyState)if(e&&clearTimeout(e),/^2/.test(l.status)){k=l.responseText;if(/json/.test(g))try{k=JSON.parse(l.responseText)}catch(f){return a.error&&a.error("JSON parse error: "+f.message,l)}a.success&&a.success(k,l)}else a.error&&a.error(l.responseText,l)};l.open(i,f,!0);l.setRequestHeader("Content-Type",h);if(a.headers)for(s in a.headers)l.setRequestHeader(s,
a.headers[s]);a.timeout&&(e=setTimeout(function(){l.onreadystatechange=function(){};l.abort();a.error&&a.error&&a.error("timeout",l)},1E3*a.timeout));l.send(k);return l},type:function(){var a="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),j={},i=["*"],f;for(f in a){var h=a[f];i.push(h.toLowerCase());j["[object "+h+"]"]=h.toLowerCase()}return{get:function(a){return null==a?""+a:j[Object.prototype.toString.call(a)]||"object"},check:function(a,f){var e,h,j=this.get(f);if("string"===
this.get(a)){e=a.replace(/^\?/,"").split(/\|/);for(h in e)0>i.indexOf(e[h])&&T("[domino.global] Invalid type");if(null==f)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");h=a.split(/\|/);return!(!~h.indexOf("*")&&!~h.indexOf(j))}if("object"===this.get(a)){if("object"!==j)return!1;for(e in a)if(!this.check(a[e],f[e]))return!1;for(e in f)if(void 0===a[e])return!1;return!0}return!1},isValid:function(a){var f,e;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(e in a)if(0>i.indexOf(a[e]))return!1;
return!0}if("object"===this.get(a)){for(f in a)if(!this.isValid(a[f]))return!1;return!0}return!1}}}()};var H=t.utils,C={strict:!1,verbose:!1,shortcutPrefix:":"};t.settings=function(a,j){if("string"===typeof a&&void 0===j)return C[a];var i="object"===typeof a&&void 0===j?a||{}:{};"string"===typeof a&&(i[a]=j);for(var f in i)void 0!==C[f]&&(C[f]=i[f]);return this};t.EventDispatcher=function(){var a={};this.removeEventListener=function(j,i){if(!arguments.length)return this._handlers_={},this;var f,h,
g,l,e=H.array(j);if(i)for(f in e){l=e[f];if(a[l]){g=[];for(h in a[l])a[l][h].handler!==i&&g.push(a[l][h]);a[l]=g}a[l]&&0===a[l].length&&delete a[l]}else for(f in e)delete a[e[f]];return this};this.addEventListener=function(j,i){if(arguments.length)if(1===arguments.length&&"object"===H.type.get(arguments[0]))for(j in arguments[0])this.addEventListener(j,arguments[0][j]);else if(1<arguments.length){var f,j=arguments[0],i=arguments[1],h=H.array(j),g;for(g in h)f=h[g],a[f]||(a[f]=[]),a[f].push({handler:i})}return this};
this.dispatchEvent=function(j,i){var f,h,g,l,e,k=H.array(j),i=void 0===i?{}:i;for(f in k)if(e=k[f],a[e]){l=this.getEvent(e,i);g=[];for(h in a[e])a[e][h].handler(l),a[e][h].one||g.push(a[e][h]);a[e]=g}return this};this.getEvent=function(a,i){return{type:a,data:i,target:this}}};var Z=t.EventDispatcher;t.module=function(){Z.call(this);this.triggers={properties:{},events:{}}}})(window);
