/* domino.js - a JS fast dashboard prototyping framework - Version: 1.21 - Author:  Alexis Jacomy, Linkfluence - License: MIT */
(function(L,g){function aa(){M.strict?u.apply(this,arguments):ma.apply(this,arguments)}function u(){var a="",g;for(g in arguments)a+=(a?" ":"")+arguments[g];throw Error(a);}function ma(){M.verbose&&ea.apply(this,arguments)}function ea(){var a=[],g;for(g in arguments)a.push(arguments[g]);M.displayTime&&a.unshift(("00000000"+((new Date).getTime()-na)).substr(-8));console&&console.log instanceof Function&&console.log.apply(console,a)}var ka=/^[a-zA-Z_$-][a-zA-Z_$0-9-]*$/,na=new Date,V={};if(L.domino)throw Error("domino already exists");
L.domino=function(a,d){function p(b){var b=b||{},h={getEvents:z,getLabel:oa,expand:Q,warn:t,log:D,die:o,get:m};b.full?(h.kill=U,h.update=c,h.addModule=e,h.request=C,h.settings=w,h.dispatchEvent=function(b,h){q({events:I.getEvent(b,h)});return this}):(b.request&&(Object.defineProperty(h,"_services",{value:[]}),h.request=function(b,h){var a,j;if(l.check("string",b)){j={service:b};for(a in h||{})j[a]=h[a];this._services.push(j)}else if(l.check("object",b))this._services.push(b);else if(l.check("array",
b))for(a in b)this._services.push(b[a]);return this}),b.dispatchEvent&&(Object.defineProperty(h,"_events",{value:[]}),h.dispatchEvent=function(b,h){this._events.push({type:b,data:h});return this}));return h}function n(b){b.request!==g&&(b.request=function(){o("This method is no longer available.");return this});b.dispatchEvent!==g&&(b.dispatchEvent=function(){o("This method is no longer available.");return this})}function i(b,h){var a,fa,c=h||{};b===g&&o("Property name not specified");"string"!==
l.get(b)&&o("The property name must be a string");N[b]!==g&&o('Property "'+b+'" already exists');ba[b]!==g&&o('"'+b+'" can not be used to name a property');b.match(ka)||o("Property name not valid ("+ka+")");ga[b]={};for(fa in c)ga[b][fa]=c[fa];L[b]=c.label||b;c.type!==g&&(l.isValid(c.type)?O[b]=c.type:t('Property "'+b+'": Type not valid'));c.setter!==g&&("function"!==l.get(c.setter)?t('Property "'+b+'": Setter is not a function'):(E[b]=c.setter,ha[b]=!0));E[b]=E[b]||function(h){if(l.deepScalar(O[b])&&
l.compare(h,N[b],O[b]))return!1;O[b]&&!l.check(O[b],h)?t('Property "'+b+'": Wrong type error'):N[b]=h;return!0};c.getter!==g&&("function"!==l.get(c.getter)?t('Property "'+b+'": Getter is not a function'):(F[b]=c.getter,ia[b]=!0));F[b]=F[b]||function(){return N[b]};if(c.value!==g||O[b])c.value!==g?A(b,c.value):D('Property "'+b+'": Initial value is missing');if(c.triggers!==g)for(a in!l.check("array|string",c.triggers)&&t('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),
P[b]=x.array(c.triggers),P[b]||[])R[P[b][a]]=R[P[b][a]]||[],R[P[b][a]].push(b);c.dispatch!==g&&(!l.check("array|string",c.dispatch)?t('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):W[b]=x.array(c.dispatch));return I}function k(b){var h=b||{};(h.id===g||"string"!==l.get(h.id))&&o("The service id is not indicated.");l.check("function|string",h.url)||o("The service URL is not valid.");X[h.id]!==g&&o('The service "'+h.id+'" already exists.');
X[h.id]=function(b){D('Calling service "'+h.id+'".');var a=b||{},c=a.shortcuts||{},j={contentType:a.contentType||h.contentType,dataType:a.dataType||h.dataType,type:(a.type||h.type||"GET").toString().toUpperCase(),data:a.data!==g?a.data:"function"===l.get(h.data)?h.data.call(p(),a):h.data,url:"function"===l.get(h.url)?h.url.call(p(),a):h.url,error:function(b,c){I.dispatchEvent("domino.ajaxFailed");var G=a.error||h.error;D('Loading service "'+h.id+'" failed with message "'+b+'" and status '+c.status+
".");"function"===l.get(G)&&B(G,{parameters:[b,c,a],loop:a.loop||q,scope:{request:!0,dispatchEvent:!0}})}},f,J,e;J=w("shortcutPrefix");var b=RegExp(J+"(\\w+)","g"),m=RegExp("^"+J+"(\\w+)$"),i=null,d;for("string"!==l.get(j.url)&&o('The URL is no more a string (typed "'+l.get(j.url)+'")');(d=j.url.match(b))&&j.url!==i;)for(f in i=j.url,d)J=Q(d[f].match(m)[1],c),j.url=j.url.replace(RegExp(d[f],"g"),J);f=!0;"string"===l.get(j.data)&&j.data.match(m)&&(j.data=Q(j.data.match(m)[1],c));if("object"===l.get(j.data))for(;f;)for(e in f=
!1,j.data)"string"===l.get(j.data[e])&&j.data[e].match(m)&&(j.data[e]=Q(j.data[e].match(m)[1],c),f=!0);j.success=function(b){var G,f,J,d,i={},ja=[],o=[],C={},k=!1,A=a.path||h.path,o=a.setter||h.setter,r=a.success||h.success;d=a.expect||h.expect||w("expect");if("function"===l.get(d)&&!d.call(p(),b,a,h))j.error.call(this,"Unexpected data received.",this.xhr());else{D('Service "'+h.id+'" successfull.');"string"===l.get(o)&&o.match(m)&&(o=Q(o.match(m)[1],c));"string"===l.get(A)&&A.match(m)&&(A=Q(A.match(m)[1],
c));d=b;(A||"").match(/^(?:\w+\.)*\w+$/)?f=l.get(A,"string")?A.split("."):g:"string"===l.get(A)&&t('Path "'+A+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(f)for(G in f)d=d[f[G]],d===g&&t('Wrong path "'+A+'" for service "'+h.id+'".');f=x.array(h.events);for(G in f)i[f[G]]=1,k=!0;f=x.array(a.events);for(G in f)i[f[G]]=1,k=!0;o&&E[o]&&d!==g&&(C[o]=d,k=!0);if("function"===l.get(r)){b=B(r,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});f=x.array(b.events);for(e in f)k=!0,i[f[e].type]=1;for(e in b.update)C[e]===
g?(C[e]=b.update[e],k=!0):t('The key "'+e+'" is nor a method neither a property.');if((b.services||[]).length)k=!0,ja=ja.concat(b.services);n(b)}o=[];for(J in i)o.push(I.getEvent(J));k&&(a.loop||q)({events:o,update:C,services:ja})}};f=a.before||h.before;null!=f&&"function"===l.get(f)&&B(f,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});a.abort&&ca[h.id]&&ca[h.id].abort();ca[h.id]=x.ajax(j)};return I}function e(b,h){var a,c={},e={},j,q,d;b===g&&o("Module class not specified.");"function"!==l.get(b)&&
o("First parameter must be a function.");b.apply(c,(h||[]).concat(p()));j=c.triggers||{};for(d in j.events||{})S[d]=S[d]||[],S[d].push(j.events[d]);for(q in j.properties||{}){for(a in W[q]||[])T[q]=T[q]||[],T[q].push(j.properties[q]);F[q]!==g&&(m(q),B(j.properties[q],{parameters:[p()]}))}for(d in R||{})e[d]=1;for(d in H||{})e[d]=1;for(d in K||{})e[d]=1;for(d in e)c.addEventListener(d,f);Y.push(c);return c}function c(b,h){var a="object"===typeof b&&1===arguments.length?b||{}:{};"string"===typeof b&&
(a[b]=h);q({update:a});return this}function f(b){q({events:[b],emitter:b.target})}function q(b){var a,c,f,d,j,e,m,i=!1,l=[],k=[],r=[],b=b||{},s={},u={};b.loop=(+b.loop||0)+1;b.loopId=b.loopId||++aa;w("maxDepth")&&b.loop>w("maxDepth")&&o("Loop "+b.loopId+" exceeds maximum depth ("+w("maxDepth")+")");var v=x.array(b.events);m=x.array(b.services);var z=b.update||{};if(w("verbose")){D("Iteration "+b.loop+" (loop "+b.loopId+")");if(v.length){j=[];for(c in v)j.push(v[c].type);D(" -> Events: ",j)}if(m.length){j=
[];for(c in m)j.push("string"===typeof m[c]?m[c]:m[c].service);D(" -> Services: ",j)}j=[];for(c in z)j.push(c);j.length&&D(" -> Update: ",j)}for(a in z)if(E[a]===g)t('The property "'+a+'" is not referenced.');else if(j=A(a,z[a])||!!b.force){for(c in T[a])B(T[a][c],{parameters:[p(),{property:a,emitter:b.emitter}]});for(c in W[a]||[])j=W[a][c],s[j]=I.getEvent(j)}if(m.length)if(w("mergeRequests"))C(m);else for(f in m)C(m[f]);for(c in v){e=v[c];for(f in m=e.data||{},a=R[e.type]||[],a)m[a[f]]!==g&&(i=
!0,u[a[f]]=m[a[f]]);for(d in S[e.type])B(S[e.type][d],{parameters:[p(),e,b.emitter]});for(f in H[e.type]||[])if(0>l.indexOf(H[e.type][f])){l.push(H[e.type][f]);m=B(H[e.type][f],{parameters:[e],scope:{request:!0,dispatchEvent:!0}});a=x.array(m.events);for(d in a)s[a[d].type]=a[d];for(d in m.update)u[d]===g?(i=!0,u[d]=m.update[d]):t('The property "'+d+'" has already been updated in the current loop.');if((m.services||[]).length)i=!0,r=r.concat(m.services);n(m)}for(f in K[e.type]||[])j=K[e.type][f],
s[j]=I.getEvent(j)}for(e in s)I.dispatchEvent(e,s[e].data),k.push(s[e]),i=!0;i&&q({events:k,update:u,services:r,emitter:b.emitter,loopId:b.loopId,loop:b.loop})}function m(b){if(F[b]){if(ia[b]){for(var a=[],c={},f=1,e=arguments.length;f<e;f++)a.push(arguments[f]);c[b]=N[b];a=B(F[b],{parameters:a,inputValues:c});return y(b)?x.clone(a.returned):a.returned}return y(b)?x.clone(F[b]()):F[b]()}t('Property "'+b+'" not referenced.')}function A(b,a){if(E[b]){if(ha[b]){var c,f;c=[];f={};y(b)&&(a=x.clone(a));
f[b]=m(b);for(var e=1,d=arguments.length;e<d;e++)c.push(arguments[e]);f=B(E[b],{parameters:c,inputValues:f});(c="boolean"!==l.get(f.returned)||f.returned)&&(N[b]=f.update[b]);return c}return E[b].call(p(),y(b)?x.clone(a):a)}t('Property "'+b+'" not referenced.');return!1}function C(b,a){if(l.check("string",b))if(X[b])X[b](a);else t('Service "'+b+'" not referenced.');else if(l.check("object",b))C(b.service,b);else if(l.check("array",b)){var a=a||{},c,f=b.length;if(a.merge!==g?a.merge:w("mergeRequests")){var e,
d,m=f,i=[];for(c=0;c<f;c++){if("string"===typeof b[c])e={service:b[c]};else for(d in e={},b[c])e[d]=b[c][d];(function(b){e.loop=function(a){i[b]=a;if(!--m){var c,h,e={update:{},events:[],services:[]};for(c=0;c<f;c++){a=i[c]||{};for(h in a.update||{})e.update[h]=a.update[h];e.events=e.events.concat(a.events||[]);e.services=e.services.concat(a.services||[])}q(e)}}})(c);C(e)}}else for(c=0,f=b.length;c<f;c++)C(b[c])}return this}function B(b,a){var c,f,e=a||{},d=p(e.scope);"function"!==l.get(b)&&o("The first parameter must be a function");
for(c in e.inputValues||{})d[c]=e.inputValues[c];f={returned:b.apply(d,e.parameters||[]),update:{},events:[],services:[]};null!=d._events&&!l.check("array",d._events)?t("Events must be stored in an array."):f.events=d._events;for(c in d)E[c]!==g?f.update[c]=d[c]:ba[c]===g&&t('The key "'+c+'" is not a method nor a property.');for(c in e.inputValues)f.update[c]=d[c];for(c in d._services)f.services[c]=d._services[c];if(e.loop){d=(f.services||[]).length||(f.events||[]).length;if(!d)for(c in f.update)d=
!0;d&&(l.check("function",e.loop)?e.loop:q)(f)}else return f}function oa(b){return L[b]}function z(b){return P[b]}function Q(b){var a=b,c=(b||"").toString().match(RegExp("^"+w("shortcutPrefix")+"(\\w+)$"));c&&c.length&&(t("Prefix in expand() calls is deprecated."),a=c[1]);for(var c=1,f=arguments.length;c<f;c++)if((arguments[c]||{})[a]!==g)return arguments[c][a];if("function"===l.get(F[a]))return m(a);if("function"===l.get(Z[a]))return Z[a].call(p());t('The shortcut "',a,'" has not been recognized.');
return a}function y(b){b=(ga[b]||{}).clone;return b!==g?!!b:w("clone")}function U(){var b;D('Killing instance "'+v+'"');for(b in Y)Y[b].removeEventListener();Z=ca=X=K=H=T=S=W=R=Y=ha=ia=N=E=F=P=L=O=Y=null;for(b in $)delete $[b];V[v]&&delete V[v]}function w(b,a){if("string"===typeof b&&1===arguments.length)return da[b]!==g?da[b]:M[b];var c="object"===typeof b&&1===arguments.length?b||{}:{};"string"===typeof b&&(c[b]=a);for(var f in c)c[f]!==g?da[f]=c[f]:delete da[f];return this}function t(){var b=["["+
(v||"domino")+"]"];w("strict")||b.push("WARNING");for(var a in arguments)b.push(arguments[a]);w("strict")?u.apply(this,b):w("verbose")&&ea.apply(this,b)}function o(){var b=["["+(v||"domino")+"]"],a;for(a in arguments)b.push(arguments[a]);u.apply(this,b)}function D(){var b=["["+(v||"domino")+"]"];if(w("verbose")){for(var a in arguments)b.push(arguments[a]);ea.apply(this,b)}}la.call(this);var I=this,x=r.utils,l=r.struct,da={},$,O={},L={},P={},F={},E={},N={},ga={},ia={},ha={},Y=[],aa=0,R={},W={},S={},
T={},H={},K={},X={},ca={},Z={},ba={events:1,services:1,hacks:1};(function(){for(var b in Object.prototype)ba[b]=1;for(b in p({full:!0}))ba[b]=1})();$=p({full:!0});var s={},v;"string"===l.get(a)?v=a:a!==g&&"object"===l.get(a)?s=a:d!==g&&"object"===l.get(d)&&(s=d);(v=s.name)&&(V[v]?o('An instance named "'+v+'" is already running.'):V[v]=$);(function(){for(var b in s.properties||[])i(s.properties[b].id,s.properties[b]);for(b in s.hacks||[]){var a=void 0,c=void 0,f=s.hacks[b]||{};f.triggers===g&&o("A hack requires at least one trigger to be bound");
a=x.array(f.triggers);for(c in a)K[a[c]]=K[a[c]]||[],H[a[c]]=H[a[c]]||[],f.method&&H[a[c]].push(f.method),f.dispatch&&(K[a[c]]=K[a[c]].concat(x.array(f.dispatch)))}for(b in s.services||[])k(s.services[b]);for(b in s.shortcuts||[])a=s.shortcuts[b].id,c=s.shortcuts[b].method,a===g&&o("Shortcut ID not specified."),Z[a]&&o('Shortcut "'+a+'" already exists.'),c===g&&o("Shortcut method not specified."),Z[a]=c})();return $};var r=L.domino;r.utils={array:function(a,d){var g="string"===r.struct.get(a)?a.split(d||
" "):"array"===r.struct.get(a)?a:[a],n=[],i;for(i in g)g[i]&&n.push(g[i]);return n},clone:function(a){if(!a)return a;var d,g;if("array"===y.get(a))for(g in d=[],a)d[g]=this.clone(a[g]);else if("date"===y.get(a))d=new Date(a.getTime());else if("object"===y.get(a))if(a.prototype)d=a;else{d={};for(var n in a)d[n]=this.clone(a[n])}else d=a;return d},ajax:function(a,d){"string"===typeof a?a={url:a,ok:d}:"object"!==y.get(a)&&u("[domino.global] Invalid parameter given to AJAX");var g=a.type||"GET",n=a.url||
"",i=a.contentType||"application/x-www-form-urlencoded",k=a.dataType||"json",e=new XMLHttpRequest,c,f,q;if(a.data){if("string"===typeof a.data)f=a.data;else if(/json/.test(i))f=JSON.stringify(a.data);else{f=[];for(q in a.data)f.push(encodeURIComponent(q)+"="+encodeURIComponent(a.data[q]));f=f.join("&")}/GET|DEL/i.test(g)&&(n+=/\?/.test(n)?"&"+f:"?"+f,f="")}e.onreadystatechange=function(){if(4==e.readyState)if(c&&clearTimeout(c),/^2/.test(e.status)){f=e.responseText;if(/json/.test(k))try{f=JSON.parse(e.responseText)}catch(d){return a.error&&
a.error("JSON parse error: "+d.message,e)}a.success&&a.success(f,e)}else{var g=+e.status?e.responseText:e.responseText.length?"Aborted: "+e.responseText:"Aborted";a.error&&a.error(g,e)}};e.open(g,n,!0);e.setRequestHeader("Content-Type",i);if(a.headers)for(q in a.headers)e.setRequestHeader(q,a.headers[q]);a.timeout&&(c=setTimeout(function(){e.onreadystatechange=function(){};e.abort();a.error&&a.error&&a.error("timeout",e)},1E3*a.timeout));e.send(f);return e}};r.struct=function(){var a=["number","string",
"boolean","null","undefined"],d="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),p={},n=["*"],i={},k;for(k in d){var e=d[k];n.push(e.toLowerCase());p["[object "+e+"]"]=e.toLowerCase()}return{add:function(a,f,e){var d,p,k,B,y,z;1===arguments.length?"object"===this.get(a)?(z=a,k=z.id,y=z.struct):u("[domino.global] If struct.add is called with one arguments, it has to be an object"):2===arguments.length?("string"!==this.get(a)||!a?u("[domino.global] If struct.add is called with more than one arguments, the first one must be the string id"):
k=a,y=f):u("[domino.global] struct.add has to be called with one or three arguments");("string"!==this.get(k)||0===k.length)&&u("[domino.global] A structure requires an string id");i[k]!==g&&"proto"!==i[k]&&u('[domino.global] The structure "'+k+'" already exists');i[k]=1;p=r.utils.array((z||{}).proto);B={};for(d in p)i[p[d]]===g&&(i[p[d]]=1,B[p[d]]=1);"function"!==this.get(y)&&!this.isValid(y)&&u('[domino.global] A structure requires a valid "structure" property describing the structure. It can be a valid structure or a function that test if an object matches the structure.');
~n.indexOf(k)&&u('[domino.global] "'+k+'" is a reserved structure name');i[k]=z===g?{id:k,struct:y}:{};if(z!==g)for(d in z)i[k][d]=z[d];for(d in B)d!==k&&delete i[d]},get:function(a){return null==a?""+a:p[Object.prototype.toString.call(a)]||"object"},check:function(a,f){var d,e,k=this.get(f);if("string"===this.get(a)){d=a.replace(/^\?/,"").split(/\|/);for(e in d)if(0>n.indexOf(d[e])&&i[d[e]]===g)return aa("[domino.global] Invalid type"),!1;if(null==f)return!!a.match(/^\?/,"");a.replace(/^\?/,"");
for(e in d)if(i[d[e]]&&("function"===this.get(i[d[e]].struct)&&!0===i[d[e]].struct(f)||this.check(i[d[e]].struct,f)))return!0;return!(!~d.indexOf("*")&&!~d.indexOf(k))}if("object"===this.get(a)){if("object"!==k)return!1;for(d in a)if(!this.check(a[d],f[d]))return!1;for(d in f)if(a[d]===g)return!1;return!0}if("array"===this.get(a)){if("array"!==k)return!1;if(1!==a.length)return aa("[domino.global] Invalid type"),!1;for(d in f)if(!this.check(a[0],f[d]))return!1;return!0}return!1},deepScalar:function(c){var d;
if("string"===this.get(c)){c=c.replace(/^\?/,"").split(/\|/);for(d in c)if(0>a.indexOf(c[d]))return!1;return!0}if(this.check("object|array",c)){for(d in c)if(!this.deepScalar(c[d]))return!1;return!0}return!1},compare:function(a,d,e){this.get(a);this.get(d);var g;if(!this.deepScalar(e)||!this.check(e,a)||!this.check(e,d))return!1;if("string"===this.get(e))return a===d;if("object"===this.get(e)){for(g in e)if(!this.compare(a[g],d[g],e[g]))return!1;return!0}if("array"===this.get(e)){if(a.length!==d.length)return!1;
var i=a.length;for(g=0;g<i;g++)if(!this.compare(a[g],d[g],e[0]))return!1;return!0}return!1},isValid:function(a){var d,e;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(e in a)if(0>n.indexOf(a[e])&&i[a[e]]===g)return!1;return!0}if("object"===this.get(a)){for(d in a)if(!this.isValid(a[d]))return!1;return!0}return"array"===this.get(a)?1===a.length?this.isValid(a[0]):!1:!1}}}();var U=r.utils,y=r.struct,M={maxDepth:0,strict:!1,verbose:!1,displayTime:!1,shortcutPrefix:":",mergeRequests:!0,
clone:!1};r.settings=function(a,d){if("string"===typeof a&&1===arguments.length)return M[a];var p="object"===typeof a&&1===arguments.length?a||{}:{};"string"===typeof a&&(p[a]=d);for(var n in p)p[n]!==g?M[n]=p[n]:delete M[n];return this};r.instances=function(a){if(arguments.length)return V[a];u("[domino.global] You need to indicate a name to get the instance.")};r.EventDispatcher=function(){var a={};this.removeEventListener=function(d,g){if(!arguments.length)return this._handlers_={},this;var n,i,
k,e,c=U.array(d);if(g)for(n in c){e=c[n];if(a[e]){k=[];for(i in a[e])a[e][i].handler!==g&&k.push(a[e][i]);a[e]=k}a[e]&&0===a[e].length&&delete a[e]}else for(n in c)delete a[c[n]];return this};this.addEventListener=function(d,g){if(arguments.length)if(1===arguments.length&&"object"===U.type.get(arguments[0]))for(d in arguments[0])this.addEventListener(d,arguments[0][d]);else if(1<arguments.length){var n,d=arguments[0],g=arguments[1],i=U.array(d),k;for(k in i)n=i[k],a[n]||(a[n]=[]),a[n].push({handler:g})}return this};
this.dispatchEvent=function(d,p){var n,i,k,e,c,f=U.array(d),p=p===g?{}:p;for(n in f)if(c=f[n],a[c]){e=this.getEvent(c,p);k=[];for(i in a[c])a[c][i].handler(e),a[c][i].one||k.push(a[c][i]);a[c]=k}return this};this.getEvent=function(a,g){return{type:a,data:g||{},target:this}}};var la=r.EventDispatcher;r.module=function(){la.call(this);this.triggers={properties:{},events:{}}}})(window);
