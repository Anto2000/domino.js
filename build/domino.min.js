/* domino.js - a JS fast dashboard prototyping framework - Version: 1.11 - Author:  Alexis Jacomy, Linkfluence - License: MIT */
(function(K,f){function ha(){L.strict?t.apply(this,arguments):ka.apply(this,arguments)}function t(){var a="",f;for(f in arguments)a+=(a?" ":"")+arguments[f];throw Error(a);}function ka(){L.verbose&&ca.apply(this,arguments)}function ca(){var a=[],f;for(f in arguments)a.push(arguments[f]);L.displayTime&&a.unshift(("00000000"+((new Date).getTime()-la)).substr(-8));console&&console.log instanceof Function&&console.log.apply(console,a)}var ia=/^[a-zA-Z_$-][a-zA-Z_$0-9-]*$/,la=new Date,U={};if(K.domino)throw Error("domino already exists");
K.domino=function(a,l){function h(b){var b=b||{},g={getEvents:A,getLabel:ma,expand:P,warn:s,log:B,die:p,get:j};b.full?(g.kill=T,g.update=c,g.addModule=d,g.request=z,g.settings=F,g.dispatchEvent=function(b,g){k({events:I.getEvent(b,g)});return this}):(b.request&&(Object.defineProperty(g,"_services",{value:[]}),g.request=function(b,g){this._services.push({service:b,params:g});return this}),b.dispatchEvent&&(Object.defineProperty(g,"_events",{value:[]}),g.dispatchEvent=function(b,g){this._events.push({type:b,
data:g});return this}));return g}function n(b){b.request!==f&&(b.request=function(){p("This method is no longer available.");return this});b.dispatchEvent!==f&&(b.dispatchEvent=function(){p("This method is no longer available.");return this})}function e(b,g){var y,a,c=g||{};b===f&&p("Property name not specified");"string"!==m.get(b)&&p("The property name must be a string");M[b]!==f&&p('Property "'+b+'" already exists');$[b]!==f&&p('"'+b+'" can not be used to name a property');b.match(ia)||p("Property name not valid ("+
ia+")");da[b]={};for(a in c)da[b][a]=c[a];K[b]=c.label||b;c.type!==f&&(m.isValid(c.type)?N[b]=c.type:s('Property "'+b+'": Type not valid'));c.setter!==f&&("function"!==m.get(c.setter)?s('Property "'+b+'": Setter is not a function'):(C[b]=c.setter,ea[b]=!0));C[b]=C[b]||function(g){if(m.deepScalar(N[b])&&m.compare(g,M[b],N[b]))return!1;N[b]&&!m.check(N[b],g)?s('Property "'+b+'": Wrong type error'):M[b]=g;return!0};c.getter!==f&&("function"!==m.get(c.getter)?s('Property "'+b+'": Getter is not a function'):
(D[b]=c.getter,fa[b]=!0));D[b]=D[b]||function(){return M[b]};if(c.value!==f||N[b])c.value!==f?E(b,c.value):B('Property "'+b+'": Initial value is missing');if(c.triggers!==f)for(y in!m.check("array|string",c.triggers)&&s('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),O[b]=v.array(c.triggers),O[b]||[])Q[O[b][y]]=Q[O[b][y]]||[],Q[O[b][y]].push(b);c.dispatch!==f&&(!m.check("array|string",c.dispatch)?s('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):
V[b]=v.array(c.dispatch));return I}function o(b){var g=b||{};(g.id===f||"string"!==m.get(g.id))&&p("The service id is not indicated.");m.check("function|string",g.url)||p("The service URL is not valid.");W[g.id]!==f&&p('The service "'+g.id+'" already exists.');W[g.id]=function(b){B('Calling service "'+g.id+'".');var a=b||{},c=a.shortcuts||{},b={contentType:a.contentType||g.contentType,dataType:a.dataType||g.dataType,type:(a.type||g.type||"GET").toString().toUpperCase(),data:a.data!==f?a.data:"function"===
m.get(g.data)?g.data.call(h(),a):g.data,url:"function"===m.get(g.url)?g.url.call(h(),a):g.url,error:function(b,c){I.dispatchEvent("domino.ajaxFailed");var y=a.error||g.error;"function"===m.get(y)?G(y,{parameters:[b,c,a],loop:!0,scope:{request:!0,dispatchEvent:!0}}):B('Loading service "'+g.id+'" failed with message "'+b+'" and status '+c.status+".")}},q,i,d;i=F("shortcutPrefix");var j=RegExp(i+"(\\w+)","g"),e=RegExp("^"+i+"(\\w+)$"),l=null,z;for("string"!==m.get(b.url)&&p('The URL is no more a string (typed "'+
m.get(b.url)+'")');(z=b.url.match(j))&&b.url!==l;)for(q in l=b.url,z)i=P(z[q].match(e)[1],c),b.url=b.url.replace(RegExp(z[q],"g"),i);q=!0;"string"===m.get(b.data)&&b.data.match(e)&&(b.data=P(b.data.match(e)[1],c));if("object"===m.get(b.data))for(;q;)for(d in q=!1,b.data)"string"===m.get(b.data[d])&&b.data[d].match(e)&&(b.data[d]=P(b.data[d].match(e)[1],c),q=!0);b.success=function(b){B('Service "'+g.id+'" successfull.');var y,i,q,j,l={},ga=[];j=[];var z={},p=!1,o=a.path||g.path,E=a.setter||g.setter,
r=a.success||g.success;"string"===m.get(E)&&E.match(e)&&(E=P(E.match(e)[1],c));"string"===m.get(o)&&o.match(e)&&(o=P(o.match(e)[1],c));j=b;(o||"").match(/^(?:\w+\.)*\w+$/)?i=m.get(o,"string")?o.split("."):f:"string"===m.get(o)&&s('Path "'+o+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(i)for(y in i)j=j[i[y]],j===f&&s('Wrong path "'+o+'" for service "'+g.id+'".');i=v.array(g.events);for(y in i)l[i[y]]=1,p=!0;i=v.array(a.events);for(y in i)l[i[y]]=1,p=!0;E&&C[E]&&j!==f&&(z[E]=j,p=!0);if("function"===
m.get(r)){b=G(r,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});i=v.array(b.events);for(d in i)p=!0,l[i[d].type]=1;for(d in b.update)z[d]===f?(z[d]=b.update[d],p=!0):s('The key "'+d+'" is nor a method neither a property.');if((b.services||[]).length)p=!0,ga=ga.concat(b.services);n(b)}j=[];for(q in l)I.dispatchEvent(q,h()),j.push(I.getEvent(q,h()));p&&k({events:j,update:z,services:ga})};q=a.before||g.before;null!=q&&"function"===m.get(q)&&G(q,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});
a.abort&&aa[g.id]&&aa[g.id].abort();aa[g.id]=v.ajax(b)};return I}function d(b,g){var a,c={},d={},q,k,e;b===f&&p("Module class not specified.");"function"!==m.get(b)&&p("First parameter must be a function.");b.apply(c,(g||[]).concat(h()));q=c.triggers||{};for(e in q.events||{})R[e]=R[e]||[],R[e].push(q.events[e]);for(k in q.properties||{}){for(a in V[k]||[])S[k]=S[k]||[],S[k].push(q.properties[k]);D[k]!==f&&(j(k),G(q.properties[k],{parameters:[h()]}))}for(e in Q||{})d[e]=1;for(e in H||{})d[e]=1;for(e in J||
{})d[e]=1;for(e in d)c.addEventListener(e,i);X.push(c);return c}function c(b,g){var a="object"===typeof b&&1===arguments.length?b||{}:{};"string"===typeof b&&(a[b]=g);k({update:a});return this}function i(b){k({events:[b]})}function k(b){var g,a,c,i,e,d,j,l=!1,m=[],p=[],o=[],b=b||{},r={},u={};b.loop=(+b.loop||0)+1;var t=v.array(b.events);d=v.array(b.services);var w=b.update||{};if(F("verbose")){B("Iteration "+b.loop+" (main loop)");if(t.length){j=[];for(a in t)j.push(t[a].type);B(" -> Events: ",j)}if(d.length){j=
[];for(a in d)j.push(d[a].service);B(" -> Services: ",j)}j=[];for(a in w)j.push(a);j.length&&B(" -> Update: ",j)}for(g in w)if(C[g]===f)s('The property "'+g+'" is not referenced.');else if(j=E(g,w[g])||!!b.force){for(a in S[g])G(S[g][a],{parameters:[h(),{property:g}]});for(a in V[g]||[])r[V[g][a]]=1}for(a in d||[])z(d[a].service,d[a].params);for(a in t){e=t[a];for(c in d=e.data||{},g=Q[e.type]||[],g)d[g[c]]!==f&&(l=!0,u[g[c]]=d[g[c]]);for(i in R[e.type])G(R[e.type][i],{parameters:[h(),e]});for(c in H[e.type]||
[])if(0>m.indexOf(H[e.type][c])){m.push(H[e.type][c]);d=G(H[e.type][c],{parameters:[e],scope:{request:!0,dispatchEvent:!0}});g=v.array(d.events);for(i in g)r[g[i].type]=1;for(i in d.update)u[i]===f?(l=!0,u[i]=d.update[i]):s('The property "'+i+'" has already been updated in the current loop.');if((d.services||[]).length)l=!0,o=o.concat(d.services);n(d)}for(c in J[e.type]||[])r[J[e.type][c]]=1}for(e in r)I.dispatchEvent(e,h()),p.push(I.getEvent(e,h())),l=!0;l&&k({events:p,update:u,services:o,loop:b.loop})}
function j(b){if(D[b]){if(fa[b]){for(var a=[],c={},e=1,d=arguments.length;e<d;e++)a.push(arguments[e]);c[b]=M[b];a=G(D[b],{parameters:a,inputValues:c});return x(b)?v.clone(a.returned):a.returned}return x(b)?v.clone(D[b]()):D[b]()}s('Property "'+b+'" not referenced.')}function E(b,a){if(C[b]){if(ea[b]){var c,e;c=[];e={};x(b)&&(a=v.clone(a));e[b]=j(b);for(var d=1,i=arguments.length;d<i;d++)c.push(arguments[d]);e=G(C[b],{parameters:c,inputValues:e});(c="boolean"!==m.get(e.returned)||e.returned)&&(M[b]=
e.update[b]);return c}return C[b].call(h(),x(b)?v.clone(a):a)}s('Property "'+b+'" not referenced.');return!1}function z(b,a){if(W[b])W[b](a);else s('Service "'+b+'" not referenced.');return this}function G(b,a){var c,e,d=a||{},i=h(d.scope);"function"!==m.get(b)&&p("The first parameter must be a function");for(c in d.inputValues||{})i[c]=d.inputValues[c];e={returned:b.apply(i,d.parameters||[]),update:{},events:[],services:[]};null!=i._events&&!m.check("array",i._events)?s("Events must be stored in an array."):
e.events=i._events;for(c in i)C[c]!==f?e.update[c]=i[c]:$[c]===f&&s('The key "'+c+'" is not a method nor a property.');for(c in d.inputValues)e.update[c]=i[c];for(c in i._services)e.services[c]=i._services[c];if(d.loop){d=(e.services||[]).length||(e.events||[]).length;if(!d)for(c in e.update)d=!0;d&&k(e)}else return e}function ma(b){return K[b]}function A(b){return O[b]}function P(b){var a=b,c=(b||"").toString().match(RegExp("^"+F("shortcutPrefix")+"(\\w+)$"));c&&c.length&&(s("Prefix in expand() calls is deprecated."),
a=c[1]);for(var c=1,e=arguments.length;c<e;c++)if((arguments[c]||{})[a]!==f)return arguments[c][a];if("function"===m.get(D[a]))return j(a);if("function"===m.get(Y[a]))return Y[a].call(h());s('The shortcut "',a,'" has not been recognized.');return a}function x(b){b=(da[b]||{}).clone;return b!==f?!!b:F("clone")}function T(){var b;B('Killing instance "'+w+'"');for(b in X)X[b].removeEventListener();Y=aa=W=J=H=S=R=V=Q=X=ea=fa=M=C=D=O=K=N=X=null;for(b in Z)delete Z[b];U[w]&&delete U[w]}function F(b,a){if("string"===
typeof b&&1===arguments.length)return ba[b]!==f?ba[b]:L[b];var c="object"===typeof b&&1===arguments.length?b||{}:{};"string"===typeof b&&(c[b]=a);for(var e in c)c[e]!==f?ba[e]=c[e]:delete ba[e];return this}function s(){var b=["["+(w||"domino")+"]"];F("strict")||b.push("WARNING");for(var a in arguments)b.push(arguments[a]);F("strict")?t.apply(this,b):F("verbose")&&ca.apply(this,b)}function p(){var b=["["+(w||"domino")+"]"],a;for(a in arguments)b.push(arguments[a]);t.apply(this,b)}function B(){var b=
["["+(w||"domino")+"]"];if(F("verbose")){for(var a in arguments)b.push(arguments[a]);ca.apply(this,b)}}ja.call(this);var I=this,v=r.utils,m=r.struct,ba={},Z,N={},K={},O={},D={},C={},M={},da={},fa={},ea={},X=[],Q={},V={},R={},S={},H={},J={},W={},aa={},Y={},$={events:1,services:1,hacks:1};(function(){for(var b in Object.prototype)$[b]=1;for(b in h({full:!0}))$[b]=1})();Z=h({full:!0});var u={},w;"string"===m.get(a)?w=a:a!==f&&"object"===m.get(a)?u=a:l!==f&&"object"===m.get(l)&&(u=l);(w=u.name)&&(U[w]?
p('An instance named "'+w+'" is already running.'):U[w]=Z);(function(){for(var b in u.properties||[])e(u.properties[b].id,u.properties[b]);for(b in u.hacks||[]){var a=void 0,c=void 0,d=u.hacks[b]||{};d.triggers===f&&p("A hack requires at least one trigger to be bound");a=v.array(d.triggers);for(c in a)J[a[c]]=J[a[c]]||[],H[a[c]]=H[a[c]]||[],d.method&&H[a[c]].push(d.method),d.dispatch&&(J[a[c]]=J[a[c]].concat(v.array(d.dispatch)))}for(b in u.services||[])o(u.services[b]);for(b in u.shortcuts||[])a=
u.shortcuts[b].id,c=u.shortcuts[b].method,a===f&&p("Shortcut ID not specified."),Y[a]&&p('Shortcut "'+a+'" already exists.'),c===f&&p("Shortcut method not specified."),Y[a]=c})();return Z};var r=K.domino;r.utils={array:function(a,f){var h="string"===r.struct.get(a)?a.split(f||" "):"array"===r.struct.get(a)?a:[a],n=[],e;for(e in h)h[e]&&n.push(h[e]);return n},clone:function(a){if(!a)return a;var f,h;if("array"===x.get(a))for(h in f=[],a)f[h]=this.clone(a[h]);else if("date"===x.get(a))f=new Date(a.getTime());
else if("object"===x.get(a))if(a.prototype)f=a;else{f={};for(var n in a)f[n]=this.clone(a[n])}else f=a;return f},ajax:function(a,f){"string"===typeof a?a={url:a,ok:f}:"object"!==x.get(a)&&t("[domino.global] Invalid parameter given to AJAX");var h=a.type||"GET",n=a.url||"",e=a.contentType||"application/x-www-form-urlencoded",o=a.dataType||"json",d=new XMLHttpRequest,c,i,k;if(a.data){if("string"===typeof a.data)i=a.data;else if(/json/.test(e))i=JSON.stringify(a.data);else{i=[];for(k in a.data)i.push(encodeURIComponent(k)+
"="+encodeURIComponent(a.data[k]));i=i.join("&")}/GET|DEL/i.test(h)&&(n+=/\?/.test(n)?"&"+i:"?"+i,i="")}d.onreadystatechange=function(){if(4==d.readyState)if(c&&clearTimeout(c),/^2/.test(d.status)){i=d.responseText;if(/json/.test(o))try{i=JSON.parse(d.responseText)}catch(e){return a.error&&a.error("JSON parse error: "+e.message,d)}a.success&&a.success(i,d)}else{var f=+d.status?d.responseText:d.responseText.length?"Aborted: "+d.responseText:"Aborted";a.error&&a.error(f,d)}};d.open(h,n,!0);d.setRequestHeader("Content-Type",
e);if(a.headers)for(k in a.headers)d.setRequestHeader(k,a.headers[k]);a.timeout&&(c=setTimeout(function(){d.onreadystatechange=function(){};d.abort();a.error&&a.error&&a.error("timeout",d)},1E3*a.timeout));d.send(i);return d}};r.struct=function(){var a=["number","string","boolean","null","undefined"],l="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),h={},n=["*"],e={},o;for(o in l){var d=l[o];n.push(d.toLowerCase());h["[object "+d+"]"]=d.toLowerCase()}return{add:function(a,d,k){var j,
h,l,o,x,A;1===arguments.length?"object"===this.get(a)?(A=a,l=A.id,x=A.struct):t("[domino.global] If struct.add is called with one arguments, it has to be an object"):2===arguments.length?("string"!==this.get(a)||!a?t("[domino.global] If struct.add is called with more than one arguments, the first one must be the string id"):l=a,x=d):t("[domino.global] struct.add has to be called with one or three arguments");("string"!==this.get(l)||0===l.length)&&t("[domino.global] A structure requires an string id");
e[l]!==f&&"proto"!==e[l]&&t('[domino.global] The structure "'+l+'" already exists');e[l]=1;h=r.utils.array((A||{}).proto);o={};for(j in h)e[h[j]]===f&&(e[h[j]]=1,o[h[j]]=1);"function"!==this.get(x)&&!this.isValid(x)&&t('[domino.global] A structure requires a valid "structure" property describing the structure. It can be a valid structure or a function that test if an object matches the structure.');~n.indexOf(l)&&t('[domino.global] "'+l+'" is a reserved structure name');e[l]=A===f?{id:l,struct:x}:
{};if(A!==f)for(j in A)e[l][j]=A[j];for(j in o)j!==l&&delete e[j]},get:function(a){return null==a?""+a:h[Object.prototype.toString.call(a)]||"object"},check:function(a,d){var k,j,h=this.get(d);if("string"===this.get(a)){k=a.replace(/^\?/,"").split(/\|/);for(j in k)if(0>n.indexOf(k[j])&&e[k[j]]===f)return ha("[domino.global] Invalid type"),!1;if(null==d)return!!a.match(/^\?/,"");a.replace(/^\?/,"");for(j in k)if(e[k[j]]&&("function"===this.get(e[k[j]].struct)&&!0===e[k[j]].struct(d)||this.check(e[k[j]].struct,
d)))return!0;return!(!~k.indexOf("*")&&!~k.indexOf(h))}if("object"===this.get(a)){if("object"!==h)return!1;for(k in a)if(!this.check(a[k],d[k]))return!1;for(k in d)if(a[k]===f)return!1;return!0}if("array"===this.get(a)){if("array"!==h)return!1;if(1!==a.length)return ha("[domino.global] Invalid type"),!1;for(k in d)if(!this.check(a[0],d[k]))return!1;return!0}return!1},deepScalar:function(c){var d;if("string"===this.get(c)){c=c.replace(/^\?/,"").split(/\|/);for(d in c)if(0>a.indexOf(c[d]))return!1;
return!0}if(this.check("object|array",c)){for(d in c)if(!this.deepScalar(c[d]))return!1;return!0}return!1},compare:function(a,d,e){this.get(a);this.get(d);var f;if(!this.deepScalar(e)||!this.check(e,a)||!this.check(e,d))return!1;if("string"===this.get(e))return a===d;if("object"===this.get(e)){for(f in e)if(!this.compare(a[f],d[f],e[f]))return!1;return!0}if("array"===this.get(e)){if(a.length!==d.length)return!1;var h=a.length;for(f=0;f<h;f++)if(!this.compare(a[f],d[f],e[0]))return!1;return!0}return!1},
isValid:function(a){var d,h;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(h in a)if(0>n.indexOf(a[h])&&e[a[h]]===f)return!1;return!0}if("object"===this.get(a)){for(d in a)if(!this.isValid(a[d]))return!1;return!0}return"array"===this.get(a)?1===a.length?this.isValid(a[0]):!1:!1}}}();var T=r.utils,x=r.struct,L={strict:!1,verbose:!1,shortcutPrefix:":",displayTime:!1,clone:!1};r.settings=function(a,l){if("string"===typeof a&&1===arguments.length)return L[a];var h="object"===typeof a&&
1===arguments.length?a||{}:{};"string"===typeof a&&(h[a]=l);for(var n in h)h[n]!==f?L[n]=h[n]:delete L[n];return this};r.instances=function(a){if(arguments.length)return U[a];t("[domino.global] You need to indicate a name to get the instance.")};r.EventDispatcher=function(){var a={};this.removeEventListener=function(f,h){if(!arguments.length)return this._handlers_={},this;var n,e,o,d,c=T.array(f);if(h)for(n in c){d=c[n];if(a[d]){o=[];for(e in a[d])a[d][e].handler!==h&&o.push(a[d][e]);a[d]=o}a[d]&&
0===a[d].length&&delete a[d]}else for(n in c)delete a[c[n]];return this};this.addEventListener=function(f,h){if(arguments.length)if(1===arguments.length&&"object"===T.type.get(arguments[0]))for(f in arguments[0])this.addEventListener(f,arguments[0][f]);else if(1<arguments.length){var n,f=arguments[0],h=arguments[1],e=T.array(f),o;for(o in e)n=e[o],a[n]||(a[n]=[]),a[n].push({handler:h})}return this};this.dispatchEvent=function(l,h){var n,e,o,d,c,i=T.array(l),h=h===f?{}:h;for(n in i)if(c=i[n],a[c]){d=
this.getEvent(c,h);o=[];for(e in a[c])a[c][e].handler(d),a[c][e].one||o.push(a[c][e]);a[c]=o}return this};this.getEvent=function(a,f){return{type:a,data:f,target:this}}};var ja=r.EventDispatcher;r.module=function(){ja.call(this);this.triggers={properties:{},events:{}}}})(window);
