/* domino.js - a JS fast dashboard prototyping framework - Version: 1.1 - Author:  Alexis Jacomy, Linkfluence - License: MIT */
(function(v){function ea(){I.strict?x.apply(this,arguments):ha.apply(this,arguments)}function x(){var a="",c;for(c in arguments)a+=(a?" ":"")+arguments[c];throw Error(a);}function ha(){I.verbose&&aa.apply(this,arguments)}function aa(){var a=[],c;for(c in arguments)a.push(arguments[c]);I.displayTime&&a.unshift(("00000000"+((new Date).getTime()-ia)).substr(-8));console&&"function"===typeof console.log&&console.log.apply(console,a)}var fa=/^[a-zA-Z_$-][a-zA-Z_$0-9-]*$/,ia=new Date,R={};if(v.domino)throw Error("domino already exists");
v.domino=function(a,c){function i(b){var b=b||{},g={getEvents:ja,getLabel:ka,expand:q,warn:r,log:A,die:n,get:h};b.full?(g.kill=Q,g.update=e,g.addModule=k,g.request=B,g.settings=E,g.dispatchEvent=function(b,g){m({events:G.getEvent(b,g)})}):(b.request&&(Object.defineProperty(g,"_services",{value:[]}),g.request=function(b,g){this._services.push({service:b,params:g})}),b.dispatchEvent&&(Object.defineProperty(g,"_events",{value:[]}),g.dispatchEvent=function(b,g){this._events.push({type:b,data:g})}));return g}
function f(b,g){var u,a,d=g||{};void 0===b&&n("Property name not specified");"string"!==l.get(b)&&n("The property name must be a string");void 0!==J[b]&&n('Property "'+b+'" already exists');void 0!==X[b]&&n('"'+b+'" can not be used to name a property');b.match(fa)||n("Property name not valid ("+fa+")");ba[b]={};for(a in d)ba[b][a]=d[a];v[b]=d.label||b;void 0!==d.type&&(l.isValid(d.type)?K[b]=d.type:r('Property "'+b+'": Type not valid'));void 0!==d.setter&&("function"!==l.get(d.setter)?r('Property "'+
b+'": Setter is not a function'):(C[b]=d.setter,ca[b]=!0));C[b]=C[b]||function(g){if(l.deepScalar(K[b])&&l.compare(g,J[b],K[b]))return!1;K[b]&&!l.check(K[b],g)?r('Property "'+b+'": Wrong type error'):J[b]=g;return!0};void 0!==d.getter&&("function"!==l.get(d.getter)?r('Property "'+b+'": Getter is not a function'):(D[b]=d.getter,da[b]=!0));D[b]=D[b]||function(){return J[b]};if(void 0!==d.value||K[b])void 0!==d.value?y(b,d.value):A('Property "'+b+'": Initial value is missing');if(void 0!==d.triggers)for(u in!l.check("array|string",
d.triggers)&&r('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),L[b]=t.array(d.triggers),L[b]||[])N[L[b][u]]=N[L[b][u]]||[],N[L[b][u]].push(b);void 0!==d.dispatch&&(!l.check("array|string",d.dispatch)?r('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):S[b]=t.array(d.dispatch));return G}function j(b){var g=b||{};(void 0===g.id||"string"!==l.get(g.id))&&n("The service id is not indicated.");
l.check("function|string",g.url)||n("The service URL is not valid.");void 0!==T[g.id]&&n('The service "'+g.id+'" already exists.');T[g.id]=function(b){A('Calling service "'+g.id+'".');var a=b||{},d=a.shortcuts||{},b={contentType:a.contentType||g.contentType,dataType:a.dataType||g.dataType,type:(a.type||g.type||"GET").toString().toUpperCase(),data:void 0!==a.data?a.data:"function"===l.get(g.data)?g.data.call(i(),a):g.data,url:"function"===l.get(g.url)?g.url.call(i(),a):g.url,error:function(b,d){G.dispatchEvent("domino.ajaxFailed");
var u=a.error||g.error;"function"===l.get(u)?F(u,{parameters:[b,d,a],loop:!0,scope:{request:!0,dispatchEvent:!0}}):A('Loading service "'+g.id+'" failed with message "'+b+'" and status '+d.status+".")}},o,h,c;h=E("shortcutPrefix");var e=RegExp(h+"(\\w+)","g"),f=RegExp("^"+h+"(\\w+)$"),j=null,y;for("string"!==l.get(b.url)&&n('The URL is no more a string (typed "'+l.get(b.url)+'")');(y=b.url.match(e))&&b.url!==j;)for(o in j=b.url,y)h=q(y[o].match(f)[1],d),b.url=b.url.replace(RegExp(y[o],"g"),h);o=!0;
"string"===l.get(b.data)&&b.data.match(f)&&(b.data=q(b.data.match(f)[1],d));if("object"===l.get(b.data))for(;o;)for(c in o=!1,b.data)"string"===l.get(b.data[c])&&b.data[c].match(f)&&(b.data[c]=q(b.data[c].match(f)[1],d),o=!0);b.success=function(b){A('Service "'+g.id+'" successfull.');var u,h,o,e,y={},j=[];e=[];var Y={},n=!1,k=a.path||g.path,B=a.setter||g.setter,p=a.success||g.success;"string"===l.get(B)&&B.match(f)&&(B=q(B.match(f)[1],d));"string"===l.get(k)&&k.match(f)&&(k=q(k.match(f)[1],d));e=
b;(k||"").match(/^(?:\w+\.)*\w+$/)?h=l.get(k,"string")?k.split("."):void 0:"string"===l.get(k)&&r('Path "'+k+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(h)for(u in h)e=e[h[u]],void 0===e&&r('Wrong path "'+k+'" for service "'+g.id+'".');h=t.array(g.events);for(u in h)y[h[u]]=1,n=!0;h=t.array(a.events);for(u in h)y[h[u]]=1,n=!0;B&&C[B]&&void 0!==e&&(Y[B]=e,n=!0);if("function"===l.get(p)){b=F(p,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});h=t.array(b.events);for(c in h)n=!0,y[h[c].type]=
1;for(c in b.update)void 0===Y[c]?(Y[c]=b.update[c],n=!0):r('The key "'+c+'" is nor a method neither a property.');if((b.services||[]).length)n=!0,j=j.concat(b.services)}e=[];for(o in y)G.dispatchEvent(o,i()),e.push(G.getEvent(o,i()));n&&m({events:e,update:Y,services:j})};o=a.before||g.before;null!=o&&"function"===l.get(o)&&F(o,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});a.abort&&Z[g.id]&&Z[g.id].abort();Z[g.id]=t.ajax(b)};return G}function k(b,g){var a,c={},e={},o,m,f;void 0===b&&n("Module class not specified.");
"function"!==l.get(b)&&n("First parameter must be a function.");b.apply(c,(g||[]).concat(i()));o=c.triggers||{};for(f in o.events||{})O[f]=O[f]||[],O[f].push(o.events[f]);for(m in o.properties||{}){for(a in S[m]||[])P[m]=P[m]||[],P[m].push(o.properties[m]);void 0!==D[m]&&(h(m),F(o.properties[m],{parameters:[i()]}))}for(f in N||{})e[f]=1;for(f in M||{})e[f]=1;for(f in H||{})e[f]=1;for(f in e)c.addEventListener(f,d);U.push(c);return c}function e(b,g){var a="object"===typeof b&&1===arguments.length?
b||{}:{};"string"===typeof b&&(a[b]=g);m({update:a});return this}function d(b){m({events:[b]})}function m(b){var g,a,d,h,f,c,e,j=!1,l=[],k=[],b=b||{},n={},p={};b.loop=(+b.loop||0)+1;var q=t.array(b.events);c=t.array(b.services);var s=b.update||{};if(E("verbose")){A("Iteration "+b.loop+" (main loop)");if(q.length){e=[];for(a in q)e.push(q[a].type);A(" -> Events: ",e)}if(c.length){e=[];for(a in c)e.push(c[a].service);A(" -> Services: ",e)}e=[];for(a in s)e.push(a);e.length&&A(" -> Update: ",e)}for(g in s)if(void 0===
C[g])r('The property "'+g+'" is not referenced.');else if(e=y(g,s[g])||!!b.force){for(a in P[g])F(P[g][a],{parameters:[i(),{property:g}]});for(a in S[g]||[])n[S[g][a]]=1}for(a in c||[])B(c[a].service,c[a].params);for(a in q){f=q[a];for(d in c=f.data||{},g=N[f.type]||[],g)void 0!==c[g[d]]&&(j=!0,p[g[d]]=c[g[d]]);for(h in O[f.type])F(O[f.type][h],{parameters:[i(),f]});for(d in M[f.type]||[]){c=F(M[f.type][d],{parameters:[f],scope:{request:!0,dispatchEvent:!0}});g=t.array(c.events);for(h in g)n[g[h].type]=
1;for(h in c.update)void 0===p[h]?(j=!0,p[h]=c.update[h]):r('The property "'+h+'" is not a method nor a property.');if((c.services||[]).length)j=!0,k=k.concat(c.services)}for(d in H[f.type]||[])n[H[f.type][d]]=1}for(f in n)G.dispatchEvent(f,i()),l.push(G.getEvent(f,i())),j=!0;j&&m({events:l,update:p,services:k,loop:b.loop})}function h(b){if(D[b]){if(da[b]){for(var a=[],d={},c=1,h=arguments.length;c<h;c++)a.push(arguments[c]);d[b]=J[b];a=F(D[b],{parameters:a,inputValues:d});return w(b)?t.clone(a.returned):
a.returned}return w(b)?t.clone(D[b]()):D[b]()}r('Property "'+b+'" not referenced.')}function y(b,a){if(C[b]){if(ca[b]){var d,c;d=[];c={};w(b)&&(a=t.clone(a));c[b]=h(b);for(var f=1,e=arguments.length;f<e;f++)d.push(arguments[f]);c=F(C[b],{parameters:d,inputValues:c});(d="boolean"!==l.get(c.returned)||c.returned)&&(J[b]=c.update[b]);return d}return C[b].call(i(),w(b)?t.clone(a):a)}r('Property "'+b+'" not referenced.');return!1}function B(b,a){if(T[b])T[b](a);else r('Service "'+b+'" not referenced.');
return this}function F(b,a){var d,c,f=a||{},h=i(f.scope);"function"!==l.get(b)&&n("The first parameter must be a function");for(d in f.inputValues||{})h[d]=f.inputValues[d];c={returned:b.apply(h,f.parameters||[]),update:{},events:[],services:[]};null!=h._events&&!l.check("array",h._events)?r("Events must be stored in an array."):c.events=h._events;for(d in h)void 0!==C[d]?c.update[d]=h[d]:void 0===X[d]&&r('The key "'+d+'" is not a method nor a property.');for(d in f.inputValues)c.update[d]=h[d];for(d in h._services)c.services[d]=
h._services[d];if(f.loop){f=(c.services||[]).length||(c.events||[]).length;if(!f)for(d in c.update)f=!0;f&&m(c)}else return c}function ka(b){return v[b]}function ja(b){return L[b]}function q(b){var a=b,d=(b||"").toString().match(RegExp("^"+E("shortcutPrefix")+"(\\w+)$"));d&&d.length&&(r("Prefix in expand() calls is deprecated."),a=d[1]);for(var d=1,c=arguments.length;d<c;d++)if(void 0!==(arguments[d]||{})[a])return arguments[d][a];if("function"===l.get(D[a]))return h(a);if("function"===l.get(V[a]))return V[a].call(i());
r('The shortcut "',a,'" has not been recognized.');return a}function w(b){b=(ba[b]||{}).clone;return void 0!==b?!!b:E("clone")}function Q(){var b;A('Killing instance "'+z+'"');for(b in U)U[b].removeEventListener();V=Z=T=H=M=P=O=S=N=U=ca=da=J=C=D=L=v=K=U=null;for(b in W)delete W[b];R[z]&&delete R[z]}function E(b,a){if("string"===typeof b&&1===arguments.length)return void 0!==$[b]?$[b]:I[b];var d="object"===typeof b&&1===arguments.length?b||{}:{};"string"===typeof b&&(d[b]=a);for(var c in d)void 0!==
d[c]?$[c]=d[c]:delete $[c];return this}function r(){var b=["["+(z||"domino")+"]"];E("strict")||b.push("WARNING");for(var a in arguments)b.push(arguments[a]);E("strict")?x.apply(this,b):E("verbose")&&aa.apply(this,b)}function n(){var b=["["+(z||"domino")+"]"],a;for(a in arguments)b.push(arguments[a]);x.apply(this,b)}function A(){var b=["["+(z||"domino")+"]"];if(E("verbose")){for(var a in arguments)b.push(arguments[a]);aa.apply(this,b)}}ga.call(this);var G=this,t=p.utils,l=p.struct,$={},W,K={},v={},
L={},D={},C={},J={},ba={},da={},ca={},U=[],N={},S={},O={},P={},M={},H={},T={},Z={},V={},X={events:1,services:1,hacks:1};(function(){for(var b in Object.prototype)X[b]=1;for(b in i({full:!0}))X[b]=1})();W=i({full:!0});var s={},z;"string"===l.get(a)?z=a:void 0!==a&&"object"===l.get(a)?s=a:void 0!==c&&"object"===l.get(c)&&(s=c);(z=s.name)&&(R[z]?n('An instance named "'+z+'" is already running.'):R[z]=W);(function(){for(var b in s.properties||[])f(s.properties[b].id,s.properties[b]);for(b in s.hacks||
[]){var a=void 0,d=void 0,c=s.hacks[b]||{};void 0===c.triggers&&n("A hack requires at least one trigger to be bound");a=t.array(c.triggers);for(d in a)H[a[d]]=H[a[d]]||[],M[a[d]]=M[a[d]]||[],c.method&&M[a[d]].push(c.method),c.dispatch&&(H[a[d]]=H[a[d]].concat(t.array(c.dispatch)))}for(b in s.services||[])j(s.services[b]);for(b in s.shortcuts||[])a=s.shortcuts[b].id,d=s.shortcuts[b].method,void 0===a&&n("Shortcut ID not specified."),V[a]&&n('Shortcut "'+a+'" already exists.'),void 0===d&&n("Shortcut method not specified."),
V[a]=d})();return W};var p=v.domino;p.utils={array:function(a,c){var i="string"===p.struct.get(a)?a.split(c||" "):"array"===p.struct.get(a)?a:[a],f=[],j;for(j in i)i[j]&&f.push(i[j]);return f},clone:function(a){if(!a)return a;var c,i;if("array"===w.get(a))for(i in c=[],a)c[i]=this.clone(a[i]);else if("date"===w.get(a))c=new Date(a.getTime());else if("object"===w.get(a))if(a.prototype)c=a;else{c={};for(var f in a)c[f]=this.clone(a[f])}else c=a;return c},ajax:function(a,c){"string"===typeof a?a={url:a,
ok:c}:"object"!==w.get(a)&&x("[domino.global] Invalid parameter given to AJAX");var i=a.type||"GET",f=a.url||"",j=a.contentType||"application/x-www-form-urlencoded",k=a.dataType||"json",e=new XMLHttpRequest,d,m,h;if(a.data){if("string"===typeof a.data)m=a.data;else if(/json/.test(j))m=JSON.stringify(a.data);else{m=[];for(h in a.data)m.push(encodeURIComponent(h)+"="+encodeURIComponent(a.data[h]));m=m.join("&")}/GET|DEL/i.test(i)&&(f+=/\?/.test(f)?"&"+m:"?"+m,m="")}e.onreadystatechange=function(){if(4==
e.readyState)if(d&&clearTimeout(d),/^2/.test(e.status)){m=e.responseText;if(/json/.test(k))try{m=JSON.parse(e.responseText)}catch(c){return a.error&&a.error("JSON parse error: "+c.message,e)}a.success&&a.success(m,e)}else{var f=+e.status?e.responseText:e.responseText.length?"Aborted: "+e.responseText:"Aborted";a.error&&a.error(f,e)}};e.open(i,f,!0);e.setRequestHeader("Content-Type",j);if(a.headers)for(h in a.headers)e.setRequestHeader(h,a.headers[h]);a.timeout&&(d=setTimeout(function(){e.onreadystatechange=
function(){};e.abort();a.error&&a.error&&a.error("timeout",e)},1E3*a.timeout));e.send(m);return e}};p.struct=function(){var a=["number","string","boolean","null","undefined"],c="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),i={},f=["*"],j={},k;for(k in c){var e=c[k];f.push(e.toLowerCase());i["[object "+e+"]"]=e.toLowerCase()}return{add:function(a,c,h){var e,i,k,w,v,q;1===arguments.length?"object"===this.get(a)?(q=a,k=q.id,v=q.struct):x("[domino.global] If struct.add is called with one arguments, it has to be an object"):
2===arguments.length?("string"!==this.get(a)||!a?x("[domino.global] If struct.add is called with more than one arguments, the first one must be the string id"):k=a,v=c):x("[domino.global] struct.add has to be called with one or three arguments");("string"!==this.get(k)||0===k.length)&&x("[domino.global] A structure requires an string id");void 0!==j[k]&&"proto"!==j[k]&&x('[domino.global] The structure "'+k+'" already exists');j[k]=1;i=p.utils.array((q||{}).proto);w={};for(e in i)void 0===j[i[e]]&&
(j[i[e]]=1,w[i[e]]=1);"function"!==this.get(v)&&!this.isValid(v)&&x('[domino.global] A structure requires a valid "structure" property describing the structure. It can be a valid structure or a function that test if an object matches the structure.');~f.indexOf(k)&&x('[domino.global] "'+k+'" is a reserved structure name');j[k]=void 0===q?{id:k,struct:v}:{};if(void 0!==q)for(e in q)j[k][e]=q[e];for(e in w)e!==k&&delete j[e]},get:function(a){return null==a?""+a:i[Object.prototype.toString.call(a)]||
"object"},check:function(a,c){var h,e,i=this.get(c);if("string"===this.get(a)){h=a.replace(/^\?/,"").split(/\|/);for(e in h)if(0>f.indexOf(h[e])&&void 0===j[h[e]])return ea("[domino.global] Invalid type"),!1;if(null==c)return!!a.match(/^\?/,"");a.replace(/^\?/,"");for(e in h)if(j[h[e]]&&("function"===this.get(j[h[e]].struct)&&!0===j[h[e]].struct(c)||this.check(j[h[e]].struct,c)))return!0;return!(!~h.indexOf("*")&&!~h.indexOf(i))}if("object"===this.get(a)){if("object"!==i)return!1;for(h in a)if(!this.check(a[h],
c[h]))return!1;for(h in c)if(void 0===a[h])return!1;return!0}if("array"===this.get(a)){if("array"!==i)return!1;if(1!==a.length)return ea("[domino.global] Invalid type"),!1;for(h in c)if(!this.check(a[0],c[h]))return!1;return!0}return!1},deepScalar:function(d){var c;if("string"===this.get(d)){d=d.replace(/^\?/,"").split(/\|/);for(c in d)if(0>a.indexOf(d[c]))return!1;return!0}if(this.check("object|array",d)){for(c in d)if(!this.deepScalar(d[c]))return!1;return!0}return!1},compare:function(a,c,e){this.get(a);
this.get(c);var f;if(!this.deepScalar(e)||!this.check(e,a)||!this.check(e,c))return!1;if("string"===this.get(e))return a===c;if("object"===this.get(e)){for(f in e)if(!this.compare(a[f],c[f],e[f]))return!1;return!0}if("array"===this.get(e)){if(a.length!==c.length)return!1;var i=a.length;for(f=0;f<i;f++)if(!this.compare(a[f],c[f],e[0]))return!1;return!0}return!1},isValid:function(a){var c,e;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(e in a)if(0>f.indexOf(a[e])&&void 0===j[a[e]])return!1;
return!0}if("object"===this.get(a)){for(c in a)if(!this.isValid(a[c]))return!1;return!0}return"array"===this.get(a)?1===a.length?this.isValid(a[0]):!1:!1}}}();var Q=p.utils,w=p.struct,I={strict:!1,verbose:!1,shortcutPrefix:":",displayTime:!1,clone:!1};p.settings=function(a,c){if("string"===typeof a&&1===arguments.length)return I[a];var i="object"===typeof a&&1===arguments.length?a||{}:{};"string"===typeof a&&(i[a]=c);for(var f in i)void 0!==i[f]?I[f]=i[f]:delete I[f];return this};p.instances=function(a){if(arguments.length)return R[a];
x("[domino.global] You need to indicate a name to get the instance.")};p.EventDispatcher=function(){var a={};this.removeEventListener=function(c,i){if(!arguments.length)return this._handlers_={},this;var f,j,k,e,d=Q.array(c);if(i)for(f in d){e=d[f];if(a[e]){k=[];for(j in a[e])a[e][j].handler!==i&&k.push(a[e][j]);a[e]=k}a[e]&&0===a[e].length&&delete a[e]}else for(f in d)delete a[d[f]];return this};this.addEventListener=function(c,i){if(arguments.length)if(1===arguments.length&&"object"===Q.type.get(arguments[0]))for(c in arguments[0])this.addEventListener(c,
arguments[0][c]);else if(1<arguments.length){var f,c=arguments[0],i=arguments[1],j=Q.array(c),k;for(k in j)f=j[k],a[f]||(a[f]=[]),a[f].push({handler:i})}return this};this.dispatchEvent=function(c,i){var f,j,k,e,d,m=Q.array(c),i=void 0===i?{}:i;for(f in m)if(d=m[f],a[d]){e=this.getEvent(d,i);k=[];for(j in a[d])a[d][j].handler(e),a[d][j].one||k.push(a[d][j]);a[d]=k}return this};this.getEvent=function(a,i){return{type:a,data:i,target:this}}};var ga=p.EventDispatcher;p.module=function(){ga.call(this);
this.triggers={properties:{},events:{}}}})(window);
