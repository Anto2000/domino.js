/* domino.js - a JS fast dashboard prototyping framwork - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(y){function E(){w.strict?J.apply(this,arguments):K.apply(this,arguments)}function J(){var a="",b;for(b in arguments)a+=arguments[b];throw Error(a);}function K(){w.verbose&&console.log.apply(console,arguments)}if(y.domino)throw Error("domino already exists");y.domino=function(a,b){function f(a,o){var i,e=o||{};void 0===a&&j.die("Property name not specified");void 0!==F[a]&&j.die('Property "'+a+'" already exists');y[a]=e.label||a;void 0!==e.type&&(!m.isValid(e.type)?j.warn('Property "'+a+
'": Type not valid'):u[a]=e.type);void 0!==e.setter&&("function"!==!m.get(e.setter)?j.warn('Property "'+a+'": Setter is not a function'):v[a]=e.setter);v[a]=v[a]||function(i){if(i===F[a])return!1;u[a]&&!m.check(u[a],i)?j.warn('Property "'+a+'": Wrong type error'):F[a]=i;return!0};void 0!==e.getter&&("function"!==!m.get(e.getter)?j.warn('Property "'+a+'": Getter is not a function'):x[a]=e.getter);x[a]=x[a]||function(){return F[a]};if(void 0!==e.value||u[a])void 0!==e.value?h(a,e.value):j.warn('Property "'+
a+'": Initial value is missing');if(void 0!==e.triggers)for(i in!m.check("array|string",e.triggers)&&j.warn('Property "'+a+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),A[a]=t.array(e.triggers),A[a]||[])C[A[a][i]]=C[A[a][i]]||[],C[A[a][i]].push(a);void 0!==e.dispatch&&(!m.check("array|string",e.dispatch)?j.warn('Property "'+a+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):r[a]=t.array(e.dispatch))}function c(a){var o=
a||{};(void 0===o.id||"string"!==m.get(o.id))&&j.die("The service id is not indicated.");m.check("function|string",o.url)||j.die("The service URL is not valid.");void 0!==G[o.id]&&j.die('The service "'+o.id+'" already exists.');G[o.id]=function(a){for(var e=a||{},a={contentType:e.contentType||o.contentType,dataType:e.dataType||o.dataType,type:(e.type||o.type||"GET").toString().toUpperCase(),data:"function"===m.get(o.data)?o.data.apply(s,e.data||[]):e.data||o.data,url:o.url,error:e.error||o.error||
function(a){j.die('Loading failed with message "'+a+'".')}},d,z,b,f=w.shortcutPrefix,l=RegExp(f+"(\\w+)","g"),f=RegExp("^"+f+"(\\w+)$"),c=null,g;(g=a.url.match(l))&&a.url!==c;)for(d in c=a.url,g)z=n(g[d],e.params),a.url=a.url.replace(RegExp(g[d],"g"),z);d=!0;"string"===m.get(a.data)&&a.data.match(f)&&(a.data=n(a.data,e.params));if("object"===m.get(a.data))for(;d;)for(b in d=!1,a.data)"string"===m.get(a.data[b])&&a.data[b].match(f)&&(a.data[b]=n(a.data[b],e.params),d=!0);a.success=function(a){var i,
d,z,f={};d=e.path||o.path;var l,c=e.setter||o.setter,g=e.success||o.success;"string"===m.get(c)&&(c=n(c,e.params));"string"===m.get(g)&&(g=n(g,e.params));"string"===m.get(d)&&(d=n(d,e.params));if(l=m.get(d,"string")?d.split("."):void 0)for(i in l)a=a[l[i]],void 0===a&&j.warn('Wrong path "'+d+'" for service "'+o.id+'".');d=t.array(o.events);for(i in d)f[d[i]]=1;d=t.array(e.events);for(i in d)f[d[i]]=1;if("string"===m.get(g)&&v[g])if(h(g,a))for(b in r[g]||[])f[r[g][b]]=1;else if(c&&v[c]&&h(c,a))for(b in r[c]||
[])f[r[c][b]]=1;"function"===m.get(g)&&g.call(D,a,e);d=[];for(z in f)j.dispatchEvent(z,s),d.push(j.getEvent(z,s));d.length&&k(d)};t.ajax(a)}}function k(a,d){var i,e,b,f,c,g,l,m=[],n=d||{},p={};n.loop=(n.loop||0)+1;var q=t.array(a);for(e in q){c=q[e];g=c.data||{};m.push(c.type);if(g||n.force)for(b in i=C[c.type]||[],i)if(l=!!n.force,void 0!==g[i[b]]&&(l=h(i[b],g[i[b]])||l),l)for(f in r[i[b]]||[])p[r[i[b]][f]]=1;for(b in B[c.type]||[])B[c.type][b].call(D,c);for(b in H[c.type]||[])p[H[c.type][b]]=1}j.dump("Main loop "+
n.loop+":",m);i=[];for(c in p)j.dispatchEvent(c,s),i.push(j.getEvent(c,s));i.length&&k(i,n)}function d(a){if(x[a])return x[a].call(s);j.warn('Property "'+a+'" not referenced.')}function h(a,d){if(v[a])return v[a].call(D,d);j.warn('Property "'+a+'" not referenced.');return!1}function l(a){return y[a]}function g(a){return A[a]}function n(a){var b=arguments.length,i=(a||"").toString().match(RegExp("^"+w.shortcutPrefix+"(\\w+)$"));if(!i||!i.length)return a;i=i[1];if("function"===m.get(I[i]))return I[i].call(D);
if("function"===m.get(x[i]))return d(i);for(var e=1;e<b;e++)if(void 0!==(arguments[e]||{})[i])return arguments[e][i];return a}L.call(this);var j=this,t=p.utils,m=t.type,u={},y={},A={},x={},v={},F={},E=[],C={},r={},B={},H={},G={},I={},s={get:d,events:g,label:l,dump:j.dump,expand:n},D={get:d,set:h,events:g,label:l,dump:j.dump,warn:j.warn,die:j.die,update:function(a){var d,b,e,c=[],a=a||{},f={};for(b in a)if(c.push(b),v[b]&&h(b,a[b]))for(d in r[b]||[])f[r[b][d]]=1;j.dump("Updating properties :",c);d=
[];for(e in f)j.dispatchEvent(e,s),d.push(j.getEvent(e,s));d.length&&k(d,a)},expand:n,call:function(a,d){if(G[a])return G[a](d);j.warn('Service "'+a+'" not referenced.');return!1},addModule:function(a,b){var c,e={},f,g,h;void 0===a&&j.die("Module class not specified.");"function"!==m.get(a)&&j.die("First parameter must be a function.");a.apply(e,(b||[]).concat(s));f=e.triggers||{};for(h in f.events||{})j.addEventListener(h,f.events[h]);for(g in f.properties||{}){for(c in r[g]||[])j.addEventListener(r[g][c],
f.properties[g]);void 0!==x[g]&&(d(g),f.properties[g](j.getEvent("domino.initialUpdate",s)))}for(h in C||{})e.addEventListener(h,k);for(h in B||{})e.addEventListener(h,k);E.push(e);return e}},q={};this.name="domino";"string"===m.get(a)?this.name=a:void 0!==a&&"object"===m.get(a)?q=a:void 0!==b&&"object"===m.get(b)&&(q=b);this.name=q.name||this.name;(function(){for(var a in q.properties||[])f(q.properties[a].id,q.properties[a]);for(a in q.hacks||[]){var d=void 0,b=void 0,e=q.hacks[a]||{};void 0===
e.triggers&&j.die("A hack requires at least one trigger to be added");d=t.array(e.triggers);for(b in d)e.method&&(B[d[b]]=B[d[b]]||[],B[d[b]].push(e.method)),e.dispatch&&(H[d[b]]=(H[d[b]]||[]).concat(t.array(e.dispatch)))}for(a in q.services||[])c(q.services[a]);for(a in q.shortcuts||[])d=q.shortcuts[a]||{},void 0===d.id&&j.die("Shortcut ID not specified."),I[d.id]&&j.die('Shortcut "'+d.id+'" already exists.'),I[d.id]=d.method})();return D};var p=y.domino;p.prototype.warn=function(a){var b=["["+this.name+
"]"],f;for(f in arguments)b.push(arguments[f]);E.apply(this,b)};p.prototype.die=function(a){var b=["["+this.name+"]"],f;for(f in arguments)b.push(arguments[f]);J.apply(this,b)};p.prototype.dump=function(){var a=["["+this.name+"]"],b;for(b in arguments)a.push(arguments[b]);K.apply(this,a)};p.utils={array:function(a,b){var f="string"===p.utils.type.get(a)?a.split(b||" "):"array"===p.utils.type.get(a)?a:[a],c=[],k;for(k in f)f[k]&&c.push(f[k]);return c},ajax:function(a,b){"string"===typeof a&&(a={url:a,
ok:b});var f=a.type||"GET",c=a.url||"",k=a.contentType||"application/x-www-form-urlencoded",d=a.dataType||"json",h=new XMLHttpRequest,l,g,n;if(a.data){if("string"===typeof a.data)g=a.data;else if(/json/.test(k))g=JSON.stringify(a.data);else{g=[];for(n in a.data)g.push(encodeURIComponent(n)+"="+encodeURIComponent(a.data[n]));g=g.join("&")}/GET|DEL/i.test(f)&&(c+=/\?/.test(c)?"&"+g:"?"+g,g="")}h.onreadystatechange=function(){if(4==h.readyState)if(l&&clearTimeout(l),/^2/.test(h.status)){g=h.responseText;
if(/json/.test(d))try{g=JSON.parse(h.responseText)}catch(b){return a.error&&a.error("JSON parse error: "+b.message,h)}a.success&&a.success(g,h)}else a.error&&a.error(h.responseText,h)};h.open(f,c,!0);h.setRequestHeader("Content-Type",k);if(a.headers)for(n in a.headers)h.setRequestHeader(n,a.headers[n]);a.timeout&&(l=setTimeout(function(){h.onreadystatechange=function(){};h.abort();a.error&&a.error&&a.error("timeout",h)},1E3*a.timeout));h.send(g);return h},type:function(){var a="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),
b={},f=["*"],c;for(c in a){var k=a[c];f.push(k.toLowerCase());b["[object "+k+"]"]=k.toLowerCase()}return{get:function(a){return null==a?""+a:b[Object.prototype.toString.call(a)]||"object"},check:function(a,b){var c,g,k=this.get(b);if("string"===this.get(a)){c=a.replace(/^\?/,"").split(/\|/);for(g in c)0>f.indexOf(c[g])&&E("[domino.global] Invalid type");if(null==b)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");g=a.split(/\|/);return!(!~g.indexOf("*")&&!~g.indexOf(k))}if("object"===this.get(a)){if("object"!==
k)return!1;for(c in a)if(!this.check(a[c],b[c]))return!1;for(c in b)if(void 0===a[c])return!1;return!0}return!1},isValid:function(a){var b,c;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(c in a)if(0>f.indexOf(a[c]))return!1;return!0}if("object"===this.get(a)){for(b in a)if(!this.isValid(a[b]))return!1;return!0}return!1}}}()};var u=p.utils,w={strict:!1,verbose:!1,shortcutPrefix:":"};p.settings=function(a,b){if("string"===typeof a&&void 0===b)return w[a];var f="object"===typeof a&&
void 0===b?a||{}:{};"string"===typeof a&&(f[a]=b);for(var c in f)void 0!==w[c]&&(w[c]=f[c]);return this};p.EventDispatcher=function(){var a={};this.removeEventListener=function(b,f){if(!arguments.length)return this._handlers_={},this;var c,k,d,h,l=u.array(b);if(f)for(c in l){h=l[c];if(a[h]){d=[];for(k in a[h])a[h][k].handler!==f&&d.push(a[h][k]);a[h]=d}a[h]&&0===a[h].length&&delete a[h]}else for(c in l)delete a[l[c]];return this};this.addEventListener=function(b,f){if(arguments.length)if(1===arguments.length&&
"object"===u.type.get(arguments[0]))for(b in arguments[0])this.addEventListener(b,arguments[0][b]);else if(1<arguments.length){var c,b=arguments[0],f=arguments[1],k=u.array(b),d;for(d in k)c=k[d],a[c]||(a[c]=[]),a[c].push({handler:f})}return this};this.dispatchEvent=function(b,f){var c,k,d,h,l,g=u.array(b),f=void 0===f?{}:f;for(c in g)if(l=g[c],a[l]){h=this.getEvent(l,f);d=[];for(k in a[l])a[l][k].handler(h),a[l][k].one||d.push(a[l][k]);a[l]=d}return this};this.getEvent=function(a,f){return{type:a,
data:f,target:this}}};var L=p.EventDispatcher;p.module=function(){L.call(this);this.triggers={properties:{},events:{}}}})(window);
