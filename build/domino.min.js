/* domino.js - a JS fast dashboard prototyping framework - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(J){function W(){p.strict?T.apply(this,arguments):X.apply(this,arguments)}function T(){var a="",c;for(c in arguments)a+=(a?" ":"")+arguments[c];throw Error(a);}function X(){if(p.verbose){var a=[],c;for(c in arguments)a.push(arguments[c]);p.displayTime&&a.unshift(("00000000"+((new Date).getTime()-U)).substr(-8));console.log.apply(console,a)}}var U=new Date;if(J.domino)throw Error("domino already exists");J.domino=function(a,c){function g(b){var b=b||{},h={getEvents:J,getLabel:I,expand:D,warn:s,
log:y,die:m,get:o};b.full?(h.update=d,h.addModule=n,h.request=C,h.dispatchEvent=function(b,h){j({events:v.getEvent(b,h)})}):(b.request&&(h.request=function(b,h){this.services=this.services||[];this.services.push({service:b,params:h})}),b.dispatchEvent&&(h.dispatchEvent=function(b,h){this.events=this.events||[];this.events.push({type:b,data:h})}));return h}function e(b,h){var a,l=h||{};void 0===b&&m("Property name not specified");void 0!==E[b]&&m('Property "'+b+'" already exists');void 0!==O[b]&&m('"'+
b+'" can not be used to name a property');Y[b]=l.label||b;void 0!==l.type&&(i.isValid(l.type)?F[b]=l.type:s('Property "'+b+'": Type not valid'));void 0!==l.setter&&("function"!==i.get(l.setter)?s('Property "'+b+'": Setter is not a function'):(A[b]=l.setter,Z[b]=!0));A[b]=A[b]||function(h){if(i.deepScalar(F[b])&&i.compare(h,E[b],F[b]))return!1;F[b]&&!i.check(F[b],h)?s('Property "'+b+'": Wrong type error'):E[b]=h;return!0};void 0!==l.getter&&("function"!==i.get(l.getter)?s('Property "'+b+'": Getter is not a function'):
(w[b]=l.getter,$[b]=!0));w[b]=w[b]||function(){return E[b]};if(void 0!==l.value||F[b])void 0!==l.value?aa(b,l.value):y('Property "'+b+'": Initial value is missing');if(void 0!==l.triggers)for(a in!i.check("array|string",l.triggers)&&s('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),G[b]=u.array(l.triggers),G[b]||[])K[G[b][a]]=K[G[b][a]]||[],K[G[b][a]].push(b);void 0!==l.dispatch&&(!i.check("array|string",l.dispatch)?s('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):
P[b]=u.array(l.dispatch));return v}function k(b){var h=b||{};(void 0===h.id||"string"!==i.get(h.id))&&m("The service id is not indicated.");i.check("function|string",h.url)||m("The service URL is not valid.");void 0!==Q[h.id]&&m('The service "'+h.id+'" already exists.');Q[h.id]=function(b){y('Calling service "'+h.id+'".');var a=b||{},d=a.shortcuts||{},b={contentType:a.contentType||h.contentType,dataType:a.dataType||h.dataType,type:(a.type||h.type||"GET").toString().toUpperCase(),data:"function"===
i.get(h.data)?h.data.call(g(),a):void 0!=a.data?a.data:h.data,url:"function"===i.get(h.url)?h.url.call(g(),a):h.url,error:function(b,d){v.dispatchEvent("domino.ajaxFailed");var z=a.error||h.error;"function"===i.get(z)?B(z,{parameters:[b,d,a],loop:!0,scope:{request:!0,dispatchEvent:!0}}):y('Loading service "'+h.id+'" failed with message "'+b+'" and status '+d.status+".")}},q,c,x;c=p.shortcutPrefix;var f=RegExp(c+"(\\w+)","g"),e=RegExp("^"+c+"(\\w+)$"),k=null,o;for("string"!==i.get(b.url)&&m('The URL is no more a string (typed "'+
i.get(b.url)+'")');(o=b.url.match(f))&&b.url!==k;)for(q in k=b.url,o)c=D(o[q].match(e)[1],d),b.url=b.url.replace(RegExp(o[q],"g"),c);q=!0;"string"===i.get(b.data)&&b.data.match(e)&&(b.data=D(b.data.match(e)[1],d));if("object"===i.get(b.data))for(;q;)for(x in q=!1,b.data)"string"===i.get(b.data[x])&&b.data[x].match(e)&&(b.data[x]=D(b.data[x].match(e)[1],d),q=!0);b.success=function(b){y('Service "'+h.id+'" successfull.');var z,c,q,f,o={},k=[];f=[];var R={},n=!1,m=a.path||h.path,p=a.setter||h.setter,
r=a.success||h.success;"string"===i.get(p)&&p.match(e)&&(p=D(p.match(e)[1],d));"string"===i.get(m)&&m.match(e)&&(m=D(m.match(e)[1],d));f=b;(m||"").match(/^(?:\w+\.)*\w+$/)?c=i.get(m,"string")?m.split("."):void 0:"string"===i.get(m)&&s('Path "'+m+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(c)for(z in c)f=f[c[z]],void 0===f&&s('Wrong path "'+m+'" for service "'+h.id+'".');c=u.array(h.events);for(z in c)o[c[z]]=1,n=!0;c=u.array(a.events);for(z in c)o[c[z]]=1,n=!0;p&&A[p]&&void 0!==f&&(R[p]=f,
n=!0);if("function"===i.get(r)){b=B(r,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});c=u.array(b.events);for(x in c)n=!0,o[c[x].type]=1;for(x in b.update)void 0===R[x]?(R[x]=b.update[x],n=!0):s('The key "'+x+'" is nor a method neither a property.');if((b.services||[]).length)n=!0,k=k.concat(b.services)}f=[];for(q in o)v.dispatchEvent(q,g()),f.push(v.getEvent(q,g()));n&&j({events:f,update:R,services:k})};q=a.before||h.before;null!=q&&"function"===i.get(q)&&B(q,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});
a.abort&&V[h.id]&&V[h.id].abort();V[h.id]=u.ajax(b)};return v}function n(b,a){var d,l={},c={},q,j,e;void 0===b&&m("Module class not specified.");"function"!==i.get(b)&&m("First parameter must be a function.");b.apply(l,(a||[]).concat(g()));q=l.triggers||{};for(e in q.events||{})L[e]=L[e]||[],L[e].push(q.events[e]);for(j in q.properties||{}){for(d in P[j]||[])M[j]=M[j]||[],M[j].push(q.properties[j]);void 0!==w[j]&&(o(j),B(q.properties[j],{parameters:[g()]}))}for(e in K||{})c[e]=1;for(e in H||{})c[e]=
1;for(e in N||{})c[e]=1;for(e in c)l.addEventListener(e,f);U.push(l);return l}function d(b){j({update:b});return this}function f(b){j({events:[b]})}function j(b){var a,d,l,c,e,f,i,o=!1,k=[],m=[],b=b||{},n={},r={};b.loop=(+b.loop||0)+1;var t=u.array(b.events);f=u.array(b.services);var w=b.update||{};if(p.verbose){y("Iteration "+b.loop+" (main loop)");if(t.length){i=[];for(d in t)i.push(t[d].type);y(" -> Events: ",i)}if(f.length){i=[];for(d in f)i.push(f[d].service);y(" -> Services: ",i)}i=[];for(d in w)i.push(d);
i.length&&y(" -> Update: ",i)}for(a in w)if(void 0===A[a])s('The property "'+a+'" is not referenced.');else if(i=aa(a,w[a])||!!b.force){for(d in M[a])B(M[a][d],{parameters:[g({request:!0,dispatchEvent:!0}),{property:a}]});for(d in P[a]||[])n[P[a][d]]=1}for(d in f||[])C(f[d].service,f[d].params);for(d in t){e=t[d];for(l in f=e.data||{},a=K[e.type]||[],a)void 0!==f[a[l]]&&(o=!0,r[a[l]]=f[a[l]]);for(c in L[e.type])B(L[e.type][c],{parameters:[g({request:!0,dispatchEvent:!0}),e]});for(l in H[e.type]||
[]){f=B(H[e.type][l],{parameters:[e],scope:{request:!0,dispatchEvent:!0}});a=u.array(f.events);for(c in a)n[a[c].type]=1;for(c in f.update)void 0===r[c]?(o=!0,r[c]=f.update[c]):s('The property "'+c+'" is not a method nor a property.');if((f.services||[]).length)o=!0,m=m.concat(f.services)}for(l in N[e.type]||[])n[N[e.type][l]]=1}for(e in n)v.dispatchEvent(e,g()),k.push(v.getEvent(e,g())),o=!0;o&&j({events:k,update:r,services:m,loop:b.loop})}function o(b){if(w[b]){if($[b]){for(var a=[],d={},c=1,e=
arguments.length;c<e;c++)a.push(arguments[c]);d[b]=E[b];a=B(w[b],{parameters:a,inputValues:d});return p.clone?u.clone(a.returned):a.returned}return p.clone?u.clone(w[b]()):w[b]()}s('Property "'+b+'" not referenced.')}function aa(b,a){if(A[b]){if(Z[b]){var d,c;d=[];c={};p.clone&&(a=u.clone(a));c[b]=o(b);for(var e=1,f=arguments.length;e<f;e++)d.push(arguments[e]);c=B(A[b],{parameters:d,inputValues:c});(d="boolean"!==i.get(c.returned)||c.returned)&&(E[b]=c.update[b]);return d}return A[b].call(g(),p.clone?
u.clone(a):a)}s('Property "'+b+'" not referenced.');return!1}function C(b,a){if(Q[b])Q[b](a);else s('Service "'+b+'" not referenced.');return this}function B(b,a){var d,c,e=a||{},f=g(e.scope);"function"!==i.get(b)&&m("The first parameter must be a function");for(d in e.inputValues||{})f[d]=e.inputValues[d];c={returned:b.apply(f,e.parameters||[]),update:{},events:[],services:[]};null!=f.events&&!i.check("array",f.events)?s("Events must be stored in an array."):c.events=f.events;for(d in f)void 0!==
A[d]?c.update[d]=f[d]:void 0===O[d]&&s('The key "'+d+'" is not a method nor a property.');for(d in e.inputValues)c.update[d]=f[d];for(d in f.services)c.services[d]=f.services[d];if(e.loop){e=(c.services||[]).length||(c.events||[]).length;if(!e)for(d in c.update)e=!0;e&&j(c)}else return c}function I(b){return Y[b]}function J(b){return G[b]}function D(b){var a=b,d=arguments.length,c=(b||"").toString().match(RegExp("^"+p.shortcutPrefix+"(\\w+)$"));c&&c.length&&(s("Prefix in expand() calls is deprecated."),
a=c[1]);if("function"===i.get(S[a]))return S[a].call(g());if("function"===i.get(w[a]))return o(a);for(c=1;c<d;c++)if(void 0!==(arguments[c]||{})[a])return arguments[c][a];if(p.strict)m('The shortcut "',a,'" has not been recognized.');else return a}function s(){var b=["["+v.name+"]"];p.strict||b.push("WARNING");for(var a in arguments)b.push(arguments[a]);W.apply(v,b)}function m(){var b=["["+v.name+"]"],a;for(a in arguments)b.push(arguments[a]);T.apply(v,b)}function y(){var a=["["+v.name+"]"],d;for(d in arguments)a.push(arguments[d]);
X.apply(v,a)}ba.call(this);var v=this,u=t.utils,i=t.struct,F={},Y={},G={},w={},A={},E={},$={},Z={},U=[],K={},P={},L={},M={},H={},N={},Q={},V={},S={},O={events:1,services:1,hacks:1};(function(){for(var a in Object.prototype)O[a]=1;for(a in g({full:!0}))O[a]=1})();var r={};this.name="domino";"string"===i.get(a)?this.name=a:void 0!==a&&"object"===i.get(a)?r=a:void 0!==c&&"object"===i.get(c)&&(r=c);this.name=r.name||this.name;(function(){for(var a in r.properties||[])e(r.properties[a].id,r.properties[a]);
for(a in r.hacks||[]){var d=void 0,c=void 0,f=r.hacks[a]||{};void 0===f.triggers&&m("A hack requires at least one trigger to be added");void 0===f.method&&void 0===f.dispatch&&m('A hack requires at least a method or a "dispatch" value to be added');d=u.array(f.triggers);for(c in d)f.method&&(H[d[c]]=H[d[c]]||[],H[d[c]].push(f.method)),f.dispatch&&(N[d[c]]=(N[d[c]]||[]).concat(u.array(f.dispatch)))}for(a in r.services||[])k(r.services[a]);for(a in r.shortcuts||[])d=r.shortcuts[a].id,c=r.shortcuts[a].method,
void 0===d&&m("Shortcut ID not specified."),S[d]&&m('Shortcut "'+d+'" already exists.'),void 0===c&&m("Shortcut method not specified."),S[d]=c})();return g({full:!0})};var t=J.domino;t.utils={array:function(a,c){var g="string"===t.struct.get(a)?a.split(c||" "):"array"===t.struct.get(a)?a:[a],e=[],k;for(k in g)g[k]&&e.push(g[k]);return e},clone:function(a){if(!a)return a;var c,g;if("array"===C.get(a))for(g in c=[],a)c[g]=this.clone(a[g]);else if("date"===C.get(a))c=new Date(a.getTime());else if("object"===
C.get(a))if(a.prototype)c=a;else{c={};for(var e in a)c[e]=this.clone(a[e])}else c=a;return c},ajax:function(a,c){"string"===typeof a?a={url:a,ok:c}:"object"!==C.get(a)&&T("[domino.global] Invalid parameter given to AJAX");var g=a.type||"GET",e=a.url||"",k=a.contentType||"application/x-www-form-urlencoded",n=a.dataType||"json",d=new XMLHttpRequest,f,j,o;if(a.data){if("string"===typeof a.data)j=a.data;else if(/json/.test(k))j=JSON.stringify(a.data);else{j=[];for(o in a.data)j.push(encodeURIComponent(o)+
"="+encodeURIComponent(a.data[o]));j=j.join("&")}/GET|DEL/i.test(g)&&(e+=/\?/.test(e)?"&"+j:"?"+j,j="")}d.onreadystatechange=function(){if(4==d.readyState)if(f&&clearTimeout(f),/^2/.test(d.status)){j=d.responseText;if(/json/.test(n))try{j=JSON.parse(d.responseText)}catch(c){return a.error&&a.error("JSON parse error: "+c.message,d)}a.success&&a.success(j,d)}else{var e=+d.status?d.responseText:d.responseText.length?"Aborted: "+d.responseText:"Aborted";a.error&&a.error(e,d)}};d.open(g,e,!0);d.setRequestHeader("Content-Type",
k);if(a.headers)for(o in a.headers)d.setRequestHeader(o,a.headers[o]);a.timeout&&(f=setTimeout(function(){d.onreadystatechange=function(){};d.abort();a.error&&a.error&&a.error("timeout",d)},1E3*a.timeout));d.send(j);return d}};t.struct=function(){var a=["number","string","boolean","null","undefined"],c="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),g={},e=["*"],k;for(k in c){var n=c[k];e.push(n.toLowerCase());g["[object "+n+"]"]=n.toLowerCase()}return{get:function(a){return null==
a?""+a:g[Object.prototype.toString.call(a)]||"object"},check:function(a,c){var j,g,k=this.get(c);if("string"===this.get(a)){j=a.replace(/^\?/,"").split(/\|/);for(g in j)0>e.indexOf(j[g])&&W("[domino.global] Invalid type");if(null==c)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");g=a.split(/\|/);return!(!~g.indexOf("*")&&!~g.indexOf(k))}if("object"===this.get(a)){if("object"!==k)return!1;for(j in a)if(!this.check(a[j],c[j]))return!1;for(j in c)if(void 0===a[j])return!1;return!0}return!1},deepScalar:function(d){var c;
if("string"===this.get(d)){d=d.replace(/^\?/,"").split(/\|/);for(c in d)if(0>a.indexOf(d[c]))return!1;return!0}if("object"===this.get(d)){for(c in d)if(!this.deepScalar(d[c]))return!1;return!0}return!1},compare:function(a,c,e){this.get(a);this.get(c);var g;if(!this.deepScalar(e)||!this.check(e,a)||!this.check(e,c))return!1;if("string"===this.get(e))return a===c;if("object"===this.get(e)){for(g in e)if(!this.compare(a[g],c[g],e[g]))return!1;return!0}return!1},isValid:function(a){var c,g;if("string"===
this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(g in a)if(0>e.indexOf(a[g]))return!1;return!0}if("object"===this.get(a)){for(c in a)if(!this.isValid(a[c]))return!1;return!0}return!1}}}();var I=t.utils,C=t.struct,p={strict:!1,verbose:!1,shortcutPrefix:":",displayTime:!1,clone:!0};t.settings=function(a,c){if("string"===typeof a&&void 0===c)return p[a];var g="object"===typeof a&&void 0===c?a||{}:{};"string"===typeof a&&(g[a]=c);for(var e in g)void 0!==p[e]&&(p[e]=g[e]);return this};t.EventDispatcher=
function(){var a={};this.removeEventListener=function(c,g){if(!arguments.length)return this._handlers_={},this;var e,k,n,d,f=I.array(c);if(g)for(e in f){d=f[e];if(a[d]){n=[];for(k in a[d])a[d][k].handler!==g&&n.push(a[d][k]);a[d]=n}a[d]&&0===a[d].length&&delete a[d]}else for(e in f)delete a[f[e]];return this};this.addEventListener=function(c,g){if(arguments.length)if(1===arguments.length&&"object"===I.type.get(arguments[0]))for(c in arguments[0])this.addEventListener(c,arguments[0][c]);else if(1<
arguments.length){var e,c=arguments[0],g=arguments[1],k=I.array(c),n;for(n in k)e=k[n],a[e]||(a[e]=[]),a[e].push({handler:g})}return this};this.dispatchEvent=function(c,g){var e,k,n,d,f,j=I.array(c),g=void 0===g?{}:g;for(e in j)if(f=j[e],a[f]){d=this.getEvent(f,g);n=[];for(k in a[f])a[f][k].handler(d),a[f][k].one||n.push(a[f][k]);a[f]=n}return this};this.getEvent=function(a,g){return{type:a,data:g,target:this}}};var ba=t.EventDispatcher;t.module=function(){ba.call(this);this.triggers={properties:{},
events:{}}}})(window);
