/* domino.js - a JS fast dashboard prototyping framwork - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(z){function F(){x.strict?G.apply(this,arguments):H.apply(this,arguments)}function G(){var a="",d;for(d in arguments)a+=arguments[d];throw Error(a);}function H(){x.verbose&&console.log.apply(console,arguments)}if(z.domino)throw Error("domino already exists");z.domino=function(a,d){function i(){return{get:p,events:F,label:z,dump:h.dump,warn:h.warn,die:h.die,expand:y}}function l(){return{get:p,set:A,events:F,label:z,dump:h.dump,warn:h.warn,die:h.die,update:g,expand:y,call:E,addModule:c}}function j(b,
a){var e,k=a||{};void 0===b&&h.die("Property name not specified");void 0!==I[b]&&h.die('Property "'+b+'" already exists');void 0!==N[b]&&h.die('"'+b+'" can not be used to name a property');G[b]=k.label||b;void 0!==k.type&&(m.isValid(k.type)?O[b]=k.type:h.warn('Property "'+b+'": Type not valid'));void 0!==k.setter&&("function"!==m.get(k.setter)?h.warn('Property "'+b+'": Setter is not a function'):(t[b]=k.setter,S[b]=!0));t[b]=t[b]||function(e){if(e===I[b])return!1;O[b]&&!m.check(O[b],e)?h.warn('Property "'+
b+'": Wrong type error'):I[b]=e;return!0};void 0!==k.getter&&("function"!==!m.get(k.getter)?h.warn('Property "'+b+'": Getter is not a function'):(w[b]=k.getter,H[b]=!0));w[b]=w[b]||function(){return I[b]};if(void 0!==k.value||O[b])void 0!==k.value?A(b,k.value):h.warn('Property "'+b+'": Initial value is missing');if(void 0!==k.triggers)for(e in!m.check("array|string",k.triggers)&&h.warn('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),B[b]=r.array(k.triggers),
B[b]||[])K[B[b][e]]=K[B[b][e]]||[],K[B[b][e]].push(b);void 0!==k.dispatch&&(!m.check("array|string",k.dispatch)?h.warn('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):s[b]=r.array(k.dispatch));return h}function f(b){var a=b||{};(void 0===a.id||"string"!==m.get(a.id))&&h.die("The service id is not indicated.");m.check("function|string",a.url)||h.die("The service URL is not valid.");void 0!==P[a.id]&&h.die('The service "'+a.id+'" already exists.');
P[a.id]=function(b){for(var k=b||{},b={contentType:k.contentType||a.contentType,dataType:k.dataType||a.dataType,type:(k.type||a.type||"GET").toString().toUpperCase(),data:"function"===m.get(a.data)?a.data.call(i(),k.data):k.data||a.data,url:"function"===m.get(a.url)?a.url.call(i()):a.url,error:function(b,e){h.dispatchEvent("domino.ajaxFailed");var c=k.error||a.error;"function"===m.get(c)?c.call(i(),b,e):h.die('Loading failed with message "'+b+'".')}},c,d,f,g=x.shortcutPrefix,j=RegExp(g+"(\\w+)","g"),
g=RegExp("^"+g+"(\\w+)$"),p=null,n;(n=b.url.match(j))&&b.url!==p;)for(c in p=b.url,n)d=y(n[c],k.params),b.url=b.url.replace(RegExp(n[c],"g"),d);c=!0;"string"===m.get(b.data)&&b.data.match(g)&&(b.data=y(b.data,k.params));if("object"===m.get(b.data))for(;c;)for(f in c=!1,b.data)"string"===m.get(b.data[f])&&b.data[f].match(g)&&(b.data[f]=y(b.data[f],k.params),c=!0);b.success=function(b){var e,c,d,J,g={},u=k.path||a.path,j=k.setter||a.setter,T=k.success||a.success;"string"===m.get(j)&&(j=y(j,k.params));
"string"===m.get(u)&&(u=y(u,k.params));J=b;(u||"").match(/^(?:\w+\.)*\w+$/)?c=m.get(u,"string")?u.split("."):void 0:"string"===m.get(u)&&h.warn('Path "'+u+'" does not match regExp /^(?:\\w+\\.)*\\w+$/');if(c)for(e in c)J=J[c[e]],void 0===J&&h.warn('Wrong path "'+u+'" for service "'+a.id+'".');c=r.array(a.events);for(e in c)g[c[e]]=1;c=r.array(k.events);for(e in c)g[c[e]]=1;if(j&&t[j]&&A(j,J)){for(f in s[j]||[])g[s[j][f]]=1;for(f in v[j])C(v[j][f],{parameters:[h.getEvent(j,i())]})}"function"===m.get(T)&&
T.call(l(),b,k);c=[];for(d in g)h.dispatchEvent(d,i()),c.push(h.getEvent(d,i()));c.length&&o(c)};k.abort&&R[a.id]&&R[a.id].abort();R[a.id]=r.ajax(b)};return h}function c(b,a){var e,k={},c={},f,d,j,g;void 0===b&&h.die("Module class not specified.");"function"!==m.get(b)&&h.die("First parameter must be a function.");b.apply(k,(a||[]).concat(i()));f=k.triggers||{};for(j in f.events||{})for(g in r.array(j))L[g]=L[g]||[],L[g].push(f.events[g]);for(d in f.properties||{}){for(e in s[d]||[])v[d]=v[d]||[],
v[d].push(f.properties[d]);void 0!==w[d]&&(p(d),f.properties[d](h.getEvent("domino.initialUpdate",i())))}for(g in K||{})c[g]=1;for(g in D||{})c[g]=1;for(g in M||{})c[g]=1;for(g in c)k.addEventListener(g,o);V.push(k);return k}function o(b,a){var e,k,c,d,f,g,j,m=[],n=a||{},p={};n.loop=(n.loop||0)+1;var q=r.array(b);for(k in q){f=q[k];g=f.data||{};m.push(f.type);if(g||n.force)for(c in e=K[f.type]||[],e)if(j=!!n.force,void 0!==g[e[c]]&&(j=A(e[c],g[e[c]])||j),j){for(d in v[e[c]])C(v[e[c]][d],{parameters:[h.getEvent(e[c],
i())]});for(d in s[e[c]]||[])p[s[e[c]][d]]=1}for(d in L[f.type])C(L[f.type][d],{parameters:f});for(c in D[f.type]||[])for(d in e=l(),D[f.type][c].call(e,f),e=r.array(e.dispatch),e)p[e[d]]=1;for(c in M[f.type]||[])p[M[f.type][c]]=1}h.dump("Iteration "+n.loop+" (main loop) :",m);e=[];for(f in p)h.dispatchEvent(f,i()),e.push(h.getEvent(f,i()));e.length&&o(e,n)}function g(b){var a,e,c,f=[],d={};null==b&&h.warn("Nothing to update.");if("array"===m.get(b))for(e in b)if(f.push(e),void 0===t[b[e].property])h.warn("The property is not specified.");
else{if(A(b[e].property,b[e].value)){for(a in v[b[e].property])C(v[b[e].property][a],{parameters:[h.getEvent(b[e].property,i())]});for(a in s[b[e].property]||[])d[s[b[e].property][a]]=1}}else if("object"===m.get(b))for(e in b)if(f.push(e),t[e]&&A(e,b[e]))for(a in s[e]||[])d[s[e][a]]=1;h.dump("Updating properties :",f);a=[];for(c in d)h.dispatchEvent(c,i()),a.push(h.getEvent(c,i()));a.length&&o(a,b);return this}function p(b){if(w[b]){if(H[b]){for(var a=[],e={},c=1,f=arguments.length;c<f;c++)a.push(arguments[c]);
e[b]=I[b];return C(w[b],{parameters:a,inputValues:e}).returned}return w[b]()}h.warn('Property "'+b+'" not referenced.')}function A(b,a){if(t[b]){if(S[b]){var e;e={};e[b]=a;for(var c=1,f=arguments.length;c<f;c++)args.push(arguments[c]);e=C(t[b],{parameters:[],inputValues:e});update="boolean"!==m.get(e.returned)||e.returned;return}return t[b].call(l(),a)}h.warn('Property "'+b+'" not referenced.');return!1}function E(b,a){if(P[b])P[b](a);else h.warn('Service "'+b+'" not referenced.');return this}function C(b,
a){var c,f,d=a||{},g=i();"function"!==m.get(b)&&h.die("The first parameter must be a function");for(c in d.inputValues||{})g[c]=d.inputValues[c];f={returned:b.apply(g,d.parameters||[]),values:{}};null!=g.dispatch&&!m.check("array",g.dispatch)?h.warn("Events must be stored in an array."):f.events=g.dispatch;null!=g.properties&&!m.check("array",g.properties)?h.warn("Properties must be stored in an array."):f.properties=g.properties;for(c in d.inputValues)f.values[c]=g.properties;return f}function z(b){return G[b]}
function F(b){return B[b]}function y(b){var a=arguments.length,c=(b||"").toString().match(RegExp("^"+x.shortcutPrefix+"(\\w+)$"));if(!c||!c.length)return b;c=c[1];if("function"===m.get(Q[c]))return Q[c].call(l());if("function"===m.get(w[c]))return p(c);for(var f=1;f<a;f++)if(void 0!==(arguments[f]||{})[c])return arguments[f][c];return b}U.call(this);var h=this,r=q.utils,m=r.type,O={},G={},B={},w={},t={},I={},H={},S={},V=[],K={},s={},L={},v={},D={},M={},P={},R={},Q={},N={dispatch:1};(function(){for(var b in Object.prototype)N[b]=
1;for(b in i())N[b]=1;for(b in l())N[b]=1})();var n={};this.name="domino";"string"===m.get(a)?this.name=a:void 0!==a&&"object"===m.get(a)?n=a:void 0!==d&&"object"===m.get(d)&&(n=d);this.name=n.name||this.name;(function(){for(var b in n.properties||[])j(n.properties[b].id,n.properties[b]);for(b in n.hacks||[]){var a=void 0,c=void 0,d=n.hacks[b]||{};void 0===d.triggers&&h.die("A hack requires at least one trigger to be added");a=r.array(d.triggers);for(c in a)d.method&&(D[a[c]]=D[a[c]]||[],D[a[c]].push(d.method)),
d.dispatch&&(M[a[c]]=(M[a[c]]||[]).concat(r.array(d.dispatch)))}for(b in n.services||[])f(n.services[b]);for(b in n.shortcuts||[])a=n.shortcuts[b].id,c=n.shortcuts[b].method,void 0===a&&h.die("Shortcut ID not specified."),Q[a]&&h.die('Shortcut "'+a+'" already exists.'),void 0===c&&h.die("Shortcut method not specified."),Q[a]=c})();return l()};var q=z.domino;q.prototype.warn=function(a){var d=["["+this.name+"] "],i;for(i in arguments)d.push(arguments[i]);F.apply(this,d)};q.prototype.die=function(a){var d=
["["+this.name+"] "],i;for(i in arguments)d.push(arguments[i]);G.apply(this,d)};q.prototype.dump=function(){var a=["["+this.name+"] "],d;for(d in arguments)a.push(arguments[d]);H.apply(this,a)};q.utils={array:function(a,d){var i="string"===q.utils.type.get(a)?a.split(d||" "):"array"===q.utils.type.get(a)?a:[a],l=[],j;for(j in i)i[j]&&l.push(i[j]);return l},ajax:function(a,d){"string"===typeof a&&(a={url:a,ok:d});var i=a.type||"GET",l=a.url||"",j=a.contentType||"application/x-www-form-urlencoded",
f=a.dataType||"json",c=new XMLHttpRequest,o,g,p;if(a.data){if("string"===typeof a.data)g=a.data;else if(/json/.test(j))g=JSON.stringify(a.data);else{g=[];for(p in a.data)g.push(encodeURIComponent(p)+"="+encodeURIComponent(a.data[p]));g=g.join("&")}/GET|DEL/i.test(i)&&(l+=/\?/.test(l)?"&"+g:"?"+g,g="")}c.onreadystatechange=function(){if(4==c.readyState)if(o&&clearTimeout(o),/^2/.test(c.status)){g=c.responseText;if(/json/.test(f))try{g=JSON.parse(c.responseText)}catch(d){return a.error&&a.error("JSON parse error: "+
d.message,c)}a.success&&a.success(g,c)}else a.error&&a.error(c.responseText,c)};c.open(i,l,!0);c.setRequestHeader("Content-Type",j);if(a.headers)for(p in a.headers)c.setRequestHeader(p,a.headers[p]);a.timeout&&(o=setTimeout(function(){c.onreadystatechange=function(){};c.abort();a.error&&a.error&&a.error("timeout",c)},1E3*a.timeout));c.send(g);return c},type:function(){var a="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),d={},i=["*"],l;for(l in a){var j=a[l];i.push(j.toLowerCase());
d["[object "+j+"]"]=j.toLowerCase()}return{get:function(a){return null==a?""+a:d[Object.prototype.toString.call(a)]||"object"},check:function(a,c){var d,g,j=this.get(c);if("string"===this.get(a)){d=a.replace(/^\?/,"").split(/\|/);for(g in d)0>i.indexOf(d[g])&&F("[domino.global] Invalid type");if(null==c)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");g=a.split(/\|/);return!(!~g.indexOf("*")&&!~g.indexOf(j))}if("object"===this.get(a)){if("object"!==j)return!1;for(d in a)if(!this.check(a[d],c[d]))return!1;
for(d in c)if(void 0===a[d])return!1;return!0}return!1},isValid:function(a){var c,d;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(d in a)if(0>i.indexOf(a[d]))return!1;return!0}if("object"===this.get(a)){for(c in a)if(!this.isValid(a[c]))return!1;return!0}return!1}}}()};var E=q.utils,x={strict:!1,verbose:!1,shortcutPrefix:":"};q.settings=function(a,d){if("string"===typeof a&&void 0===d)return x[a];var i="object"===typeof a&&void 0===d?a||{}:{};"string"===typeof a&&(i[a]=d);for(var l in i)void 0!==
x[l]&&(x[l]=i[l]);return this};q.EventDispatcher=function(){var a={};this.removeEventListener=function(d,i){if(!arguments.length)return this._handlers_={},this;var l,j,f,c,o=E.array(d);if(i)for(l in o){c=o[l];if(a[c]){f=[];for(j in a[c])a[c][j].handler!==i&&f.push(a[c][j]);a[c]=f}a[c]&&0===a[c].length&&delete a[c]}else for(l in o)delete a[o[l]];return this};this.addEventListener=function(d,i){if(arguments.length)if(1===arguments.length&&"object"===E.type.get(arguments[0]))for(d in arguments[0])this.addEventListener(d,
arguments[0][d]);else if(1<arguments.length){var l,d=arguments[0],i=arguments[1],j=E.array(d),f;for(f in j)l=j[f],a[l]||(a[l]=[]),a[l].push({handler:i})}return this};this.dispatchEvent=function(d,i){var l,j,f,c,o,g=E.array(d),i=void 0===i?{}:i;for(l in g)if(o=g[l],a[o]){c=this.getEvent(o,i);f=[];for(j in a[o])a[o][j].handler(c),a[o][j].one||f.push(a[o][j]);a[o]=f}return this};this.getEvent=function(a,i){return{type:a,data:i,target:this}}};var U=q.EventDispatcher;q.module=function(){U.call(this);this.triggers=
{properties:{},events:{}}}})(window);
