/* domino.js - a JS fast dashboard prototyping framework - Version: 1.0 - Author:  Alexis Jacomy, Linkfluence - License: MIT */
(function(N){function X(){p.strict?U.apply(this,arguments):ca.apply(this,arguments)}function U(){var a="",c;for(c in arguments)a+=(a?" ":"")+arguments[c];throw Error(a);}function ca(){if(p.verbose){var a=[],c;for(c in arguments)a.push(arguments[c]);p.displayTime&&a.unshift(("00000000"+((new Date).getTime()-Y)).substr(-8));console&&"function"===typeof console.log&&console.log.apply(console,a)}}var Y=new Date,O={};if(N.domino)throw Error("domino already exists");N.domino=function(a,c){function g(b){var b=
b||{},h={getEvents:N,getLabel:M,expand:H,warn:t,log:x,die:n,get:j};b.full?(h.kill=Y,h.update=d,h.addModule=m,h.request=G,h.dispatchEvent=function(b,h){i({events:w.getEvent(b,h)})}):(b.request&&(Object.defineProperty(h,"_services",{value:[]}),h.request=function(b,h){this._services.push({service:b,params:h})}),b.dispatchEvent&&(Object.defineProperty(h,"_events",{value:[]}),h.dispatchEvent=function(b,h){this._events.push({type:b,data:h})}));return h}function e(b,h){var a,o=h||{};void 0===b&&n("Property name not specified");
void 0!==C[b]&&n('Property "'+b+'" already exists');void 0!==V[b]&&n('"'+b+'" can not be used to name a property');Z[b]=o.label||b;void 0!==o.type&&(k.isValid(o.type)?D[b]=o.type:t('Property "'+b+'": Type not valid'));void 0!==o.setter&&("function"!==k.get(o.setter)?t('Property "'+b+'": Setter is not a function'):(y[b]=o.setter,$[b]=!0));y[b]=y[b]||function(h){if(k.deepScalar(D[b])&&k.compare(h,C[b],D[b]))return!1;D[b]&&!k.check(D[b],h)?t('Property "'+b+'": Wrong type error'):C[b]=h;return!0};void 0!==
o.getter&&("function"!==k.get(o.getter)?t('Property "'+b+'": Getter is not a function'):(z[b]=o.getter,aa[b]=!0));z[b]=z[b]||function(){return C[b]};if(void 0!==o.value||D[b])void 0!==o.value?da(b,o.value):x('Property "'+b+'": Initial value is missing');if(void 0!==o.triggers)for(a in!k.check("array|string",o.triggers)&&t('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),E[b]=u.array(o.triggers),E[b]||[])I[E[b][a]]=I[E[b][a]]||[],I[E[b][a]].push(b);
void 0!==o.dispatch&&(!k.check("array|string",o.dispatch)?t('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):P[b]=u.array(o.dispatch));return w}function l(b){var h=b||{};(void 0===h.id||"string"!==k.get(h.id))&&n("The service id is not indicated.");k.check("function|string",h.url)||n("The service URL is not valid.");void 0!==Q[h.id]&&n('The service "'+h.id+'" already exists.');Q[h.id]=function(b){x('Calling service "'+h.id+'".');var a=b||{},
d=a.shortcuts||{},b={contentType:a.contentType||h.contentType,dataType:a.dataType||h.dataType,type:(a.type||h.type||"GET").toString().toUpperCase(),data:"function"===k.get(h.data)?h.data.call(g(),a):void 0!=a.data?a.data:h.data,url:"function"===k.get(h.url)?h.url.call(g(),a):h.url,error:function(b,d){w.dispatchEvent("domino.ajaxFailed");var A=a.error||h.error;"function"===k.get(A)?B(A,{parameters:[b,d,a],loop:!0,scope:{request:!0,dispatchEvent:!0}}):x('Loading service "'+h.id+'" failed with message "'+
b+'" and status '+d.status+".")}},r,c,f;c=p.shortcutPrefix;var e=RegExp(c+"(\\w+)","g"),j=RegExp("^"+c+"(\\w+)$"),l=null,m;for("string"!==k.get(b.url)&&n('The URL is no more a string (typed "'+k.get(b.url)+'")');(m=b.url.match(e))&&b.url!==l;)for(r in l=b.url,m)c=H(m[r].match(j)[1],d),b.url=b.url.replace(RegExp(m[r],"g"),c);r=!0;"string"===k.get(b.data)&&b.data.match(j)&&(b.data=H(b.data.match(j)[1],d));if("object"===k.get(b.data))for(;r;)for(f in r=!1,b.data)"string"===k.get(b.data[f])&&b.data[f].match(j)&&
(b.data[f]=H(b.data[f].match(j)[1],d),r=!0);b.success=function(b){x('Service "'+h.id+'" successfull.');var A,c,r,e,l={},ba=[];e=[];var m={},n=!1,p=a.path||h.path,q=a.setter||h.setter,s=a.success||h.success;"string"===k.get(q)&&q.match(j)&&(q=H(q.match(j)[1],d));"string"===k.get(p)&&p.match(j)&&(p=H(p.match(j)[1],d));e=b;(p||"").match(/^(?:\w+\.)*\w+$/)?c=k.get(p,"string")?p.split("."):void 0:"string"===k.get(p)&&t('Path "'+p+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(c)for(A in c)e=e[c[A]],
void 0===e&&t('Wrong path "'+p+'" for service "'+h.id+'".');c=u.array(h.events);for(A in c)l[c[A]]=1,n=!0;c=u.array(a.events);for(A in c)l[c[A]]=1,n=!0;q&&y[q]&&void 0!==e&&(m[q]=e,n=!0);if("function"===k.get(s)){b=B(s,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});c=u.array(b.events);for(f in c)n=!0,l[c[f].type]=1;for(f in b.update)void 0===m[f]?(m[f]=b.update[f],n=!0):t('The key "'+f+'" is nor a method neither a property.');if((b.services||[]).length)n=!0,ba=ba.concat(b.services)}e=[];
for(r in l)w.dispatchEvent(r,g()),e.push(w.getEvent(r,g()));n&&i({events:e,update:m,services:ba})};r=a.before||h.before;null!=r&&"function"===k.get(r)&&B(r,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});a.abort&&W[h.id]&&W[h.id].abort();W[h.id]=u.ajax(b)};return w}function m(b,h){var a,d={},c={},r,i,e;void 0===b&&n("Module class not specified.");"function"!==k.get(b)&&n("First parameter must be a function.");b.apply(d,(h||[]).concat(g()));r=d.triggers||{};for(e in r.events||{})J[e]=J[e]||[],J[e].push(r.events[e]);
for(i in r.properties||{}){for(a in P[i]||[])K[i]=K[i]||[],K[i].push(r.properties[i]);void 0!==z[i]&&(j(i),B(r.properties[i],{parameters:[g()]}))}for(e in I||{})c[e]=1;for(e in F||{})c[e]=1;for(e in L||{})c[e]=1;for(e in c)d.addEventListener(e,f);R.push(d);return d}function d(b){i({update:b});return this}function f(b){i({events:[b]})}function i(b){var a,d,o,c,e,f,j,k=!1,l=[],m=[],b=b||{},n={},q={};b.loop=(+b.loop||0)+1;var s=u.array(b.events);f=u.array(b.services);var v=b.update||{};if(p.verbose){x("Iteration "+
b.loop+" (main loop)");if(s.length){j=[];for(d in s)j.push(s[d].type);x(" -> Events: ",j)}if(f.length){j=[];for(d in f)j.push(f[d].service);x(" -> Services: ",j)}j=[];for(d in v)j.push(d);j.length&&x(" -> Update: ",j)}for(a in v)if(void 0===y[a])t('The property "'+a+'" is not referenced.');else if(j=da(a,v[a])||!!b.force){for(d in K[a])B(K[a][d],{parameters:[g(),{property:a}]});for(d in P[a]||[])n[P[a][d]]=1}for(d in f||[])G(f[d].service,f[d].params);for(d in s){e=s[d];for(o in f=e.data||{},a=I[e.type]||
[],a)void 0!==f[a[o]]&&(k=!0,q[a[o]]=f[a[o]]);for(c in J[e.type])B(J[e.type][c],{parameters:[g(),e]});for(o in F[e.type]||[]){f=B(F[e.type][o],{parameters:[e],scope:{request:!0,dispatchEvent:!0}});a=u.array(f.events);for(c in a)n[a[c].type]=1;for(c in f.update)void 0===q[c]?(k=!0,q[c]=f.update[c]):t('The property "'+c+'" is not a method nor a property.');if((f.services||[]).length)k=!0,m=m.concat(f.services)}for(o in L[e.type]||[])n[L[e.type][o]]=1}for(e in n)w.dispatchEvent(e,g()),l.push(w.getEvent(e,
g())),k=!0;k&&i({events:l,update:q,services:m,loop:b.loop})}function j(b){if(z[b]){if(aa[b]){for(var a=[],d={},c=1,e=arguments.length;c<e;c++)a.push(arguments[c]);d[b]=C[b];a=B(z[b],{parameters:a,inputValues:d});return p.clone?u.clone(a.returned):a.returned}return p.clone?u.clone(z[b]()):z[b]()}t('Property "'+b+'" not referenced.')}function da(b,a){if(y[b]){if($[b]){var d,c;d=[];c={};p.clone&&(a=u.clone(a));c[b]=j(b);for(var e=1,f=arguments.length;e<f;e++)d.push(arguments[e]);c=B(y[b],{parameters:d,
inputValues:c});(d="boolean"!==k.get(c.returned)||c.returned)&&(C[b]=c.update[b]);return d}return y[b].call(g(),p.clone?u.clone(a):a)}t('Property "'+b+'" not referenced.');return!1}function G(b,a){if(Q[b])Q[b](a);else t('Service "'+b+'" not referenced.');return this}function B(b,a){var d,c,e=a||{},f=g(e.scope);"function"!==k.get(b)&&n("The first parameter must be a function");for(d in e.inputValues||{})f[d]=e.inputValues[d];c={returned:b.apply(f,e.parameters||[]),update:{},events:[],services:[]};
null!=f._events&&!k.check("array",f._events)?t("Events must be stored in an array."):c.events=f._events;for(d in f)void 0!==y[d]?c.update[d]=f[d]:void 0===V[d]&&t('The key "'+d+'" is not a method nor a property.');for(d in e.inputValues)c.update[d]=f[d];for(d in f._services)c.services[d]=f._services[d];if(e.loop){e=(c.services||[]).length||(c.events||[]).length;if(!e)for(d in c.update)e=!0;e&&i(c)}else return c}function M(b){return Z[b]}function N(b){return E[b]}function H(b){var a=b,d=arguments.length,
c=(b||"").toString().match(RegExp("^"+p.shortcutPrefix+"(\\w+)$"));c&&c.length&&(t("Prefix in expand() calls is deprecated."),a=c[1]);if("function"===k.get(S[a]))return S[a].call(g());if("function"===k.get(z[a]))return j(a);for(c=1;c<d;c++)if(void 0!==(arguments[c]||{})[a])return arguments[c][a];if(p.strict)n('The shortcut "',a,'" has not been recognized.');else return a}function Y(){var b;x('Killing instance "'+v+'"');for(b in R)R[b].removeEventListener();S=W=Q=L=F=K=J=P=I=R=$=aa=C=y=z=E=Z=D=R=null;
for(b in T)delete T[b];O[v]&&delete O[v]}function t(){var b=["["+v+"]"];p.strict||b.push("WARNING");for(var a in arguments)b.push(arguments[a]);X.apply(w,b)}function n(){var b=["["+v+"]"],a;for(a in arguments)b.push(arguments[a]);U.apply(w,b)}function x(){var b=["["+v+"]"],a;for(a in arguments)b.push(arguments[a]);ca.apply(w,b)}ea.call(this);var w=this,u=q.utils,k=q.struct,T,D={},Z={},E={},z={},y={},C={},aa={},$={},R=[],I={},P={},J={},K={},F={},L={},Q={},W={},S={},V={events:1,services:1,hacks:1};
(function(){for(var a in Object.prototype)V[a]=1;for(a in g({full:!0}))V[a]=1})();T=g({full:!0});var s={},v;"string"===k.get(a)?v=a:void 0!==a&&"object"===k.get(a)?s=a:void 0!==c&&"object"===k.get(c)&&(s=c);(v=s.name)&&(O[v]?n('An instance named "'+v+'" is already running.'):O[v]=T);(function(){for(var a in s.properties||[])e(s.properties[a].id,s.properties[a]);for(a in s.hacks||[]){var d=void 0,c=void 0,f=s.hacks[a]||{};void 0===f.triggers&&n("A hack requires at least one trigger to be added");void 0===
f.method&&void 0===f.dispatch&&n('A hack requires at least a method or a "dispatch" value to be added');d=u.array(f.triggers);for(c in d)f.method&&(F[d[c]]=F[d[c]]||[],F[d[c]].push(f.method)),f.dispatch&&(L[d[c]]=(L[d[c]]||[]).concat(u.array(f.dispatch)))}for(a in s.services||[])l(s.services[a]);for(a in s.shortcuts||[])d=s.shortcuts[a].id,c=s.shortcuts[a].method,void 0===d&&n("Shortcut ID not specified."),S[d]&&n('Shortcut "'+d+'" already exists.'),void 0===c&&n("Shortcut method not specified."),
S[d]=c})();return T};var q=N.domino;q.utils={array:function(a,c){var g="string"===q.struct.get(a)?a.split(c||" "):"array"===q.struct.get(a)?a:[a],e=[],l;for(l in g)g[l]&&e.push(g[l]);return e},clone:function(a){if(!a)return a;var c,g;if("array"===G.get(a))for(g in c=[],a)c[g]=this.clone(a[g]);else if("date"===G.get(a))c=new Date(a.getTime());else if("object"===G.get(a))if(a.prototype)c=a;else{c={};for(var e in a)c[e]=this.clone(a[e])}else c=a;return c},ajax:function(a,c){"string"===typeof a?a={url:a,
ok:c}:"object"!==G.get(a)&&U("[domino.global] Invalid parameter given to AJAX");var g=a.type||"GET",e=a.url||"",l=a.contentType||"application/x-www-form-urlencoded",m=a.dataType||"json",d=new XMLHttpRequest,f,i,j;if(a.data){if("string"===typeof a.data)i=a.data;else if(/json/.test(l))i=JSON.stringify(a.data);else{i=[];for(j in a.data)i.push(encodeURIComponent(j)+"="+encodeURIComponent(a.data[j]));i=i.join("&")}/GET|DEL/i.test(g)&&(e+=/\?/.test(e)?"&"+i:"?"+i,i="")}d.onreadystatechange=function(){if(4==
d.readyState)if(f&&clearTimeout(f),/^2/.test(d.status)){i=d.responseText;if(/json/.test(m))try{i=JSON.parse(d.responseText)}catch(c){return a.error&&a.error("JSON parse error: "+c.message,d)}a.success&&a.success(i,d)}else{var e=+d.status?d.responseText:d.responseText.length?"Aborted: "+d.responseText:"Aborted";a.error&&a.error(e,d)}};d.open(g,e,!0);d.setRequestHeader("Content-Type",l);if(a.headers)for(j in a.headers)d.setRequestHeader(j,a.headers[j]);a.timeout&&(f=setTimeout(function(){d.onreadystatechange=
function(){};d.abort();a.error&&a.error&&a.error("timeout",d)},1E3*a.timeout));d.send(i);return d}};q.struct=function(){var a=["number","string","boolean","null","undefined"],c="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),g={},e=["*"],l;for(l in c){var m=c[l];e.push(m.toLowerCase());g["[object "+m+"]"]=m.toLowerCase()}return{get:function(a){return null==a?""+a:g[Object.prototype.toString.call(a)]||"object"},check:function(a,c){var i,j,g=this.get(c);if("string"===this.get(a)){i=
a.replace(/^\?/,"").split(/\|/);for(j in i)if(0>e.indexOf(i[j]))return X("[domino.global] Invalid type"),!1;if(null==c)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");j=a.split(/\|/);return!(!~j.indexOf("*")&&!~j.indexOf(g))}if("object"===this.get(a)){if("object"!==g)return!1;for(i in a)if(!this.check(a[i],c[i]))return!1;for(i in c)if(void 0===a[i])return!1;return!0}if("array"===this.get(a)){if("array"!==g)return!1;if(1!==a.length)return X("[domino.global] Invalid type"),!1;for(i in c)if(!this.check(a[0],
c[i]))return!1;return!0}return!1},deepScalar:function(d){var c;if("string"===this.get(d)){d=d.replace(/^\?/,"").split(/\|/);for(c in d)if(0>a.indexOf(d[c]))return!1;return!0}if(this.check("object|array",d)){for(c in d)if(!this.deepScalar(d[c]))return!1;return!0}return!1},compare:function(a,c,e){this.get(a);this.get(c);var g;if(!this.deepScalar(e)||!this.check(e,a)||!this.check(e,c))return!1;if("string"===this.get(e))return a===c;if("object"===this.get(e)){for(g in e)if(!this.compare(a[g],c[g],e[g]))return!1;
return!0}if("array"===this.get(e)){if(a.length!==c.length)return!1;var l=a.length;for(g=0;g<l;g++)if(!this.compare(a[g],c[g],e[0]))return!1;return!0}return!1},isValid:function(a){var c,g;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(g in a)if(0>e.indexOf(a[g]))return!1;return!0}if("object"===this.get(a)){for(c in a)if(!this.isValid(a[c]))return!1;return!0}return"array"===this.get(a)?1===a.length?this.isValid(a[0]):!1:!1}}}();var M=q.utils,G=q.struct,p={strict:!1,verbose:!1,shortcutPrefix:":",
displayTime:!1,clone:!1};q.settings=function(a,c){if("string"===typeof a&&void 0===c)return p[a];var g="object"===typeof a&&void 0===c?a||{}:{};"string"===typeof a&&(g[a]=c);for(var e in g)void 0!==p[e]&&(p[e]=g[e]);return this};q.instances=function(a){if(arguments.length)return O[a];U("[domino.global] You need to indicate a name to get the instance.")};q.EventDispatcher=function(){var a={};this.removeEventListener=function(c,g){if(!arguments.length)return this._handlers_={},this;var e,l,m,d,f=M.array(c);
if(g)for(e in f){d=f[e];if(a[d]){m=[];for(l in a[d])a[d][l].handler!==g&&m.push(a[d][l]);a[d]=m}a[d]&&0===a[d].length&&delete a[d]}else for(e in f)delete a[f[e]];return this};this.addEventListener=function(c,g){if(arguments.length)if(1===arguments.length&&"object"===M.type.get(arguments[0]))for(c in arguments[0])this.addEventListener(c,arguments[0][c]);else if(1<arguments.length){var e,c=arguments[0],g=arguments[1],l=M.array(c),m;for(m in l)e=l[m],a[e]||(a[e]=[]),a[e].push({handler:g})}return this};
this.dispatchEvent=function(c,g){var e,l,m,d,f,i=M.array(c),g=void 0===g?{}:g;for(e in i)if(f=i[e],a[f]){d=this.getEvent(f,g);m=[];for(l in a[f])a[f][l].handler(d),a[f][l].one||m.push(a[f][l]);a[f]=m}return this};this.getEvent=function(a,g){return{type:a,data:g,target:this}}};var ea=q.EventDispatcher;q.module=function(){ea.call(this);this.triggers={properties:{},events:{}}}})(window);
