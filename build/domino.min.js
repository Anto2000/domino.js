/* domino.js - a JS fast dashboard prototyping framework - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(L){function X(){y.strict?U.apply(this,arguments):Y.apply(this,arguments)}function U(){var a="",f;for(f in arguments)a+=arguments[f];throw Error(a);}function Y(){if(y.verbose){var a=[],f;for(f in arguments)a.push(arguments[f]);y.displayTime&&a.unshift(("00000000"+((new Date).getTime()-V)).substr(-8));console.log.apply(console,a)}}var V=new Date;if(L.domino)throw Error("domino already exists");L.domino=function(a,f){function i(b){var b=b||{},m={get:e,getEvents:L,getLabel:K,dump:E,warn:q,die:r,
expand:F,events:[],services:[]};b.call&&(m.call=function(c,b){this.services.push({service:c,params:b})});b.full&&(m.addModule=k,m.update=h,m.call=M);return m}function d(b,m){var c,s=m||{};void 0===b&&r("Property name not specified");void 0!==G[b]&&r('Property "'+b+'" already exists');void 0!==Q[b]&&r('"'+b+'" can not be used to name a property');Z[b]=s.label||b;void 0!==s.type&&(j.isValid(s.type)?H[b]=s.type:q('Property "'+b+'": Type not valid'));void 0!==s.setter&&("function"!==j.get(s.setter)?q('Property "'+
b+'": Setter is not a function'):(z[b]=s.setter,$[b]=!0));z[b]=z[b]||function(c){if(j.isAtom(H[b])&&j.compare(c,G[b],H[b]))return!1;H[b]&&!j.check(H[b],c)?q('Property "'+b+'": Wrong type error'):G[b]=c;return!0};void 0!==s.getter&&("function"!==j.get(s.getter)?q('Property "'+b+'": Getter is not a function'):(C[b]=s.getter,aa[b]=!0));C[b]=C[b]||function(){return G[b]};if(void 0!==s.value||H[b])void 0!==s.value?w(b,s.value):E('Property "'+b+'": Initial value is missing');if(void 0!==s.triggers)for(c in!j.check("array|string",
s.triggers)&&q('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),I[b]=D.array(s.triggers),I[b]||[])N[I[b][c]]=N[I[b][c]]||[],N[I[b][c]].push(b);void 0!==s.dispatch&&(!j.check("array|string",s.dispatch)?q('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):v[b]=D.array(s.dispatch));return o}function g(b){var m=b||{};(void 0===m.id||"string"!==j.get(m.id))&&r("The service id is not indicated.");
j.check("function|string",m.url)||r("The service URL is not valid.");void 0!==S[m.id]&&r('The service "'+m.id+'" already exists.');S[m.id]=function(c){E('Calling service "'+m.id+'".');var b=c||{},c={contentType:b.contentType||m.contentType,dataType:b.dataType||m.dataType,type:(b.type||m.type||"GET").toString().toUpperCase(),data:"function"===j.get(m.data)?m.data.call(i(),b):b.data||m.data,url:"function"===j.get(m.url)?m.url.call(i(),b):m.url,error:function(c,n){o.dispatchEvent("domino.ajaxFailed");
var e=b.error||m.error,h=[],p={},f={},d,g;if("function"===j.get(e)){var A=x(e,{parameters:[c,n,b],scope:{call:!0}}),e=D.array(A.events);for(d in e)f[e[d]]=1;for(d in A.properties)void 0===p[d]?p[d]=A.properties[d]:q('The property "'+d+'" is not a method nor a property.');h=h.concat(A.services||[])}else E('Loading failed with message "'+c+'" and status.');for(g in p)if(void 0===z[g])q("The property is not referenced.");else if(w(g,p[g])){for(a in u[g])x(u[g][a],{parameters:[o.getEvent(g,i())]});for(a in v[g]||
[])f[v[g][a]]=1}for(d in h||[])M(h[d].service,h[d].params);e=[];for(k in f)o.dispatchEvent(k,i()),e.push(o.getEvent(k,i()));e.length&&l(e)}},a,p,n,e,h=y.shortcutPrefix;e=RegExp(h+"(\\w+)","g");var h=RegExp("^"+h+"(\\w+)$"),f=null,d;for("string"!==j.get(c.url)&&r('The URL is no more a string (typed "'+j.get(c.url)+'")');(d=c.url.match(e))&&c.url!==f;)for(a in f=c.url,d)p=F(d[a],b.params),c.url=c.url.replace(RegExp(d[a],"g"),p);e=!0;"string"===j.get(c.data)&&c.data.match(h)&&(c.data=F(c.data,b.params));
if("object"===j.get(c.data))for(;e;)for(n in e=!1,c.data)"string"===j.get(c.data[n])&&c.data[n].match(h)&&(c.data[n]=F(c.data[n],b.params),e=!0);c.success=function(c){E('Service "'+m.id+'" successfull.');var a,e,h,p,d,f=[],g={},R={},A=b.path||m.path,k=b.setter||m.setter,r=b.success||m.success;"string"===j.get(k)&&(k=F(k,b.params));"string"===j.get(A)&&(A=F(A,b.params));d=c;(A||"").match(/^(?:\w+\.)*\w+$/)?e=j.get(A,"string")?A.split("."):void 0:"string"===j.get(A)&&q('Path "'+A+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');
if(e)for(a in e)d=d[e[a]],void 0===d&&q('Wrong path "'+A+'" for service "'+m.id+'".');e=D.array(m.events);for(a in e)g[e[a]]=1;e=D.array(b.events);for(a in e)g[e[a]]=1;if(k&&z[k]&&w(k,d)){for(n in v[k]||[])g[v[k][n]]=1;for(n in u[k])x(u[k][n],{parameters:[o.getEvent(k,i())]})}if("function"===j.get(r)){c=x(r,{parameters:[c,b],scope:{call:!0}});e=D.array(c.events);for(n in e)g[e[n]]=1;for(n in c.properties)void 0===R[n]?R[n]=c.properties[n]:q('The property "'+n+'" is not a method nor a property.');
f=f.concat(c.services||[])}for(p in R)if(void 0===z[p])q("The property is not referenced.");else if(w(p,R[p])){for(a in u[p])x(u[p][a],{parameters:[o.getEvent(p,i())]});for(a in v[p]||[])g[v[p][a]]=1}for(n in f||[])M(f[n].service,f[n].params);e=[];for(h in g)o.dispatchEvent(h,i()),e.push(o.getEvent(h,i()));e.length&&l(e)};f=b.before||m.before;if(null!=f&&"function"===j.get(f)){var g,k;e={};h=[];p={};d=x(f,{parameters:[b]});f=D.array(d.events);for(n in f)p[f[n]]=1;for(n in d.properties)void 0===e[n]?
e[n]=d.properties[n]:q('The property "'+n+'" is not a method nor a property.');h=h.concat(d.services||[]);for(g in e)if(void 0===z[g])q("The property is not referenced.");else if(w(g,e[g])){for(a in u[g])x(u[g][a],{parameters:[o.getEvent(g,i())]});for(a in v[g]||[])p[v[g][a]]=1}for(n in h||[])M(h[n].service,h[n].params);f=[];for(k in p)o.dispatchEvent(k,i()),f.push(o.getEvent(k,i()));f.length&&l(f)}b.abort&&W[m.id]&&W[m.id].abort();W[m.id]=D.ajax(c)};return o}function k(b,a){var c,s={},h={},p,d,f;
void 0===b&&r("Module class not specified.");"function"!==j.get(b)&&r("First parameter must be a function.");b.apply(s,(a||[]).concat(i()));p=s.triggers||{};for(f in p.events||{})O[f]=O[f]||[],O[f].push(p.events[f]);for(d in p.properties||{}){for(c in v[d]||[])u[d]=u[d]||[],u[d].push(p.properties[d]);void 0!==C[d]&&(e(d),x(p.properties[d],{parameters:[o.getEvent("domino.initialUpdate",i())]}))}for(f in N||{})h[f]=1;for(f in J||{})h[f]=1;for(f in P||{})h[f]=1;for(f in h)s.addEventListener(f,l);V.push(s);
return s}function l(b,a){var c,e,f,d,h,g,k,j,r=[];c=[];var t=a||{},y={},B={};t.loop=(t.loop||0)+1;var C=D.array(b);for(e in C)c.push(C[e].type);E("Iteration "+t.loop+" (main loop) :",c);for(e in C){h=C[e];for(f in g=h.data||{},c=N[h.type]||[],c)if(k=!!t.force,void 0!==g[c[f]]&&(k=w(c[f],g[c[f]])||k),k){for(d in u[c[f]])x(u[c[f]][d],{parameters:[o.getEvent(c[f],i())]});for(d in v[c[f]]||[])y[v[c[f]][d]]=1}for(d in O[h.type])x(O[h.type][d],{parameters:[h]});for(f in J[h.type]||[]){g=x(J[h.type][f],
{parameters:[h],scope:{call:!0}});c=D.array(g.events);for(d in c)y[c[d]]=1;for(d in g.properties)void 0===B[d]?B[d]=g.properties[d]:q('The property "'+d+'" is not a method nor a property.');r=r.concat(g.services||[])}for(f in P[h.type]||[])y[P[h.type][f]]=1}for(j in B)if(void 0===z[j])q("The property is not referenced.");else if(w(j,B[j])){for(e in u[j])x(u[j][e],{parameters:[o.getEvent(j,i())]});for(e in v[j]||[])y[v[j][e]]=1}for(d in r||[])M(r[d].service,r[d].params);c=[];for(h in y)o.dispatchEvent(h,
i()),c.push(o.getEvent(h,i()));c.length&&l(c,t)}function h(b){var a,c,e,f=[],d={};null==b&&q("Nothing to update.");if("array"===j.get(b))for(c in b)if(f.push(b[c].property),void 0===z[b[c].property])q("The property is not referenced.");else{if(w.apply([b[c].property,b[c].value].concat(b[c].parameters||[]))){for(a in u[b[c].property])x(u[b[c].property][a],{parameters:[o.getEvent(b[c].property,i())]});for(a in v[b[c].property]||[])d[v[b[c].property][a]]=1}}else if("object"===j.get(b))for(c in b){if(f.push(c),
z[c]&&w(c,b[c])){for(a in u[c])x(u[c][a],{parameters:[o.getEvent(c,i())]});for(a in v[c]||[])d[v[c][a]]=1}}else q("The properties must be stored in an array or an object.");E("Updating properties :",f);a=[];for(e in d)o.dispatchEvent(e,i()),a.push(o.getEvent(e,i()));a.length&&l(a,b);return this}function e(b){if(C[b]){if(aa[b]){for(var a=[],c={},e=1,f=arguments.length;e<f;e++)a.push(arguments[e]);c[b]=G[b];return x(C[b],{parameters:a,inputValues:c}).returned}return C[b]()}q('Property "'+b+'" not referenced.')}
function w(b,a){if(z[b]){if($[b]){var c,e;c=[];e={};e[b]=a;for(var f=1,d=arguments.length;f<d;f++)c.push(arguments[f]);e=x(z[b],{parameters:c,inputValues:e});(c="boolean"!==j.get(e.returned)||e.returned)&&(G[b]=e.properties[b]);return c}return z[b].call(i(),a)}q('Property "'+b+'" not referenced.');return!1}function M(b,a){if(S[b])S[b](a);else q('Service "'+b+'" not referenced.');return this}function x(b,a){var c,e,f=a||{},d=i(f.scope);"function"!==j.get(b)&&r("The first parameter must be a function");
for(c in f.inputValues||{})d[c]=f.inputValues[c];e={returned:b.apply(d,f.parameters||[]),properties:{},events:{},services:[]};null!=d.events&&!j.check("array",d.events)?q("Events must be stored in an array."):e.events=d.events;for(c in d)void 0!==z[c]?e.properties[c]=d[c]:void 0===Q[c]&&q('The key "'+c+'" is not a method nor a property.');for(c in f.inputValues)e.properties[c]=d[c];for(c in d.services)e.services[c]=d.services[c];return e}function K(b){return Z[b]}function L(b){return I[b]}function q(b){var a=
["["+o.name+"]"];y.strict||a.push("WARNING");for(var c in arguments)a.push(arguments[c]);X.apply(o,a)}function r(b){var a=["["+o.name+"]"],c;for(c in arguments)a.push(arguments[c]);U.apply(o,a)}function E(){var b=["["+o.name+"]"],a;for(a in arguments)b.push(arguments[a]);Y.apply(o,b)}function F(b){var a=arguments.length,c=(b||"").toString().match(RegExp("^"+y.shortcutPrefix+"(\\w+)$"));if(!c||!c.length)return b;c=c[1];if("function"===j.get(T[c]))return T[c].call(i());if("function"===j.get(C[c]))return e(c);
for(var d=1;d<a;d++)if(void 0!==(arguments[d]||{})[c])return arguments[d][c];return b}ba.call(this);var o=this,D=B.utils,j=D.type,H={},Z={},I={},C={},z={},G={},aa={},$={},V=[],N={},v={},O={},u={},J={},P={},S={},W={},T={},Q={events:1,services:1,hacks:1};(function(){for(var b in Object.prototype)Q[b]=1;for(b in i({full:1}))Q[b]=1})();var t={};this.name="domino";"string"===j.get(a)?this.name=a:void 0!==a&&"object"===j.get(a)?t=a:void 0!==f&&"object"===j.get(f)&&(t=f);this.name=t.name||this.name;(function(){for(var b in t.properties||
[])d(t.properties[b].id,t.properties[b]);for(b in t.hacks||[]){var a=void 0,c=void 0,e=t.hacks[b]||{};void 0===e.triggers&&r("A hack requires at least one trigger to be added");void 0===e.method&&void 0===e.dispatch&&r('A hack requires at least a method or a "dispatch" value to be added');a=D.array(e.triggers);for(c in a)e.method&&(J[a[c]]=J[a[c]]||[],J[a[c]].push(e.method)),e.dispatch&&(P[a[c]]=(P[a[c]]||[]).concat(D.array(e.dispatch)))}for(b in t.services||[])g(t.services[b]);for(b in t.shortcuts||
[])a=t.shortcuts[b].id,c=t.shortcuts[b].method,void 0===a&&r("Shortcut ID not specified."),T[a]&&r('Shortcut "'+a+'" already exists.'),void 0===c&&r("Shortcut method not specified."),T[a]=c})();return i({full:!0})};var B=L.domino;B.utils={array:function(a,f){var i="string"===B.utils.type.get(a)?a.split(f||" "):"array"===B.utils.type.get(a)?a:[a],d=[],g;for(g in i)i[g]&&d.push(i[g]);return d},ajax:function(a,f){"string"===typeof a?a={url:a,ok:f}:"object"!==this.type.get(a)&&U("[domino.global] Invalid parameter given to AJAX");
var i=a.type||"GET",d=a.url||"",g=a.contentType||"application/x-www-form-urlencoded",k=a.dataType||"json",l=new XMLHttpRequest,h,e,w;if(a.data){if("string"===typeof a.data)e=a.data;else if(/json/.test(g))e=JSON.stringify(a.data);else{e=[];for(w in a.data)e.push(encodeURIComponent(w)+"="+encodeURIComponent(a.data[w]));e=e.join("&")}/GET|DEL/i.test(i)&&(d+=/\?/.test(d)?"&"+e:"?"+e,e="")}l.onreadystatechange=function(){if(4==l.readyState)if(h&&clearTimeout(h),/^2/.test(l.status)){e=l.responseText;if(/json/.test(k))try{e=
JSON.parse(l.responseText)}catch(d){return a.error&&a.error("JSON parse error: "+d.message,l)}a.success&&a.success(e,l)}else{var f=+l.status?l.responseText:l.responseText.length?"Aborted: "+l.responseText:"Aborted";a.error&&a.error(f,l)}};l.open(i,d,!0);l.setRequestHeader("Content-Type",g);if(a.headers)for(w in a.headers)l.setRequestHeader(w,a.headers[w]);a.timeout&&(h=setTimeout(function(){l.onreadystatechange=function(){};l.abort();a.error&&a.error&&a.error("timeout",l)},1E3*a.timeout));l.send(e);
return l},type:function(){var a=["number","string","boolean","null","undefined"],f="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),i={},d=["*"],g;for(g in f){var k=f[g];d.push(k.toLowerCase());i["[object "+k+"]"]=k.toLowerCase()}return{get:function(a){return null==a?""+a:i[Object.prototype.toString.call(a)]||"object"},check:function(a,f){var e,g,i=this.get(f);if("string"===this.get(a)){e=a.replace(/^\?/,"").split(/\|/);for(g in e)0>d.indexOf(e[g])&&X("[domino.global] Invalid type");
if(null==f)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");g=a.split(/\|/);return!(!~g.indexOf("*")&&!~g.indexOf(i))}if("object"===this.get(a)){if("object"!==i)return!1;for(e in a)if(!this.check(a[e],f[e]))return!1;for(e in f)if(void 0===a[e])return!1;return!0}return!1},isAtom:function(d){var f;if("string"===this.get(d)){d=d.replace(/^\?/,"").split(/\|/);for(f in d)if(0>a.indexOf(d[f]))return!1;return!0}if("object"===this.get(d)){for(f in d)if(!this.isAtom(d[f]))return!1;return!0}return!1},compare:function(a,
d,e){this.get(a);this.get(d);var f;if(!this.isAtom(e)||!this.check(e,a)||!this.check(e,d))return!1;if("string"===this.get(e))return a===d;if("object"===this.get(e)){for(f in e)if(!this.compare(a[f],d[f],e[f]))return!1;return!0}return!1},isValid:function(a){var f,e;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(e in a)if(0>d.indexOf(a[e]))return!1;return!0}if("object"===this.get(a)){for(f in a)if(!this.isValid(a[f]))return!1;return!0}return!1}}}()};var K=B.utils,y={strict:!1,verbose:!1,
shortcutPrefix:":",displayTime:!1};B.settings=function(a,f){if("string"===typeof a&&void 0===f)return y[a];var i="object"===typeof a&&void 0===f?a||{}:{};"string"===typeof a&&(i[a]=f);for(var d in i)void 0!==y[d]&&(y[d]=i[d]);return this};B.EventDispatcher=function(){var a={};this.removeEventListener=function(f,i){if(!arguments.length)return this._handlers_={},this;var d,g,k,l,h=K.array(f);if(i)for(d in h){l=h[d];if(a[l]){k=[];for(g in a[l])a[l][g].handler!==i&&k.push(a[l][g]);a[l]=k}a[l]&&0===a[l].length&&
delete a[l]}else for(d in h)delete a[h[d]];return this};this.addEventListener=function(f,i){if(arguments.length)if(1===arguments.length&&"object"===K.type.get(arguments[0]))for(f in arguments[0])this.addEventListener(f,arguments[0][f]);else if(1<arguments.length){var d,f=arguments[0],i=arguments[1],g=K.array(f),k;for(k in g)d=g[k],a[d]||(a[d]=[]),a[d].push({handler:i})}return this};this.dispatchEvent=function(f,i){var d,g,k,l,h,e=K.array(f),i=void 0===i?{}:i;for(d in e)if(h=e[d],a[h]){l=this.getEvent(h,
i);k=[];for(g in a[h])a[h][g].handler(l),a[h][g].one||k.push(a[h][g]);a[h]=k}return this};this.getEvent=function(a,i){return{type:a,data:i,target:this}}};var ba=B.EventDispatcher;B.module=function(){ba.call(this);this.triggers={properties:{},events:{}}}})(window);
