/* domino.js - a JS fast dashboard prototyping framework - Version: 1.2 - Author:  Alexis Jacomy, Linkfluence - License: MIT */
(function(K,h){function $(){L.strict?v.apply(this,arguments):ma.apply(this,arguments)}function v(){var a="",h;for(h in arguments)a+=(a?" ":"")+arguments[h];throw Error(a);}function ma(){L.verbose&&ea.apply(this,arguments)}function ea(){var a=[],h;for(h in arguments)a.push(arguments[h]);L.displayTime&&a.unshift(("00000000"+((new Date).getTime()-na)).substr(-8));console&&console.log instanceof Function&&console.log.apply(console,a)}var ka=/^[a-zA-Z_$-][a-zA-Z_$0-9-]*$/,na=new Date,U={};if(K.domino)throw Error("domino already exists");
K.domino=function(a,d){function j(b){var b=b||{},g={getEvents:z,getLabel:oa,expand:P,warn:t,log:C,die:q,get:o};b.full?(g.kill=T,g.update=c,g.addModule=e,g.request=m,g.settings=A,g.dispatchEvent=function(b,g){r({events:I.getEvent(b,g)});return this}):(b.request&&(Object.defineProperty(g,"_services",{value:[]}),g.request=function(b,g){this._services.push({service:b,params:g});return this}),b.dispatchEvent&&(Object.defineProperty(g,"_events",{value:[]}),g.dispatchEvent=function(b,g){this._events.push({type:b,
data:g});return this}));return g}function l(b){b.request!==h&&(b.request=function(){q("This method is no longer available.");return this});b.dispatchEvent!==h&&(b.dispatchEvent=function(){q("This method is no longer available.");return this})}function i(b,g){var a,fa,c=g||{};b===h&&q("Property name not specified");"string"!==k.get(b)&&q("The property name must be a string");M[b]!==h&&q('Property "'+b+'" already exists');aa[b]!==h&&q('"'+b+'" can not be used to name a property');b.match(ka)||q("Property name not valid ("+
ka+")");ga[b]={};for(fa in c)ga[b][fa]=c[fa];K[b]=c.label||b;c.type!==h&&(k.isValid(c.type)?N[b]=c.type:t('Property "'+b+'": Type not valid'));c.setter!==h&&("function"!==k.get(c.setter)?t('Property "'+b+'": Setter is not a function'):(D[b]=c.setter,ha[b]=!0));D[b]=D[b]||function(g){if(k.deepScalar(N[b])&&k.compare(g,M[b],N[b]))return!1;N[b]&&!k.check(N[b],g)?t('Property "'+b+'": Wrong type error'):M[b]=g;return!0};c.getter!==h&&("function"!==k.get(c.getter)?t('Property "'+b+'": Getter is not a function'):
(E[b]=c.getter,ia[b]=!0));E[b]=E[b]||function(){return M[b]};if(c.value!==h||N[b])c.value!==h?B(b,c.value):C('Property "'+b+'": Initial value is missing');if(c.triggers!==h)for(a in!k.check("array|string",c.triggers)&&t('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),O[b]=x.array(c.triggers),O[b]||[])Q[O[b][a]]=Q[O[b][a]]||[],Q[O[b][a]].push(b);c.dispatch!==h&&(!k.check("array|string",c.dispatch)?t('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):
V[b]=x.array(c.dispatch));return I}function n(b){var g=b||{};(g.id===h||"string"!==k.get(g.id))&&q("The service id is not indicated.");k.check("function|string",g.url)||q("The service URL is not valid.");W[g.id]!==h&&q('The service "'+g.id+'" already exists.');W[g.id]=function(b){C('Calling service "'+g.id+'".');var a=b||{},c=a.shortcuts||{},p={contentType:a.contentType||g.contentType,dataType:a.dataType||g.dataType,type:(a.type||g.type||"GET").toString().toUpperCase(),data:a.data!==h?a.data:"function"===
k.get(g.data)?g.data.call(j(),a):g.data,url:"function"===k.get(g.url)?g.url.call(j(),a):g.url,error:function(b,c){I.dispatchEvent("domino.ajaxFailed");var F=a.error||g.error;C('Loading service "'+g.id+'" failed with message "'+b+'" and status '+c.status+".");"function"===k.get(F)&&G(F,{parameters:[b,c,a],loop:!0,scope:{request:!0,dispatchEvent:!0}})}},f,e,o;e=A("shortcutPrefix");var b=RegExp(e+"(\\w+)","g"),i=RegExp("^"+e+"(\\w+)$"),d=null,m;for("string"!==k.get(p.url)&&q('The URL is no more a string (typed "'+
k.get(p.url)+'")');(m=p.url.match(b))&&p.url!==d;)for(f in d=p.url,m)e=P(m[f].match(i)[1],c),p.url=p.url.replace(RegExp(m[f],"g"),e);f=!0;"string"===k.get(p.data)&&p.data.match(i)&&(p.data=P(p.data.match(i)[1],c));if("object"===k.get(p.data))for(;f;)for(o in f=!1,p.data)"string"===k.get(p.data[o])&&p.data[o].match(i)&&(p.data[o]=P(p.data[o].match(i)[1],c),f=!0);p.success=function(b){var F,f,e,d,ba={},ja=[],m=[],q={},n=!1,B=a.path||g.path,m=a.setter||g.setter,s=a.success||g.success;d=a.expect||g.expect||
A("expect");if("function"===k.get(d)&&!d.call(j(),b,a,g))p.error.call(this,"Unexpected data received.",this.xhr());else{C('Service "'+g.id+'" successfull.');"string"===k.get(m)&&m.match(i)&&(m=P(m.match(i)[1],c));"string"===k.get(B)&&B.match(i)&&(B=P(B.match(i)[1],c));d=b;(B||"").match(/^(?:\w+\.)*\w+$/)?f=k.get(B,"string")?B.split("."):h:"string"===k.get(B)&&t('Path "'+B+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(f)for(F in f)d=d[f[F]],d===h&&t('Wrong path "'+B+'" for service "'+g.id+'".');
f=x.array(g.events);for(F in f)ba[f[F]]=1,n=!0;f=x.array(a.events);for(F in f)ba[f[F]]=1,n=!0;m&&D[m]&&d!==h&&(q[m]=d,n=!0);if("function"===k.get(s)){b=G(s,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});f=x.array(b.events);for(o in f)n=!0,ba[f[o].type]=1;for(o in b.update)q[o]===h?(q[o]=b.update[o],n=!0):t('The key "'+o+'" is nor a method neither a property.');if((b.services||[]).length)n=!0,ja=ja.concat(b.services);l(b)}m=[];for(e in ba)I.dispatchEvent(e,j()),m.push(I.getEvent(e,j()));n&&
r({events:m,update:q,services:ja})}};f=a.before||g.before;null!=f&&"function"===k.get(f)&&G(f,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});a.abort&&ca[g.id]&&ca[g.id].abort();ca[g.id]=x.ajax(p)};return I}function e(b,g){var a,c={},e={},p,r,d;b===h&&q("Module class not specified.");"function"!==k.get(b)&&q("First parameter must be a function.");b.apply(c,(g||[]).concat(j()));p=c.triggers||{};for(d in p.events||{})R[d]=R[d]||[],R[d].push(p.events[d]);for(r in p.properties||{}){for(a in V[r]||
[])S[r]=S[r]||[],S[r].push(p.properties[r]);E[r]!==h&&(o(r),G(p.properties[r],{parameters:[j()]}))}for(d in Q||{})e[d]=1;for(d in H||{})e[d]=1;for(d in J||{})e[d]=1;for(d in e)c.addEventListener(d,f);X.push(c);return c}function c(b,g){var a="object"===typeof b&&1===arguments.length?b||{}:{};"string"===typeof b&&(a[b]=g);r({update:a});return this}function f(b){r({events:[b],emitter:b.target})}function r(b){var g,a,c,f,d,e,o,i=!1,k=[],n=[],s=[],b=b||{},u={},v={};b.loop=(+b.loop||0)+1;b.loopId=b.loopId||
++$;A("maxDepth")&&b.loop>A("maxDepth")&&q("Loop "+b.loopId+" exceeds maximum depth ("+A("maxDepth")+")");var w=x.array(b.events);e=x.array(b.services);var z=b.update||{};if(A("verbose")){C("Iteration "+b.loop+" (loop "+b.loopId+")");if(w.length){o=[];for(a in w)o.push(w[a].type);C(" -> Events: ",o)}if(e.length){o=[];for(a in e)o.push(e[a].service);C(" -> Services: ",o)}o=[];for(a in z)o.push(a);o.length&&C(" -> Update: ",o)}for(g in z)if(D[g]===h)t('The property "'+g+'" is not referenced.');else if(o=
B(g,z[g])||!!b.force){for(a in S[g])G(S[g][a],{parameters:[j(),{property:g,emitter:b.emitter}]});for(a in V[g]||[])u[V[g][a]]=1}for(a in e||[])m(e[a].service,e[a].params);for(a in w){d=w[a];for(c in e=d.data||{},g=Q[d.type]||[],g)e[g[c]]!==h&&(i=!0,v[g[c]]=e[g[c]]);for(f in R[d.type])G(R[d.type][f],{parameters:[j(),d,b.emitter]});for(c in H[d.type]||[])if(0>k.indexOf(H[d.type][c])){k.push(H[d.type][c]);e=G(H[d.type][c],{parameters:[d],scope:{request:!0,dispatchEvent:!0}});g=x.array(e.events);for(f in g)u[g[f].type]=
1;for(f in e.update)v[f]===h?(i=!0,v[f]=e.update[f]):t('The property "'+f+'" has already been updated in the current loop.');if((e.services||[]).length)i=!0,s=s.concat(e.services);l(e)}for(c in J[d.type]||[])u[J[d.type][c]]=1}for(d in u)I.dispatchEvent(d,j()),n.push(I.getEvent(d,j())),i=!0;i&&r({events:n,update:v,services:s,emitter:b.emitter,loopId:b.loopId,loop:b.loop})}function o(b){if(E[b]){if(ia[b]){for(var a=[],c={},f=1,d=arguments.length;f<d;f++)a.push(arguments[f]);c[b]=M[b];a=G(E[b],{parameters:a,
inputValues:c});return y(b)?x.clone(a.returned):a.returned}return y(b)?x.clone(E[b]()):E[b]()}t('Property "'+b+'" not referenced.')}function B(b,a){if(D[b]){if(ha[b]){var c,f;c=[];f={};y(b)&&(a=x.clone(a));f[b]=o(b);for(var d=1,e=arguments.length;d<e;d++)c.push(arguments[d]);f=G(D[b],{parameters:c,inputValues:f});(c="boolean"!==k.get(f.returned)||f.returned)&&(M[b]=f.update[b]);return c}return D[b].call(j(),y(b)?x.clone(a):a)}t('Property "'+b+'" not referenced.');return!1}function m(b,a){if(W[b])W[b](a);
else t('Service "'+b+'" not referenced.');return this}function G(b,a){var c,f,d=a||{},e=j(d.scope);"function"!==k.get(b)&&q("The first parameter must be a function");for(c in d.inputValues||{})e[c]=d.inputValues[c];f={returned:b.apply(e,d.parameters||[]),update:{},events:[],services:[]};null!=e._events&&!k.check("array",e._events)?t("Events must be stored in an array."):f.events=e._events;for(c in e)D[c]!==h?f.update[c]=e[c]:aa[c]===h&&t('The key "'+c+'" is not a method nor a property.');for(c in d.inputValues)f.update[c]=
e[c];for(c in e._services)f.services[c]=e._services[c];if(d.loop){d=(f.services||[]).length||(f.events||[]).length;if(!d)for(c in f.update)d=!0;d&&r(f)}else return f}function oa(b){return K[b]}function z(b){return O[b]}function P(b){var a=b,c=(b||"").toString().match(RegExp("^"+A("shortcutPrefix")+"(\\w+)$"));c&&c.length&&(t("Prefix in expand() calls is deprecated."),a=c[1]);for(var c=1,f=arguments.length;c<f;c++)if((arguments[c]||{})[a]!==h)return arguments[c][a];if("function"===k.get(E[a]))return o(a);
if("function"===k.get(Y[a]))return Y[a].call(j());t('The shortcut "',a,'" has not been recognized.');return a}function y(b){b=(ga[b]||{}).clone;return b!==h?!!b:A("clone")}function T(){var b;C('Killing instance "'+w+'"');for(b in X)X[b].removeEventListener();Y=ca=W=J=H=S=R=V=Q=X=ha=ia=M=D=E=O=K=N=X=null;for(b in Z)delete Z[b];U[w]&&delete U[w]}function A(b,a){if("string"===typeof b&&1===arguments.length)return da[b]!==h?da[b]:L[b];var c="object"===typeof b&&1===arguments.length?b||{}:{};"string"===
typeof b&&(c[b]=a);for(var f in c)c[f]!==h?da[f]=c[f]:delete da[f];return this}function t(){var b=["["+(w||"domino")+"]"];A("strict")||b.push("WARNING");for(var a in arguments)b.push(arguments[a]);A("strict")?v.apply(this,b):A("verbose")&&ea.apply(this,b)}function q(){var b=["["+(w||"domino")+"]"],a;for(a in arguments)b.push(arguments[a]);v.apply(this,b)}function C(){var b=["["+(w||"domino")+"]"];if(A("verbose")){for(var a in arguments)b.push(arguments[a]);ea.apply(this,b)}}la.call(this);var I=this,
x=s.utils,k=s.struct,da={},Z,N={},K={},O={},E={},D={},M={},ga={},ia={},ha={},X=[],$=0,Q={},V={},R={},S={},H={},J={},W={},ca={},Y={},aa={events:1,services:1,hacks:1};(function(){for(var b in Object.prototype)aa[b]=1;for(b in j({full:!0}))aa[b]=1})();Z=j({full:!0});var u={},w;"string"===k.get(a)?w=a:a!==h&&"object"===k.get(a)?u=a:d!==h&&"object"===k.get(d)&&(u=d);(w=u.name)&&(U[w]?q('An instance named "'+w+'" is already running.'):U[w]=Z);(function(){for(var b in u.properties||[])i(u.properties[b].id,
u.properties[b]);for(b in u.hacks||[]){var a=void 0,c=void 0,f=u.hacks[b]||{};f.triggers===h&&q("A hack requires at least one trigger to be bound");a=x.array(f.triggers);for(c in a)J[a[c]]=J[a[c]]||[],H[a[c]]=H[a[c]]||[],f.method&&H[a[c]].push(f.method),f.dispatch&&(J[a[c]]=J[a[c]].concat(x.array(f.dispatch)))}for(b in u.services||[])n(u.services[b]);for(b in u.shortcuts||[])a=u.shortcuts[b].id,c=u.shortcuts[b].method,a===h&&q("Shortcut ID not specified."),Y[a]&&q('Shortcut "'+a+'" already exists.'),
c===h&&q("Shortcut method not specified."),Y[a]=c})();return Z};var s=K.domino;s.utils={array:function(a,d){var h="string"===s.struct.get(a)?a.split(d||" "):"array"===s.struct.get(a)?a:[a],l=[],i;for(i in h)h[i]&&l.push(h[i]);return l},clone:function(a){if(!a)return a;var d,h;if("array"===y.get(a))for(h in d=[],a)d[h]=this.clone(a[h]);else if("date"===y.get(a))d=new Date(a.getTime());else if("object"===y.get(a))if(a.prototype)d=a;else{d={};for(var l in a)d[l]=this.clone(a[l])}else d=a;return d},ajax:function(a,
d){"string"===typeof a?a={url:a,ok:d}:"object"!==y.get(a)&&v("[domino.global] Invalid parameter given to AJAX");var h=a.type||"GET",l=a.url||"",i=a.contentType||"application/x-www-form-urlencoded",n=a.dataType||"json",e=new XMLHttpRequest,c,f,r;if(a.data){if("string"===typeof a.data)f=a.data;else if(/json/.test(i))f=JSON.stringify(a.data);else{f=[];for(r in a.data)f.push(encodeURIComponent(r)+"="+encodeURIComponent(a.data[r]));f=f.join("&")}/GET|DEL/i.test(h)&&(l+=/\?/.test(l)?"&"+f:"?"+f,f="")}e.onreadystatechange=
function(){if(4==e.readyState)if(c&&clearTimeout(c),/^2/.test(e.status)){f=e.responseText;if(/json/.test(n))try{f=JSON.parse(e.responseText)}catch(d){return a.error&&a.error("JSON parse error: "+d.message,e)}a.success&&a.success(f,e)}else{var h=+e.status?e.responseText:e.responseText.length?"Aborted: "+e.responseText:"Aborted";a.error&&a.error(h,e)}};e.open(h,l,!0);e.setRequestHeader("Content-Type",i);if(a.headers)for(r in a.headers)e.setRequestHeader(r,a.headers[r]);a.timeout&&(c=setTimeout(function(){e.onreadystatechange=
function(){};e.abort();a.error&&a.error&&a.error("timeout",e)},1E3*a.timeout));e.send(f);return e}};s.struct=function(){var a=["number","string","boolean","null","undefined"],d="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),j={},l=["*"],i={},n;for(n in d){var e=d[n];l.push(e.toLowerCase());j["[object "+e+"]"]=e.toLowerCase()}return{add:function(a,f,d){var e,j,m,n,y,z;1===arguments.length?"object"===this.get(a)?(z=a,m=z.id,y=z.struct):v("[domino.global] If struct.add is called with one arguments, it has to be an object"):
2===arguments.length?("string"!==this.get(a)||!a?v("[domino.global] If struct.add is called with more than one arguments, the first one must be the string id"):m=a,y=f):v("[domino.global] struct.add has to be called with one or three arguments");("string"!==this.get(m)||0===m.length)&&v("[domino.global] A structure requires an string id");i[m]!==h&&"proto"!==i[m]&&v('[domino.global] The structure "'+m+'" already exists');i[m]=1;j=s.utils.array((z||{}).proto);n={};for(e in j)i[j[e]]===h&&(i[j[e]]=
1,n[j[e]]=1);"function"!==this.get(y)&&!this.isValid(y)&&v('[domino.global] A structure requires a valid "structure" property describing the structure. It can be a valid structure or a function that test if an object matches the structure.');~l.indexOf(m)&&v('[domino.global] "'+m+'" is a reserved structure name');i[m]=z===h?{id:m,struct:y}:{};if(z!==h)for(e in z)i[m][e]=z[e];for(e in n)e!==m&&delete i[e]},get:function(a){return null==a?""+a:j[Object.prototype.toString.call(a)]||"object"},check:function(a,
f){var d,e,j=this.get(f);if("string"===this.get(a)){d=a.replace(/^\?/,"").split(/\|/);for(e in d)if(0>l.indexOf(d[e])&&i[d[e]]===h)return $("[domino.global] Invalid type"),!1;if(null==f)return!!a.match(/^\?/,"");a.replace(/^\?/,"");for(e in d)if(i[d[e]]&&("function"===this.get(i[d[e]].struct)&&!0===i[d[e]].struct(f)||this.check(i[d[e]].struct,f)))return!0;return!(!~d.indexOf("*")&&!~d.indexOf(j))}if("object"===this.get(a)){if("object"!==j)return!1;for(d in a)if(!this.check(a[d],f[d]))return!1;for(d in f)if(a[d]===
h)return!1;return!0}if("array"===this.get(a)){if("array"!==j)return!1;if(1!==a.length)return $("[domino.global] Invalid type"),!1;for(d in f)if(!this.check(a[0],f[d]))return!1;return!0}return!1},deepScalar:function(c){var f;if("string"===this.get(c)){c=c.replace(/^\?/,"").split(/\|/);for(f in c)if(0>a.indexOf(c[f]))return!1;return!0}if(this.check("object|array",c)){for(f in c)if(!this.deepScalar(c[f]))return!1;return!0}return!1},compare:function(a,f,d){this.get(a);this.get(f);var e;if(!this.deepScalar(d)||
!this.check(d,a)||!this.check(d,f))return!1;if("string"===this.get(d))return a===f;if("object"===this.get(d)){for(e in d)if(!this.compare(a[e],f[e],d[e]))return!1;return!0}if("array"===this.get(d)){if(a.length!==f.length)return!1;var h=a.length;for(e=0;e<h;e++)if(!this.compare(a[e],f[e],d[0]))return!1;return!0}return!1},isValid:function(a){var d,e;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(e in a)if(0>l.indexOf(a[e])&&i[a[e]]===h)return!1;return!0}if("object"===this.get(a)){for(d in a)if(!this.isValid(a[d]))return!1;
return!0}return"array"===this.get(a)?1===a.length?this.isValid(a[0]):!1:!1}}}();var T=s.utils,y=s.struct,L={strict:!1,verbose:!1,shortcutPrefix:":",displayTime:!1,clone:!1};s.settings=function(a,d){if("string"===typeof a&&1===arguments.length)return L[a];var j="object"===typeof a&&1===arguments.length?a||{}:{};"string"===typeof a&&(j[a]=d);for(var l in j)j[l]!==h?L[l]=j[l]:delete L[l];return this};s.instances=function(a){if(arguments.length)return U[a];v("[domino.global] You need to indicate a name to get the instance.")};
s.EventDispatcher=function(){var a={};this.removeEventListener=function(d,h){if(!arguments.length)return this._handlers_={},this;var l,i,n,e,c=T.array(d);if(h)for(l in c){e=c[l];if(a[e]){n=[];for(i in a[e])a[e][i].handler!==h&&n.push(a[e][i]);a[e]=n}a[e]&&0===a[e].length&&delete a[e]}else for(l in c)delete a[c[l]];return this};this.addEventListener=function(d,h){if(arguments.length)if(1===arguments.length&&"object"===T.type.get(arguments[0]))for(d in arguments[0])this.addEventListener(d,arguments[0][d]);
else if(1<arguments.length){var l,d=arguments[0],h=arguments[1],i=T.array(d),n;for(n in i)l=i[n],a[l]||(a[l]=[]),a[l].push({handler:h})}return this};this.dispatchEvent=function(d,j){var l,i,n,e,c,f=T.array(d),j=j===h?{}:j;for(l in f)if(c=f[l],a[c]){e=this.getEvent(c,j);n=[];for(i in a[c])a[c][i].handler(e),a[c][i].one||n.push(a[c][i]);a[c]=n}return this};this.getEvent=function(a,h){return{type:a,data:h,target:this}}};var la=s.EventDispatcher;s.module=function(){la.call(this);this.triggers={properties:{},
events:{}}}})(window);
