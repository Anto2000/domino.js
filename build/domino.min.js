/* domino.js - a JS fast dashboard prototyping framework - Version: 1.1 - Author:  Alexis Jacomy, Linkfluence - License: MIT */
(function(w){function fa(){J.strict?s.apply(this,arguments):ia.apply(this,arguments)}function s(){var a="",f;for(f in arguments)a+=(a?" ":"")+arguments[f];throw Error(a);}function ia(){J.verbose&&ba.apply(this,arguments)}function ba(){var a=[],f;for(f in arguments)a.push(arguments[f]);J.displayTime&&a.unshift(("00000000"+((new Date).getTime()-ja)).substr(-8));console&&"function"===typeof console.log&&console.log.apply(console,a)}var ga=/^[a-zA-Z_$-][a-zA-Z_$0-9-]*$/,ja=new Date,R={};if(w.domino)throw Error("domino already exists");
w.domino=function(a,f){function i(b){var b=b||{},g={getEvents:ka,getLabel:la,expand:p,warn:q,log:A,die:n,get:h};b.full?(g.kill=Q,g.update=c,g.addModule=k,g.request=B,g.settings=E,g.dispatchEvent=function(b,g){m({events:H.getEvent(b,g)})}):(b.request&&(Object.defineProperty(g,"_services",{value:[]}),g.request=function(b,g){this._services.push({service:b,params:g})}),b.dispatchEvent&&(Object.defineProperty(g,"_events",{value:[]}),g.dispatchEvent=function(b,g){this._events.push({type:b,data:g})}));return g}
function e(b,g){var v,a,d=g||{};void 0===b&&n("Property name not specified");"string"!==l.get(b)&&n("The property name must be a string");void 0!==K[b]&&n('Property "'+b+'" already exists');void 0!==Y[b]&&n('"'+b+'" can not be used to name a property');b.match(ga)||n("Property name not valid ("+ga+")");ca[b]={};for(a in d)ca[b][a]=d[a];w[b]=d.label||b;void 0!==d.type&&(l.isValid(d.type)?L[b]=d.type:q('Property "'+b+'": Type not valid'));void 0!==d.setter&&("function"!==l.get(d.setter)?q('Property "'+
b+'": Setter is not a function'):(C[b]=d.setter,da[b]=!0));C[b]=C[b]||function(g){if(l.deepScalar(L[b])&&l.compare(g,K[b],L[b]))return!1;L[b]&&!l.check(L[b],g)?q('Property "'+b+'": Wrong type error'):K[b]=g;return!0};void 0!==d.getter&&("function"!==l.get(d.getter)?q('Property "'+b+'": Getter is not a function'):(D[b]=d.getter,ea[b]=!0));D[b]=D[b]||function(){return K[b]};if(void 0!==d.value||L[b])void 0!==d.value?y(b,d.value):A('Property "'+b+'": Initial value is missing');if(void 0!==d.triggers)for(v in!l.check("array|string",
d.triggers)&&q('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),M[b]=u.array(d.triggers),M[b]||[])N[M[b][v]]=N[M[b][v]]||[],N[M[b][v]].push(b);void 0!==d.dispatch&&(!l.check("array|string",d.dispatch)?q('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):T[b]=u.array(d.dispatch));return H}function j(b){var g=b||{};(void 0===g.id||"string"!==l.get(g.id))&&n("The service id is not indicated.");
l.check("function|string",g.url)||n("The service URL is not valid.");void 0!==U[g.id]&&n('The service "'+g.id+'" already exists.');U[g.id]=function(b){A('Calling service "'+g.id+'".');var a=b||{},d=a.shortcuts||{},b={contentType:a.contentType||g.contentType,dataType:a.dataType||g.dataType,type:(a.type||g.type||"GET").toString().toUpperCase(),data:void 0!==a.data?a.data:"function"===l.get(g.data)?g.data.call(i(),a):g.data,url:"function"===l.get(g.url)?g.url.call(i(),a):g.url,error:function(b,d){H.dispatchEvent("domino.ajaxFailed");
var v=a.error||g.error;"function"===l.get(v)?F(v,{parameters:[b,d,a],loop:!0,scope:{request:!0,dispatchEvent:!0}}):A('Loading service "'+g.id+'" failed with message "'+b+'" and status '+d.status+".")}},t,h,f;h=E("shortcutPrefix");var c=RegExp(h+"(\\w+)","g"),e=RegExp("^"+h+"(\\w+)$"),j=null,y;for("string"!==l.get(b.url)&&n('The URL is no more a string (typed "'+l.get(b.url)+'")');(y=b.url.match(c))&&b.url!==j;)for(t in j=b.url,y)h=p(y[t].match(e)[1],d),b.url=b.url.replace(RegExp(y[t],"g"),h);t=!0;
"string"===l.get(b.data)&&b.data.match(e)&&(b.data=p(b.data.match(e)[1],d));if("object"===l.get(b.data))for(;t;)for(f in t=!1,b.data)"string"===l.get(b.data[f])&&b.data[f].match(e)&&(b.data[f]=p(b.data[f].match(e)[1],d),t=!0);b.success=function(b){A('Service "'+g.id+'" successfull.');var v,h,t,c,y={},j=[];c=[];var Z={},n=!1,k=a.path||g.path,B=a.setter||g.setter,o=a.success||g.success;"string"===l.get(B)&&B.match(e)&&(B=p(B.match(e)[1],d));"string"===l.get(k)&&k.match(e)&&(k=p(k.match(e)[1],d));c=
b;(k||"").match(/^(?:\w+\.)*\w+$/)?h=l.get(k,"string")?k.split("."):void 0:"string"===l.get(k)&&q('Path "'+k+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(h)for(v in h)c=c[h[v]],void 0===c&&q('Wrong path "'+k+'" for service "'+g.id+'".');h=u.array(g.events);for(v in h)y[h[v]]=1,n=!0;h=u.array(a.events);for(v in h)y[h[v]]=1,n=!0;B&&C[B]&&void 0!==c&&(Z[B]=c,n=!0);if("function"===l.get(o)){b=F(o,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});h=u.array(b.events);for(f in h)n=!0,y[h[f].type]=
1;for(f in b.update)void 0===Z[f]?(Z[f]=b.update[f],n=!0):q('The key "'+f+'" is nor a method neither a property.');if((b.services||[]).length)n=!0,j=j.concat(b.services)}c=[];for(t in y)H.dispatchEvent(t,i()),c.push(H.getEvent(t,i()));n&&m({events:c,update:Z,services:j})};t=a.before||g.before;null!=t&&"function"===l.get(t)&&F(t,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});a.abort&&$[g.id]&&$[g.id].abort();$[g.id]=u.ajax(b)};return H}function k(b,g){var a,S={},f={},c,m,e;void 0===b&&n("Module class not specified.");
"function"!==l.get(b)&&n("First parameter must be a function.");b.apply(S,(g||[]).concat(i()));c=S.triggers||{};for(e in c.events||{})O[e]=O[e]||[],O[e].push(c.events[e]);for(m in c.properties||{}){for(a in T[m]||[])P[m]=P[m]||[],P[m].push(c.properties[m]);void 0!==D[m]&&(h(m),F(c.properties[m],{parameters:[i()]}))}for(e in N||{})f[e]=1;for(e in G||{})f[e]=1;for(e in I||{})f[e]=1;for(e in f)S.addEventListener(e,d);V.push(S);return S}function c(b,g){var a="object"===typeof b&&1===arguments.length?
b||{}:{};"string"===typeof b&&(a[b]=g);m({update:a});return this}function d(b){m({events:[b]})}function m(b){var g,a,d,h,c,e,f,j=!1,l=[],k=[],n=[],b=b||{},o={},p={};b.loop=(+b.loop||0)+1;var r=u.array(b.events);e=u.array(b.services);var s=b.update||{};if(E("verbose")){A("Iteration "+b.loop+" (main loop)");if(r.length){f=[];for(a in r)f.push(r[a].type);A(" -> Events: ",f)}if(e.length){f=[];for(a in e)f.push(e[a].service);A(" -> Services: ",f)}f=[];for(a in s)f.push(a);f.length&&A(" -> Update: ",f)}for(g in s)if(void 0===
C[g])q('The property "'+g+'" is not referenced.');else if(f=y(g,s[g])||!!b.force){for(a in P[g])F(P[g][a],{parameters:[i(),{property:g}]});for(a in T[g]||[])o[T[g][a]]=1}for(a in e||[])B(e[a].service,e[a].params);for(a in r){c=r[a];for(d in e=c.data||{},g=N[c.type]||[],g)void 0!==e[g[d]]&&(j=!0,p[g[d]]=e[g[d]]);for(h in O[c.type])F(O[c.type][h],{parameters:[i(),c]});for(d in G[c.type]||[])if(0>l.indexOf(G[c.type][d])){l.push(G[c.type][d]);e=F(G[c.type][d],{parameters:[c],scope:{request:!0,dispatchEvent:!0}});
g=u.array(e.events);for(h in g)o[g[h].type]=1;for(h in e.update)void 0===p[h]?(j=!0,p[h]=e.update[h]):q('The property "'+h+'" has already been updated in the current loop.');if((e.services||[]).length)j=!0,n=n.concat(e.services)}for(d in I[c.type]||[])o[I[c.type][d]]=1}for(c in o)H.dispatchEvent(c,i()),k.push(H.getEvent(c,i())),j=!0;j&&m({events:k,update:p,services:n,loop:b.loop})}function h(b){if(D[b]){if(ea[b]){for(var a=[],d={},c=1,e=arguments.length;c<e;c++)a.push(arguments[c]);d[b]=K[b];a=F(D[b],
{parameters:a,inputValues:d});return x(b)?u.clone(a.returned):a.returned}return x(b)?u.clone(D[b]()):D[b]()}q('Property "'+b+'" not referenced.')}function y(b,a){if(C[b]){if(da[b]){var d,c;d=[];c={};x(b)&&(a=u.clone(a));c[b]=h(b);for(var e=1,f=arguments.length;e<f;e++)d.push(arguments[e]);c=F(C[b],{parameters:d,inputValues:c});(d="boolean"!==l.get(c.returned)||c.returned)&&(K[b]=c.update[b]);return d}return C[b].call(i(),x(b)?u.clone(a):a)}q('Property "'+b+'" not referenced.');return!1}function B(b,
a){if(U[b])U[b](a);else q('Service "'+b+'" not referenced.');return this}function F(b,a){var d,c,e=a||{},h=i(e.scope);"function"!==l.get(b)&&n("The first parameter must be a function");for(d in e.inputValues||{})h[d]=e.inputValues[d];c={returned:b.apply(h,e.parameters||[]),update:{},events:[],services:[]};null!=h._events&&!l.check("array",h._events)?q("Events must be stored in an array."):c.events=h._events;for(d in h)void 0!==C[d]?c.update[d]=h[d]:void 0===Y[d]&&q('The key "'+d+'" is not a method nor a property.');
for(d in e.inputValues)c.update[d]=h[d];for(d in h._services)c.services[d]=h._services[d];if(e.loop){e=(c.services||[]).length||(c.events||[]).length;if(!e)for(d in c.update)e=!0;e&&m(c)}else return c}function la(b){return w[b]}function ka(b){return M[b]}function p(b){var a=b,d=(b||"").toString().match(RegExp("^"+E("shortcutPrefix")+"(\\w+)$"));d&&d.length&&(q("Prefix in expand() calls is deprecated."),a=d[1]);for(var d=1,c=arguments.length;d<c;d++)if(void 0!==(arguments[d]||{})[a])return arguments[d][a];
if("function"===l.get(D[a]))return h(a);if("function"===l.get(W[a]))return W[a].call(i());q('The shortcut "',a,'" has not been recognized.');return a}function x(b){b=(ca[b]||{}).clone;return void 0!==b?!!b:E("clone")}function Q(){var b;A('Killing instance "'+z+'"');for(b in V)V[b].removeEventListener();W=$=U=I=G=P=O=T=N=V=da=ea=K=C=D=M=w=L=V=null;for(b in X)delete X[b];R[z]&&delete R[z]}function E(b,a){if("string"===typeof b&&1===arguments.length)return void 0!==aa[b]?aa[b]:J[b];var d="object"===
typeof b&&1===arguments.length?b||{}:{};"string"===typeof b&&(d[b]=a);for(var c in d)void 0!==d[c]?aa[c]=d[c]:delete aa[c];return this}function q(){var b=["["+(z||"domino")+"]"];E("strict")||b.push("WARNING");for(var a in arguments)b.push(arguments[a]);E("strict")?s.apply(this,b):E("verbose")&&ba.apply(this,b)}function n(){var b=["["+(z||"domino")+"]"],a;for(a in arguments)b.push(arguments[a]);s.apply(this,b)}function A(){var b=["["+(z||"domino")+"]"];if(E("verbose")){for(var a in arguments)b.push(arguments[a]);
ba.apply(this,b)}}ha.call(this);var H=this,u=o.utils,l=o.struct,aa={},X,L={},w={},M={},D={},C={},K={},ca={},ea={},da={},V=[],N={},T={},O={},P={},G={},I={},U={},$={},W={},Y={events:1,services:1,hacks:1};(function(){for(var b in Object.prototype)Y[b]=1;for(b in i({full:!0}))Y[b]=1})();X=i({full:!0});var r={},z;"string"===l.get(a)?z=a:void 0!==a&&"object"===l.get(a)?r=a:void 0!==f&&"object"===l.get(f)&&(r=f);(z=r.name)&&(R[z]?n('An instance named "'+z+'" is already running.'):R[z]=X);(function(){for(var b in r.properties||
[])e(r.properties[b].id,r.properties[b]);for(b in r.hacks||[]){var a=void 0,d=void 0,c=r.hacks[b]||{};void 0===c.triggers&&n("A hack requires at least one trigger to be bound");a=u.array(c.triggers);for(d in a)I[a[d]]=I[a[d]]||[],G[a[d]]=G[a[d]]||[],c.method&&G[a[d]].push(c.method),c.dispatch&&(I[a[d]]=I[a[d]].concat(u.array(c.dispatch)))}for(b in r.services||[])j(r.services[b]);for(b in r.shortcuts||[])a=r.shortcuts[b].id,d=r.shortcuts[b].method,void 0===a&&n("Shortcut ID not specified."),W[a]&&
n('Shortcut "'+a+'" already exists.'),void 0===d&&n("Shortcut method not specified."),W[a]=d})();return X};var o=w.domino;o.utils={array:function(a,f){var i="string"===o.struct.get(a)?a.split(f||" "):"array"===o.struct.get(a)?a:[a],e=[],j;for(j in i)i[j]&&e.push(i[j]);return e},clone:function(a){if(!a)return a;var f,i;if("array"===x.get(a))for(i in f=[],a)f[i]=this.clone(a[i]);else if("date"===x.get(a))f=new Date(a.getTime());else if("object"===x.get(a))if(a.prototype)f=a;else{f={};for(var e in a)f[e]=
this.clone(a[e])}else f=a;return f},ajax:function(a,f){"string"===typeof a?a={url:a,ok:f}:"object"!==x.get(a)&&s("[domino.global] Invalid parameter given to AJAX");var i=a.type||"GET",e=a.url||"",j=a.contentType||"application/x-www-form-urlencoded",k=a.dataType||"json",c=new XMLHttpRequest,d,m,h;if(a.data){if("string"===typeof a.data)m=a.data;else if(/json/.test(j))m=JSON.stringify(a.data);else{m=[];for(h in a.data)m.push(encodeURIComponent(h)+"="+encodeURIComponent(a.data[h]));m=m.join("&")}/GET|DEL/i.test(i)&&
(e+=/\?/.test(e)?"&"+m:"?"+m,m="")}c.onreadystatechange=function(){if(4==c.readyState)if(d&&clearTimeout(d),/^2/.test(c.status)){m=c.responseText;if(/json/.test(k))try{m=JSON.parse(c.responseText)}catch(e){return a.error&&a.error("JSON parse error: "+e.message,c)}a.success&&a.success(m,c)}else{var h=+c.status?c.responseText:c.responseText.length?"Aborted: "+c.responseText:"Aborted";a.error&&a.error(h,c)}};c.open(i,e,!0);c.setRequestHeader("Content-Type",j);if(a.headers)for(h in a.headers)c.setRequestHeader(h,
a.headers[h]);a.timeout&&(d=setTimeout(function(){c.onreadystatechange=function(){};c.abort();a.error&&a.error&&a.error("timeout",c)},1E3*a.timeout));c.send(m);return c}};o.struct=function(){var a=["number","string","boolean","null","undefined"],f="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),i={},e=["*"],j={},k;for(k in f){var c=f[k];e.push(c.toLowerCase());i["[object "+c+"]"]=c.toLowerCase()}return{add:function(a,c,h){var f,i,k,x,w,p;1===arguments.length?"object"===this.get(a)?
(p=a,k=p.id,w=p.struct):s("[domino.global] If struct.add is called with one arguments, it has to be an object"):2===arguments.length?("string"!==this.get(a)||!a?s("[domino.global] If struct.add is called with more than one arguments, the first one must be the string id"):k=a,w=c):s("[domino.global] struct.add has to be called with one or three arguments");("string"!==this.get(k)||0===k.length)&&s("[domino.global] A structure requires an string id");void 0!==j[k]&&"proto"!==j[k]&&s('[domino.global] The structure "'+
k+'" already exists');j[k]=1;i=o.utils.array((p||{}).proto);x={};for(f in i)void 0===j[i[f]]&&(j[i[f]]=1,x[i[f]]=1);"function"!==this.get(w)&&!this.isValid(w)&&s('[domino.global] A structure requires a valid "structure" property describing the structure. It can be a valid structure or a function that test if an object matches the structure.');~e.indexOf(k)&&s('[domino.global] "'+k+'" is a reserved structure name');j[k]=void 0===p?{id:k,struct:w}:{};if(void 0!==p)for(f in p)j[k][f]=p[f];for(f in x)f!==
k&&delete j[f]},get:function(a){return null==a?""+a:i[Object.prototype.toString.call(a)]||"object"},check:function(a,c){var h,f,i=this.get(c);if("string"===this.get(a)){h=a.replace(/^\?/,"").split(/\|/);for(f in h)if(0>e.indexOf(h[f])&&void 0===j[h[f]])return fa("[domino.global] Invalid type"),!1;if(null==c)return!!a.match(/^\?/,"");a.replace(/^\?/,"");for(f in h)if(j[h[f]]&&("function"===this.get(j[h[f]].struct)&&!0===j[h[f]].struct(c)||this.check(j[h[f]].struct,c)))return!0;return!(!~h.indexOf("*")&&
!~h.indexOf(i))}if("object"===this.get(a)){if("object"!==i)return!1;for(h in a)if(!this.check(a[h],c[h]))return!1;for(h in c)if(void 0===a[h])return!1;return!0}if("array"===this.get(a)){if("array"!==i)return!1;if(1!==a.length)return fa("[domino.global] Invalid type"),!1;for(h in c)if(!this.check(a[0],c[h]))return!1;return!0}return!1},deepScalar:function(d){var c;if("string"===this.get(d)){d=d.replace(/^\?/,"").split(/\|/);for(c in d)if(0>a.indexOf(d[c]))return!1;return!0}if(this.check("object|array",
d)){for(c in d)if(!this.deepScalar(d[c]))return!1;return!0}return!1},compare:function(a,c,e){this.get(a);this.get(c);var f;if(!this.deepScalar(e)||!this.check(e,a)||!this.check(e,c))return!1;if("string"===this.get(e))return a===c;if("object"===this.get(e)){for(f in e)if(!this.compare(a[f],c[f],e[f]))return!1;return!0}if("array"===this.get(e)){if(a.length!==c.length)return!1;var i=a.length;for(f=0;f<i;f++)if(!this.compare(a[f],c[f],e[0]))return!1;return!0}return!1},isValid:function(a){var c,f;if("string"===
this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(f in a)if(0>e.indexOf(a[f])&&void 0===j[a[f]])return!1;return!0}if("object"===this.get(a)){for(c in a)if(!this.isValid(a[c]))return!1;return!0}return"array"===this.get(a)?1===a.length?this.isValid(a[0]):!1:!1}}}();var Q=o.utils,x=o.struct,J={strict:!1,verbose:!1,shortcutPrefix:":",displayTime:!1,clone:!1};o.settings=function(a,f){if("string"===typeof a&&1===arguments.length)return J[a];var i="object"===typeof a&&1===arguments.length?a||{}:{};"string"===
typeof a&&(i[a]=f);for(var e in i)void 0!==i[e]?J[e]=i[e]:delete J[e];return this};o.instances=function(a){if(arguments.length)return R[a];s("[domino.global] You need to indicate a name to get the instance.")};o.EventDispatcher=function(){var a={};this.removeEventListener=function(f,i){if(!arguments.length)return this._handlers_={},this;var e,j,k,c,d=Q.array(f);if(i)for(e in d){c=d[e];if(a[c]){k=[];for(j in a[c])a[c][j].handler!==i&&k.push(a[c][j]);a[c]=k}a[c]&&0===a[c].length&&delete a[c]}else for(e in d)delete a[d[e]];
return this};this.addEventListener=function(f,i){if(arguments.length)if(1===arguments.length&&"object"===Q.type.get(arguments[0]))for(f in arguments[0])this.addEventListener(f,arguments[0][f]);else if(1<arguments.length){var e,f=arguments[0],i=arguments[1],j=Q.array(f),k;for(k in j)e=j[k],a[e]||(a[e]=[]),a[e].push({handler:i})}return this};this.dispatchEvent=function(f,i){var e,j,k,c,d,m=Q.array(f),i=void 0===i?{}:i;for(e in m)if(d=m[e],a[d]){c=this.getEvent(d,i);k=[];for(j in a[d])a[d][j].handler(c),
a[d][j].one||k.push(a[d][j]);a[d]=k}return this};this.getEvent=function(a,i){return{type:a,data:i,target:this}}};var ha=o.EventDispatcher;o.module=function(){ha.call(this);this.triggers={properties:{},events:{}}}})(window);
