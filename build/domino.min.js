/* domino.js - a JS fast dashboard prototyping framework - Version: 1.0 - Author:  Alexis Jacomy - License: MIT */
(function(L){function X(){x.strict?T.apply(this,arguments):Y.apply(this,arguments)}function T(){var a="",f;for(f in arguments)a+=arguments[f];throw Error(a);}function Y(){if(x.verbose){var a=[],f;for(f in arguments)a.push(arguments[f]);x.displayTime&&a.unshift(("00000000"+((new Date).getTime()-U)).substr(-8));console.log.apply(console,a)}}var U=new Date;if(L.domino)throw Error("domino already exists");L.domino=function(a,f){function h(b){var b=b||{},o={get:j,getEvents:L,getLabel:K,dump:E,warn:r,die:q,
expand:F,events:[],services:[]};if(b.call||b.full)o.call=function(c,b){this.services.push({service:c,params:b})};b.full&&(o.addModule=l,o.update=d);return o}function e(b,o){var c,n=o||{};void 0===b&&q("Property name not specified");void 0!==G[b]&&q('Property "'+b+'" already exists');void 0!==Q[b]&&q('"'+b+'" can not be used to name a property');Z[b]=n.label||b;void 0!==n.type&&(m.isValid(n.type)?M[b]=n.type:r('Property "'+b+'": Type not valid'));void 0!==n.setter&&("function"!==m.get(n.setter)?r('Property "'+
b+'": Setter is not a function'):(A[b]=n.setter,$[b]=!0));A[b]=A[b]||function(c){if(m.isAtom(M[b])&&c===G[b])return!1;M[b]&&!m.check(M[b],c)?r('Property "'+b+'": Wrong type error'):G[b]=c;return!0};void 0!==n.getter&&("function"!==m.get(n.getter)?r('Property "'+b+'": Getter is not a function'):(D[b]=n.getter,aa[b]=!0));D[b]=D[b]||function(){return G[b]};if(void 0!==n.value||M[b])void 0!==n.value?w(b,n.value):E('Property "'+b+'": Initial value is missing');if(void 0!==n.triggers)for(c in!m.check("array|string",
n.triggers)&&r('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),I[b]=B.array(n.triggers),I[b]||[])N[I[b][c]]=N[I[b][c]]||[],N[I[b][c]].push(b);void 0!==n.dispatch&&(!m.check("array|string",n.dispatch)?r('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):v[b]=B.array(n.dispatch));return p}function i(b){var o=b||{};(void 0===o.id||"string"!==m.get(o.id))&&q("The service id is not indicated.");
m.check("function|string",o.url)||q("The service URL is not valid.");void 0!==R[o.id]&&q('The service "'+o.id+'" already exists.');R[o.id]=function(c){E('Calling service "'+o.id+'".');var b=c||{},c={contentType:b.contentType||o.contentType,dataType:b.dataType||o.dataType,type:(b.type||o.type||"GET").toString().toUpperCase(),data:"function"===m.get(o.data)?o.data.call(h(),b.data):b.data||o.data,url:"function"===m.get(o.url)?o.url.call(h()):o.url,error:function(c,s){p.dispatchEvent("domino.ajaxFailed");
var g=b.error||o.error,f=[],j={},e={},d,i;if("function"===m.get(g)){var z=y(g,{parameters:[c,s,b],scope:{call:!0}}),g=B.array(z.events);for(d in g)e[g[d]]=1;for(d in z.properties)void 0===j[d]?j[d]=z.properties[d]:r('The property "'+d+'" is not a method nor a property.');f=f.concat(z.services||[])}else E('Loading failed with message "'+c+'" and status.');for(i in j)if(void 0===A[i])r("The property is not referenced.");else if(w(i,j[i])){for(a in u[i])y(u[i][a],{parameters:[p.getEvent(i,h())]});for(a in v[i]||
[])e[v[i][a]]=1}for(d in f||[])V(f[d].service,f[d].params);g=[];for(event in e)p.dispatchEvent(event,h()),g.push(p.getEvent(event,h()));g.length&&k(g)}},a,g,s,f,j=x.shortcutPrefix;f=RegExp(j+"(\\w+)","g");for(var j=RegExp("^"+j+"(\\w+)$"),e=null,d;(d=c.url.match(f))&&c.url!==e;)for(a in e=c.url,d)g=F(d[a],b.params),c.url=c.url.replace(RegExp(d[a],"g"),g);f=!0;"string"===m.get(c.data)&&c.data.match(j)&&(c.data=F(c.data,b.params));if("object"===m.get(c.data))for(;f;)for(s in f=!1,c.data)"string"===
m.get(c.data[s])&&c.data[s].match(j)&&(c.data[s]=F(c.data[s],b.params),f=!0);c.success=function(c){var a,g,f,j,d,e=[],H={},i={},z=b.path||o.path,l=b.setter||o.setter,q=b.success||o.success;"string"===m.get(l)&&(l=F(l,b.params));"string"===m.get(z)&&(z=F(z,b.params));d=c;(z||"").match(/^(?:\w+\.)*\w+$/)?g=m.get(z,"string")?z.split("."):void 0:"string"===m.get(z)&&r('Path "'+z+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(g)for(a in g)d=d[g[a]],void 0===d&&r('Wrong path "'+z+'" for service "'+
o.id+'".');g=B.array(o.events);for(a in g)H[g[a]]=1;g=B.array(b.events);for(a in g)H[g[a]]=1;if(l&&A[l]&&w(l,d)){for(s in v[l]||[])H[v[l][s]]=1;for(s in u[l])y(u[l][s],{parameters:[p.getEvent(l,h())]})}if("function"===m.get(q)){c=y(q,{parameters:[c,b],scope:{call:!0}});g=B.array(c.events);for(s in g)H[g[s]]=1;for(s in c.properties)void 0===i[s]?i[s]=c.properties[s]:r('The property "'+s+'" is not a method nor a property.');e=e.concat(c.services||[])}for(j in i)if(void 0===A[j])r("The property is not referenced.");
else if(w(j,i[j])){for(a in u[j])y(u[j][a],{parameters:[p.getEvent(j,h())]});for(a in v[j]||[])H[v[j][a]]=1}for(s in e||[])V(e[s].service,e[s].params);g=[];for(f in H)p.dispatchEvent(f,h()),g.push(p.getEvent(f,h()));g.length&&k(g)};b.abort&&W[o.id]&&W[o.id].abort();W[o.id]=B.ajax(c)};return p}function l(b,a){var c,n={},f={},g,d,e;void 0===b&&q("Module class not specified.");"function"!==m.get(b)&&q("First parameter must be a function.");b.apply(n,(a||[]).concat(h()));g=n.triggers||{};for(e in g.events||
{})O[e]=O[e]||[],O[e].push(g.events[e]);for(d in g.properties||{}){for(c in v[d]||[])u[d]=u[d]||[],u[d].push(g.properties[d]);void 0!==D[d]&&(j(d),y(g.properties[d],{parameters:[p.getEvent("domino.initialUpdate",h())]}))}for(e in N||{})f[e]=1;for(e in J||{})f[e]=1;for(e in P||{})f[e]=1;for(e in f)n.addEventListener(e,k);U.push(n);return n}function k(b,a){var c,n,d,g,e,f,j,i,m=[];c=[];var l=a||{},q={},t={};l.loop=(l.loop||0)+1;var x=B.array(b);for(n in x)c.push(x[n].type);E("Iteration "+l.loop+" (main loop) :",
c);for(n in x){e=x[n];for(d in f=e.data||{},c=N[e.type]||[],c)if(j=!!l.force,void 0!==f[c[d]]&&(j=w(c[d],f[c[d]])||j),j){for(g in u[c[d]])y(u[c[d]][g],{parameters:[p.getEvent(c[d],h())]});for(g in v[c[d]]||[])q[v[c[d]][g]]=1}for(g in O[e.type])y(O[e.type][g],{parameters:[e]});for(d in J[e.type]||[]){f=y(J[e.type][d],{parameters:[e],scope:{call:!0}});c=B.array(f.events);for(g in c)q[c[g]]=1;for(g in f.properties)void 0===t[g]?t[g]=f.properties[g]:r('The property "'+g+'" is not a method nor a property.');
m=m.concat(f.services||[])}for(d in P[e.type]||[])q[P[e.type][d]]=1}for(i in t)if(void 0===A[i])r("The property is not referenced.");else if(w(i,t[i])){for(n in u[i])y(u[i][n],{parameters:[p.getEvent(i,h())]});for(n in v[i]||[])q[v[i][n]]=1}for(g in m||[])V(m[g].service,m[g].params);c=[];for(e in q)p.dispatchEvent(e,h()),c.push(p.getEvent(e,h()));c.length&&k(c,l)}function d(b){var a,c,d,e=[],g={};null==b&&r("Nothing to update.");if("array"===m.get(b))for(c in b)if(e.push(b[c].property),void 0===A[b[c].property])r("The property is not referenced.");
else{if(w.apply([b[c].property,b[c].value].concat(b[c].parameters||[]))){for(a in u[b[c].property])y(u[b[c].property][a],{parameters:[p.getEvent(b[c].property,h())]});for(a in v[b[c].property]||[])g[v[b[c].property][a]]=1}}else if("object"===m.get(b))for(c in b){if(e.push(c),A[c]&&w(c,b[c])){for(a in u[c])y(u[c][a],{parameters:[p.getEvent(c,h())]});for(a in v[c]||[])g[v[c][a]]=1}}else r("The properties must be stored in an array or an object.");E("Updating properties :",e);a=[];for(d in g)p.dispatchEvent(d,
h()),a.push(p.getEvent(d,h()));a.length&&k(a,b);return this}function j(b){if(D[b]){if(aa[b]){for(var a=[],c={},d=1,e=arguments.length;d<e;d++)a.push(arguments[d]);c[b]=G[b];return y(D[b],{parameters:a,inputValues:c}).returned}return D[b]()}r('Property "'+b+'" not referenced.')}function w(b,a){if(A[b]){if($[b]){var c,d;c=[];d={};d[b]=a;for(var e=1,g=arguments.length;e<g;e++)c.push(arguments[e]);d=y(A[b],{parameters:c,inputValues:d});(c="boolean"!==m.get(d.returned)||d.returned)&&(G[b]=d.properties[b]);
return c}return A[b].call(h(),a)}r('Property "'+b+'" not referenced.');return!1}function V(b,a){if(R[b])R[b](a);else r('Service "'+b+'" not referenced.');return this}function y(b,a){var c,d,e=a||{},g=h(e.scope);"function"!==m.get(b)&&q("The first parameter must be a function");for(c in e.inputValues||{})g[c]=e.inputValues[c];d={returned:b.apply(g,e.parameters||[]),properties:{},events:{},services:[]};null!=g.events&&!m.check("array",g.events)?r("Events must be stored in an array."):d.events=g.events;
for(c in g)void 0!==A[c]?d.properties[c]=g[c]:void 0===Q[c]&&r('The key "'+c+'" is not a method nor a property.');for(c in e.inputValues)d.properties[c]=g[c];for(c in g.services)d.services[c]=g.services[c];return d}function K(b){return Z[b]}function L(b){return I[b]}function r(b){var a=["["+p.name+"]"];x.strict||a.push("WARNING");for(var c in arguments)a.push(arguments[c]);X.apply(p,a)}function q(b){var a=["["+p.name+"]"],c;for(c in arguments)a.push(arguments[c]);T.apply(p,a)}function E(){var b=["["+
p.name+"]"],a;for(a in arguments)b.push(arguments[a]);Y.apply(p,b)}function F(b){var a=arguments.length,c=(b||"").toString().match(RegExp("^"+x.shortcutPrefix+"(\\w+)$"));if(!c||!c.length)return b;c=c[1];if("function"===m.get(S[c]))return S[c].call(h());if("function"===m.get(D[c]))return j(c);for(var d=1;d<a;d++)if(void 0!==(arguments[d]||{})[c])return arguments[d][c];return b}ba.call(this);var p=this,B=C.utils,m=B.type,M={},Z={},I={},D={},A={},G={},aa={},$={},U=[],N={},v={},O={},u={},J={},P={},R=
{},W={},S={},Q={events:1,services:1,hacks:1};(function(){for(var b in Object.prototype)Q[b]=1;for(b in h({full:1}))Q[b]=1})();var t={};this.name="domino";"string"===m.get(a)?this.name=a:void 0!==a&&"object"===m.get(a)?t=a:void 0!==f&&"object"===m.get(f)&&(t=f);this.name=t.name||this.name;(function(){for(var b in t.properties||[])e(t.properties[b].id,t.properties[b]);for(b in t.hacks||[]){var a=void 0,c=void 0,d=t.hacks[b]||{};void 0===d.triggers&&q("A hack requires at least one trigger to be added");
void 0===d.method&&void 0===d.dispatch&&q('A hack requires at least a method or a "dispatch" value to be added');a=B.array(d.triggers);for(c in a)d.method&&(J[a[c]]=J[a[c]]||[],J[a[c]].push(d.method)),d.dispatch&&(P[a[c]]=(P[a[c]]||[]).concat(B.array(d.dispatch)))}for(b in t.services||[])i(t.services[b]);for(b in t.shortcuts||[])a=t.shortcuts[b].id,c=t.shortcuts[b].method,void 0===a&&q("Shortcut ID not specified."),S[a]&&q('Shortcut "'+a+'" already exists.'),void 0===c&&q("Shortcut method not specified."),
S[a]=c})();return h({full:!0})};var C=L.domino;C.utils={array:function(a,f){var h="string"===C.utils.type.get(a)?a.split(f||" "):"array"===C.utils.type.get(a)?a:[a],e=[],i;for(i in h)h[i]&&e.push(h[i]);return e},ajax:function(a,f){"string"===typeof a?a={url:a,ok:f}:"object"!==this.type.get(a)&&T("[domino.global] Invalid parameter given to AJAX");var h=a.type||"GET",e=a.url||"",i=a.contentType||"application/x-www-form-urlencoded",l=a.dataType||"json",k=new XMLHttpRequest,d,j,w;if(a.data){if("string"===
typeof a.data)j=a.data;else if(/json/.test(i))j=JSON.stringify(a.data);else{j=[];for(w in a.data)j.push(encodeURIComponent(w)+"="+encodeURIComponent(a.data[w]));j=j.join("&")}/GET|DEL/i.test(h)&&(e+=/\?/.test(e)?"&"+j:"?"+j,j="")}k.onreadystatechange=function(){if(4==k.readyState)if(d&&clearTimeout(d),/^2/.test(k.status)){j=k.responseText;if(/json/.test(l))try{j=JSON.parse(k.responseText)}catch(e){return a.error&&a.error("JSON parse error: "+e.message,k)}a.success&&a.success(j,k)}else{var f=+k.status?
k.responseText:k.responseText.length?"Aborted: "+k.responseText:"Aborted";a.error&&a.error(f,k)}};k.open(h,e,!0);k.setRequestHeader("Content-Type",i);if(a.headers)for(w in a.headers)k.setRequestHeader(w,a.headers[w]);a.timeout&&(d=setTimeout(function(){k.onreadystatechange=function(){};k.abort();a.error&&a.error&&a.error("timeout",k)},1E3*a.timeout));k.send(j);return k},type:function(){var a=["number","string","boolean"],f="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),h={},
e=["*"],i;for(i in f){var l=f[i];e.push(l.toLowerCase());h["[object "+l+"]"]=l.toLowerCase()}return{get:function(a){return null==a?""+a:h[Object.prototype.toString.call(a)]||"object"},check:function(a,d){var f,h,i=this.get(d);if("string"===this.get(a)){f=a.replace(/^\?/,"").split(/\|/);for(h in f)0>e.indexOf(f[h])&&X("[domino.global] Invalid type");if(null==d)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");h=a.split(/\|/);return!(!~h.indexOf("*")&&!~h.indexOf(i))}if("object"===this.get(a)){if("object"!==
i)return!1;for(f in a)if(!this.check(a[f],d[f]))return!1;for(f in d)if(void 0===a[f])return!1;return!0}return!1},isAtom:function(e){return"string"===this.get(e)&&~a.indexOf(e)},isValid:function(a){var d,f;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(f in a)if(0>e.indexOf(a[f]))return!1;return!0}if("object"===this.get(a)){for(d in a)if(!this.isValid(a[d]))return!1;return!0}return!1}}}()};var K=C.utils,x={strict:!1,verbose:!1,shortcutPrefix:":",displayTime:!1};C.settings=function(a,
f){if("string"===typeof a&&void 0===f)return x[a];var h="object"===typeof a&&void 0===f?a||{}:{};"string"===typeof a&&(h[a]=f);for(var e in h)void 0!==x[e]&&(x[e]=h[e]);return this};C.EventDispatcher=function(){var a={};this.removeEventListener=function(f,h){if(!arguments.length)return this._handlers_={},this;var e,i,l,k,d=K.array(f);if(h)for(e in d){k=d[e];if(a[k]){l=[];for(i in a[k])a[k][i].handler!==h&&l.push(a[k][i]);a[k]=l}a[k]&&0===a[k].length&&delete a[k]}else for(e in d)delete a[d[e]];return this};
this.addEventListener=function(f,h){if(arguments.length)if(1===arguments.length&&"object"===K.type.get(arguments[0]))for(f in arguments[0])this.addEventListener(f,arguments[0][f]);else if(1<arguments.length){var e,f=arguments[0],h=arguments[1],i=K.array(f),l;for(l in i)e=i[l],a[e]||(a[e]=[]),a[e].push({handler:h})}return this};this.dispatchEvent=function(f,h){var e,i,l,k,d,j=K.array(f),h=void 0===h?{}:h;for(e in j)if(d=j[e],a[d]){k=this.getEvent(d,h);l=[];for(i in a[d])a[d][i].handler(k),a[d][i].one||
l.push(a[d][i]);a[d]=l}return this};this.getEvent=function(a,h){return{type:a,data:h,target:this}}};var ba=C.EventDispatcher;C.module=function(){ba.call(this);this.triggers={properties:{},events:{}}}})(window);
