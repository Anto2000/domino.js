/* domino.js - a JS fast dashboard prototyping framework - Version: 1.21 - Author:  Alexis Jacomy, Linkfluence - License: MIT */
(function(J,g){function $(){K.strict?v.apply(this,arguments):ma.apply(this,arguments)}function v(){var a="",g;for(g in arguments)a+=(a?" ":"")+arguments[g];throw Error(a);}function ma(){K.verbose&&ea.apply(this,arguments)}function ea(){var a=[],g;for(g in arguments)a.push(arguments[g]);K.displayTime&&a.unshift(("00000000"+((new Date).getTime()-na)).substr(-8));console&&console.log instanceof Function&&console.log.apply(console,a)}var ka=/^[a-zA-Z_$-][a-zA-Z_$0-9-]*$/,na=new Date,U={};if(J.domino)throw Error("domino already exists");
J.domino=function(a,e){function l(b){var b=b||{},h={getEvents:A,getLabel:oa,expand:P,warn:t,log:C,die:q,get:p};b.full?(h.kill=T,h.update=c,h.addModule=d,h.request=m,h.settings=x,h.dispatchEvent=function(b,h){s({events:L.getEvent(b,h)});return this}):(b.request&&(Object.defineProperty(h,"_services",{value:[]}),h.request=function(b,h){var a,j;if(k.check("string",b)){j={service:b};for(a in h||{})j[a]=h[a];this._services.push(j)}else if(k.check("object",b))this._services.push(b);else if(k.check("array",
b))for(a in b)this._services.push(b[a]);return this}),b.dispatchEvent&&(Object.defineProperty(h,"_events",{value:[]}),h.dispatchEvent=function(b,h){this._events.push({type:b,data:h});return this}));return h}function n(b){b.request!==g&&(b.request=function(){q("This method is no longer available.");return this});b.dispatchEvent!==g&&(b.dispatchEvent=function(){q("This method is no longer available.");return this})}function i(b,h){var a,fa,c=h||{};b===g&&q("Property name not specified");"string"!==
k.get(b)&&q("The property name must be a string");M[b]!==g&&q('Property "'+b+'" already exists');aa[b]!==g&&q('"'+b+'" can not be used to name a property');b.match(ka)||q("Property name not valid ("+ka+")");ga[b]={};for(fa in c)ga[b][fa]=c[fa];J[b]=c.label||b;c.type!==g&&(k.isValid(c.type)?N[b]=c.type:t('Property "'+b+'": Type not valid'));c.setter!==g&&("function"!==k.get(c.setter)?t('Property "'+b+'": Setter is not a function'):(D[b]=c.setter,ha[b]=!0));D[b]=D[b]||function(h){if(k.deepScalar(N[b])&&
k.compare(h,M[b],N[b]))return!1;N[b]&&!k.check(N[b],h)?t('Property "'+b+'": Wrong type error'):M[b]=h;return!0};c.getter!==g&&("function"!==k.get(c.getter)?t('Property "'+b+'": Getter is not a function'):(E[b]=c.getter,ia[b]=!0));E[b]=E[b]||function(){return M[b]};if(c.value!==g||N[b])c.value!==g?B(b,c.value):C('Property "'+b+'": Initial value is missing');if(c.triggers!==g)for(a in!k.check("array|string",c.triggers)&&t('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),
O[b]=y.array(c.triggers),O[b]||[])Q[O[b][a]]=Q[O[b][a]]||[],Q[O[b][a]].push(b);c.dispatch!==g&&(!k.check("array|string",c.dispatch)?t('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):V[b]=y.array(c.dispatch));return L}function o(b){var h=b||{};(h.id===g||"string"!==k.get(h.id))&&q("The service id is not indicated.");k.check("function|string",h.url)||q("The service URL is not valid.");W[h.id]!==g&&q('The service "'+h.id+'" already exists.');
W[h.id]=function(b){C('Calling service "'+h.id+'".');var a=b||{},c=a.shortcuts||{},j={contentType:a.contentType||h.contentType,dataType:a.dataType||h.dataType,type:(a.type||h.type||"GET").toString().toUpperCase(),data:a.data!==g?a.data:"function"===k.get(h.data)?h.data.call(l(),a):h.data,url:"function"===k.get(h.url)?h.url.call(l(),a):h.url,error:function(b,c){L.dispatchEvent("domino.ajaxFailed");var F=a.error||h.error;C('Loading service "'+h.id+'" failed with message "'+b+'" and status '+c.status+
".");"function"===k.get(F)&&G(F,{parameters:[b,c,a],loop:a.loop||s,scope:{request:!0,dispatchEvent:!0}})}},f,d,p;d=x("shortcutPrefix");var b=RegExp(d+"(\\w+)","g"),i=RegExp("^"+d+"(\\w+)$"),e=null,m;for("string"!==k.get(j.url)&&q('The URL is no more a string (typed "'+k.get(j.url)+'")');(m=j.url.match(b))&&j.url!==e;)for(f in e=j.url,m)d=P(m[f].match(i)[1],c),j.url=j.url.replace(RegExp(m[f],"g"),d);f=!0;"string"===k.get(j.data)&&j.data.match(i)&&(j.data=P(j.data.match(i)[1],c));if("object"===k.get(j.data))for(;f;)for(p in f=
!1,j.data)"string"===k.get(j.data[p])&&j.data[p].match(i)&&(j.data[p]=P(j.data[p].match(i)[1],c),f=!0);j.success=function(b){var F,f,d,e,ba={},ja=[],m=[],q={},o=!1,B=a.path||h.path,m=a.setter||h.setter,r=a.success||h.success;e=a.expect||h.expect||x("expect");if("function"===k.get(e)&&!e.call(l(),b,a,h))j.error.call(this,"Unexpected data received.",this.xhr());else{C('Service "'+h.id+'" successfull.');"string"===k.get(m)&&m.match(i)&&(m=P(m.match(i)[1],c));"string"===k.get(B)&&B.match(i)&&(B=P(B.match(i)[1],
c));e=b;(B||"").match(/^(?:\w+\.)*\w+$/)?f=k.get(B,"string")?B.split("."):g:"string"===k.get(B)&&t('Path "'+B+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(f)for(F in f)e=e[f[F]],e===g&&t('Wrong path "'+B+'" for service "'+h.id+'".');f=y.array(h.events);for(F in f)ba[f[F]]=1,o=!0;f=y.array(a.events);for(F in f)ba[f[F]]=1,o=!0;m&&D[m]&&e!==g&&(q[m]=e,o=!0);if("function"===k.get(r)){b=G(r,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});f=y.array(b.events);for(p in f)o=!0,ba[f[p].type]=
1;for(p in b.update)q[p]===g?(q[p]=b.update[p],o=!0):t('The key "'+p+'" is nor a method neither a property.');if((b.services||[]).length)o=!0,ja=ja.concat(b.services);n(b)}m=[];for(d in ba)m.push(L.getEvent(d,l()));o&&(a.loop||s)({events:m,update:q,services:ja})}};f=a.before||h.before;null!=f&&"function"===k.get(f)&&G(f,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});a.abort&&ca[h.id]&&ca[h.id].abort();ca[h.id]=y.ajax(j)};return L}function d(b,h){var a,c={},s={},j,d,e;b===g&&q("Module class not specified.");
"function"!==k.get(b)&&q("First parameter must be a function.");b.apply(c,(h||[]).concat(l()));j=c.triggers||{};for(e in j.events||{})R[e]=R[e]||[],R[e].push(j.events[e]);for(d in j.properties||{}){for(a in V[d]||[])S[d]=S[d]||[],S[d].push(j.properties[d]);E[d]!==g&&(p(d),G(j.properties[d],{parameters:[l()]}))}for(e in Q||{})s[e]=1;for(e in H||{})s[e]=1;for(e in I||{})s[e]=1;for(e in s)c.addEventListener(e,f);X.push(c);return c}function c(b,h){var a="object"===typeof b&&1===arguments.length?b||{}:
{};"string"===typeof b&&(a[b]=h);s({update:a});return this}function f(b){s({events:[b],emitter:b.target})}function s(b){var a,c,f,e,j,d,p,i=!1,k=[],o=[],r=[],b=b||{},u={},v={};b.loop=(+b.loop||0)+1;b.loopId=b.loopId||++$;x("maxDepth")&&b.loop>x("maxDepth")&&q("Loop "+b.loopId+" exceeds maximum depth ("+x("maxDepth")+")");var w=y.array(b.events);d=y.array(b.services);var A=b.update||{};if(x("verbose")){C("Iteration "+b.loop+" (loop "+b.loopId+")");if(w.length){p=[];for(c in w)p.push(w[c].type);C(" -> Events: ",
p)}if(d.length){p=[];for(c in d)p.push("string"===typeof d[c]?d[c]:d[c].service);C(" -> Services: ",p)}p=[];for(c in A)p.push(c);p.length&&C(" -> Update: ",p)}for(a in A)if(D[a]===g)t('The property "'+a+'" is not referenced.');else if(p=B(a,A[a])||!!b.force){for(c in S[a])G(S[a][c],{parameters:[l(),{property:a,emitter:b.emitter}]});for(c in V[a]||[])u[V[a][c]]=1}if(d.length)if(x("mergeRequests"))m(d);else for(f in d)m(d[f]);for(c in w){j=w[c];for(f in d=j.data||{},a=Q[j.type]||[],a)d[a[f]]!==g&&(i=
!0,v[a[f]]=d[a[f]]);for(e in R[j.type])G(R[j.type][e],{parameters:[l(),j,b.emitter]});for(f in H[j.type]||[])if(0>k.indexOf(H[j.type][f])){k.push(H[j.type][f]);d=G(H[j.type][f],{parameters:[j],scope:{request:!0,dispatchEvent:!0}});a=y.array(d.events);for(e in a)u[a[e].type]=1;for(e in d.update)v[e]===g?(i=!0,v[e]=d.update[e]):t('The property "'+e+'" has already been updated in the current loop.');if((d.services||[]).length)i=!0,r=r.concat(d.services);n(d)}for(f in I[j.type]||[])u[I[j.type][f]]=1}for(j in u)L.dispatchEvent(j,
l()),o.push(L.getEvent(j,l())),i=!0;i&&s({events:o,update:v,services:r,emitter:b.emitter,loopId:b.loopId,loop:b.loop})}function p(b){if(E[b]){if(ia[b]){for(var a=[],c={},f=1,d=arguments.length;f<d;f++)a.push(arguments[f]);c[b]=M[b];a=G(E[b],{parameters:a,inputValues:c});return z(b)?y.clone(a.returned):a.returned}return z(b)?y.clone(E[b]()):E[b]()}t('Property "'+b+'" not referenced.')}function B(b,a){if(D[b]){if(ha[b]){var c,f;c=[];f={};z(b)&&(a=y.clone(a));f[b]=p(b);for(var d=1,e=arguments.length;d<
e;d++)c.push(arguments[d]);f=G(D[b],{parameters:c,inputValues:f});(c="boolean"!==k.get(f.returned)||f.returned)&&(M[b]=f.update[b]);return c}return D[b].call(l(),z(b)?y.clone(a):a)}t('Property "'+b+'" not referenced.');return!1}function m(b,a){if(k.check("string",b))if(W[b])W[b](a);else t('Service "'+b+'" not referenced.');else if(k.check("object",b))m(b.service,b);else if(k.check("array",b)){var a=a||{},c,f=b.length;if(a.merge!==g?a.merge:x("mergeRequests")){var d,e,p=f,i=[];for(c=0;c<f;c++){if("string"===
typeof b[c])d={service:b[c]};else for(e in d={},b[c])d[e]=b[c][e];(function(b){d.loop=function(a){i[b]=a;if(!--p){var c,h,d={update:{},events:[],services:[]};for(c=0;c<f;c++){a=i[c]||{};for(h in a.update||{})d.update[h]=a.update[h];d.events=d.events.concat(a.events||[]);d.services=d.services.concat(a.services||[])}s(d)}}})(c);m(d)}}else for(c=0,f=b.length;c<f;c++)m(b[c])}return this}function G(b,a){var c,f,d=a||{},e=l(d.scope);"function"!==k.get(b)&&q("The first parameter must be a function");for(c in d.inputValues||
{})e[c]=d.inputValues[c];f={returned:b.apply(e,d.parameters||[]),update:{},events:[],services:[]};null!=e._events&&!k.check("array",e._events)?t("Events must be stored in an array."):f.events=e._events;for(c in e)D[c]!==g?f.update[c]=e[c]:aa[c]===g&&t('The key "'+c+'" is not a method nor a property.');for(c in d.inputValues)f.update[c]=e[c];for(c in e._services)f.services[c]=e._services[c];if(d.loop){e=(f.services||[]).length||(f.events||[]).length;if(!e)for(c in f.update)e=!0;e&&(k.check("function",
d.loop)?d.loop:s)(f)}else return f}function oa(b){return J[b]}function A(b){return O[b]}function P(b){var a=b,c=(b||"").toString().match(RegExp("^"+x("shortcutPrefix")+"(\\w+)$"));c&&c.length&&(t("Prefix in expand() calls is deprecated."),a=c[1]);for(var c=1,f=arguments.length;c<f;c++)if((arguments[c]||{})[a]!==g)return arguments[c][a];if("function"===k.get(E[a]))return p(a);if("function"===k.get(Y[a]))return Y[a].call(l());t('The shortcut "',a,'" has not been recognized.');return a}function z(b){b=
(ga[b]||{}).clone;return b!==g?!!b:x("clone")}function T(){var b;C('Killing instance "'+w+'"');for(b in X)X[b].removeEventListener();Y=ca=W=I=H=S=R=V=Q=X=ha=ia=M=D=E=O=J=N=X=null;for(b in Z)delete Z[b];U[w]&&delete U[w]}function x(b,a){if("string"===typeof b&&1===arguments.length)return da[b]!==g?da[b]:K[b];var c="object"===typeof b&&1===arguments.length?b||{}:{};"string"===typeof b&&(c[b]=a);for(var f in c)c[f]!==g?da[f]=c[f]:delete da[f];return this}function t(){var b=["["+(w||"domino")+"]"];x("strict")||
b.push("WARNING");for(var a in arguments)b.push(arguments[a]);x("strict")?v.apply(this,b):x("verbose")&&ea.apply(this,b)}function q(){var b=["["+(w||"domino")+"]"],a;for(a in arguments)b.push(arguments[a]);v.apply(this,b)}function C(){var b=["["+(w||"domino")+"]"];if(x("verbose")){for(var a in arguments)b.push(arguments[a]);ea.apply(this,b)}}la.call(this);var L=this,y=r.utils,k=r.struct,da={},Z,N={},J={},O={},E={},D={},M={},ga={},ia={},ha={},X=[],$=0,Q={},V={},R={},S={},H={},I={},W={},ca={},Y={},
aa={events:1,services:1,hacks:1};(function(){for(var b in Object.prototype)aa[b]=1;for(b in l({full:!0}))aa[b]=1})();Z=l({full:!0});var u={},w;"string"===k.get(a)?w=a:a!==g&&"object"===k.get(a)?u=a:e!==g&&"object"===k.get(e)&&(u=e);(w=u.name)&&(U[w]?q('An instance named "'+w+'" is already running.'):U[w]=Z);(function(){for(var b in u.properties||[])i(u.properties[b].id,u.properties[b]);for(b in u.hacks||[]){var a=void 0,c=void 0,f=u.hacks[b]||{};f.triggers===g&&q("A hack requires at least one trigger to be bound");
a=y.array(f.triggers);for(c in a)I[a[c]]=I[a[c]]||[],H[a[c]]=H[a[c]]||[],f.method&&H[a[c]].push(f.method),f.dispatch&&(I[a[c]]=I[a[c]].concat(y.array(f.dispatch)))}for(b in u.services||[])o(u.services[b]);for(b in u.shortcuts||[])a=u.shortcuts[b].id,c=u.shortcuts[b].method,a===g&&q("Shortcut ID not specified."),Y[a]&&q('Shortcut "'+a+'" already exists.'),c===g&&q("Shortcut method not specified."),Y[a]=c})();return Z};var r=J.domino;r.utils={array:function(a,e){var g="string"===r.struct.get(a)?a.split(e||
" "):"array"===r.struct.get(a)?a:[a],n=[],i;for(i in g)g[i]&&n.push(g[i]);return n},clone:function(a){if(!a)return a;var e,g;if("array"===z.get(a))for(g in e=[],a)e[g]=this.clone(a[g]);else if("date"===z.get(a))e=new Date(a.getTime());else if("object"===z.get(a))if(a.prototype)e=a;else{e={};for(var n in a)e[n]=this.clone(a[n])}else e=a;return e},ajax:function(a,e){"string"===typeof a?a={url:a,ok:e}:"object"!==z.get(a)&&v("[domino.global] Invalid parameter given to AJAX");var g=a.type||"GET",n=a.url||
"",i=a.contentType||"application/x-www-form-urlencoded",o=a.dataType||"json",d=new XMLHttpRequest,c,f,s;if(a.data){if("string"===typeof a.data)f=a.data;else if(/json/.test(i))f=JSON.stringify(a.data);else{f=[];for(s in a.data)f.push(encodeURIComponent(s)+"="+encodeURIComponent(a.data[s]));f=f.join("&")}/GET|DEL/i.test(g)&&(n+=/\?/.test(n)?"&"+f:"?"+f,f="")}d.onreadystatechange=function(){if(4==d.readyState)if(c&&clearTimeout(c),/^2/.test(d.status)){f=d.responseText;if(/json/.test(o))try{f=JSON.parse(d.responseText)}catch(e){return a.error&&
a.error("JSON parse error: "+e.message,d)}a.success&&a.success(f,d)}else{var g=+d.status?d.responseText:d.responseText.length?"Aborted: "+d.responseText:"Aborted";a.error&&a.error(g,d)}};d.open(g,n,!0);d.setRequestHeader("Content-Type",i);if(a.headers)for(s in a.headers)d.setRequestHeader(s,a.headers[s]);a.timeout&&(c=setTimeout(function(){d.onreadystatechange=function(){};d.abort();a.error&&a.error&&a.error("timeout",d)},1E3*a.timeout));d.send(f);return d}};r.struct=function(){var a=["number","string",
"boolean","null","undefined"],e="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),l={},n=["*"],i={},o;for(o in e){var d=e[o];n.push(d.toLowerCase());l["[object "+d+"]"]=d.toLowerCase()}return{add:function(a,f,d){var e,l,m,o,z,A;1===arguments.length?"object"===this.get(a)?(A=a,m=A.id,z=A.struct):v("[domino.global] If struct.add is called with one arguments, it has to be an object"):2===arguments.length?("string"!==this.get(a)||!a?v("[domino.global] If struct.add is called with more than one arguments, the first one must be the string id"):
m=a,z=f):v("[domino.global] struct.add has to be called with one or three arguments");("string"!==this.get(m)||0===m.length)&&v("[domino.global] A structure requires an string id");i[m]!==g&&"proto"!==i[m]&&v('[domino.global] The structure "'+m+'" already exists');i[m]=1;l=r.utils.array((A||{}).proto);o={};for(e in l)i[l[e]]===g&&(i[l[e]]=1,o[l[e]]=1);"function"!==this.get(z)&&!this.isValid(z)&&v('[domino.global] A structure requires a valid "structure" property describing the structure. It can be a valid structure or a function that test if an object matches the structure.');
~n.indexOf(m)&&v('[domino.global] "'+m+'" is a reserved structure name');i[m]=A===g?{id:m,struct:z}:{};if(A!==g)for(e in A)i[m][e]=A[e];for(e in o)e!==m&&delete i[e]},get:function(a){return null==a?""+a:l[Object.prototype.toString.call(a)]||"object"},check:function(a,f){var d,e,l=this.get(f);if("string"===this.get(a)){d=a.replace(/^\?/,"").split(/\|/);for(e in d)if(0>n.indexOf(d[e])&&i[d[e]]===g)return $("[domino.global] Invalid type"),!1;if(null==f)return!!a.match(/^\?/,"");a.replace(/^\?/,"");for(e in d)if(i[d[e]]&&
("function"===this.get(i[d[e]].struct)&&!0===i[d[e]].struct(f)||this.check(i[d[e]].struct,f)))return!0;return!(!~d.indexOf("*")&&!~d.indexOf(l))}if("object"===this.get(a)){if("object"!==l)return!1;for(d in a)if(!this.check(a[d],f[d]))return!1;for(d in f)if(a[d]===g)return!1;return!0}if("array"===this.get(a)){if("array"!==l)return!1;if(1!==a.length)return $("[domino.global] Invalid type"),!1;for(d in f)if(!this.check(a[0],f[d]))return!1;return!0}return!1},deepScalar:function(c){var d;if("string"===
this.get(c)){c=c.replace(/^\?/,"").split(/\|/);for(d in c)if(0>a.indexOf(c[d]))return!1;return!0}if(this.check("object|array",c)){for(d in c)if(!this.deepScalar(c[d]))return!1;return!0}return!1},compare:function(a,d,e){this.get(a);this.get(d);var g;if(!this.deepScalar(e)||!this.check(e,a)||!this.check(e,d))return!1;if("string"===this.get(e))return a===d;if("object"===this.get(e)){for(g in e)if(!this.compare(a[g],d[g],e[g]))return!1;return!0}if("array"===this.get(e)){if(a.length!==d.length)return!1;
var i=a.length;for(g=0;g<i;g++)if(!this.compare(a[g],d[g],e[0]))return!1;return!0}return!1},isValid:function(a){var d,e;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(e in a)if(0>n.indexOf(a[e])&&i[a[e]]===g)return!1;return!0}if("object"===this.get(a)){for(d in a)if(!this.isValid(a[d]))return!1;return!0}return"array"===this.get(a)?1===a.length?this.isValid(a[0]):!1:!1}}}();var T=r.utils,z=r.struct,K={maxDepth:0,strict:!1,verbose:!1,displayTime:!1,shortcutPrefix:":",mergeRequests:!0,
clone:!1};r.settings=function(a,e){if("string"===typeof a&&1===arguments.length)return K[a];var l="object"===typeof a&&1===arguments.length?a||{}:{};"string"===typeof a&&(l[a]=e);for(var n in l)l[n]!==g?K[n]=l[n]:delete K[n];return this};r.instances=function(a){if(arguments.length)return U[a];v("[domino.global] You need to indicate a name to get the instance.")};r.EventDispatcher=function(){var a={};this.removeEventListener=function(e,g){if(!arguments.length)return this._handlers_={},this;var n,i,
o,d,c=T.array(e);if(g)for(n in c){d=c[n];if(a[d]){o=[];for(i in a[d])a[d][i].handler!==g&&o.push(a[d][i]);a[d]=o}a[d]&&0===a[d].length&&delete a[d]}else for(n in c)delete a[c[n]];return this};this.addEventListener=function(e,g){if(arguments.length)if(1===arguments.length&&"object"===T.type.get(arguments[0]))for(e in arguments[0])this.addEventListener(e,arguments[0][e]);else if(1<arguments.length){var n,e=arguments[0],g=arguments[1],i=T.array(e),o;for(o in i)n=i[o],a[n]||(a[n]=[]),a[n].push({handler:g})}return this};
this.dispatchEvent=function(e,l){var n,i,o,d,c,f=T.array(e),l=l===g?{}:l;for(n in f)if(c=f[n],a[c]){d=this.getEvent(c,l);o=[];for(i in a[c])a[c][i].handler(d),a[c][i].one||o.push(a[c][i]);a[c]=o}return this};this.getEvent=function(a,g){return{type:a,data:g,target:this}}};var la=r.EventDispatcher;r.module=function(){la.call(this);this.triggers={properties:{},events:{}}}})(window);
