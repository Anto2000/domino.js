/* domino.js - a JS fast dashboard prototyping framework - Version: 1.0 - Author:  Alexis Jacomy, Linkfluence - License: MIT */
(function(O){function ca(){p.strict?V.apply(this,arguments):da.apply(this,arguments)}function V(){var a="",c;for(c in arguments)a+=(a?" ":"")+arguments[c];throw Error(a);}function da(){if(p.verbose){var a=[],c;for(c in arguments)a.push(arguments[c]);p.displayTime&&a.unshift(("00000000"+((new Date).getTime()-Z)).substr(-8));console&&"function"===typeof console.log&&console.log.apply(console,a)}}var Z=new Date,P={};if(O.domino)throw Error("domino already exists");O.domino=function(a,c){function g(b){var b=
b||{},h={getEvents:O,getLabel:N,expand:I,warn:t,log:y,die:m,get:o};b.full?(h.kill=Z,h.update=d,h.addModule=k,h.request=H,h.dispatchEvent=function(b,h){j({events:x.getEvent(b,h)})}):(b.request&&(Object.defineProperty(h,"_services",{value:[]}),h.request=function(b,h){this._services.push({service:b,params:h})}),b.dispatchEvent&&(Object.defineProperty(h,"_events",{value:[]}),h.dispatchEvent=function(b,h){this._events.push({type:b,data:h})}));return h}function e(b,h){var a,n=h||{};void 0===b&&m("Property name not specified");
void 0!==D[b]&&m('Property "'+b+'" already exists');void 0!==W[b]&&m('"'+b+'" can not be used to name a property');$[b]=n.label||b;void 0!==n.type&&(i.isValid(n.type)?E[b]=n.type:t('Property "'+b+'": Type not valid'));void 0!==n.setter&&("function"!==i.get(n.setter)?t('Property "'+b+'": Setter is not a function'):(z[b]=n.setter,aa[b]=!0));z[b]=z[b]||function(h){if(i.deepScalar(E[b])&&i.compare(h,D[b],E[b]))return!1;E[b]&&!i.check(E[b],h)?t('Property "'+b+'": Wrong type error'):D[b]=h;return!0};void 0!==
n.getter&&("function"!==i.get(n.getter)?t('Property "'+b+'": Getter is not a function'):(A[b]=n.getter,ba[b]=!0));A[b]=A[b]||function(){return D[b]};if(void 0!==n.value||E[b])void 0!==n.value?ea(b,n.value):y('Property "'+b+'": Initial value is missing');if(void 0!==n.triggers)for(a in!i.check("array|string",n.triggers)&&t('Property "'+b+'": Events ("triggers") must be specified in an array or separated by spaces in a string'),F[b]=u.array(n.triggers),F[b]||[])J[F[b][a]]=J[F[b][a]]||[],J[F[b][a]].push(b);
void 0!==n.dispatch&&(!i.check("array|string",n.dispatch)?t('Property "'+b+'": Events ("dispatch") must be specified in an array or separated by spaces in a string'):Q[b]=u.array(n.dispatch));return x}function l(b){var h=b||{};(void 0===h.id||"string"!==i.get(h.id))&&m("The service id is not indicated.");i.check("function|string",h.url)||m("The service URL is not valid.");void 0!==R[h.id]&&m('The service "'+h.id+'" already exists.');R[h.id]=function(b){y('Calling service "'+h.id+'".');var a=b||{},
d=a.shortcuts||{},b={contentType:a.contentType||h.contentType,dataType:a.dataType||h.dataType,type:(a.type||h.type||"GET").toString().toUpperCase(),data:"function"===i.get(h.data)?h.data.call(g(),a):void 0!=a.data?a.data:h.data,url:"function"===i.get(h.url)?h.url.call(g(),a):h.url,error:function(b,d){x.dispatchEvent("domino.ajaxFailed");var B=a.error||h.error;"function"===i.get(B)?C(B,{parameters:[b,d,a],loop:!0,scope:{request:!0,dispatchEvent:!0}}):y('Loading service "'+h.id+'" failed with message "'+
b+'" and status '+d.status+".")}},q,c,w;c=p.shortcutPrefix;var f=RegExp(c+"(\\w+)","g"),e=RegExp("^"+c+"(\\w+)$"),l=null,o;for("string"!==i.get(b.url)&&m('The URL is no more a string (typed "'+i.get(b.url)+'")');(o=b.url.match(f))&&b.url!==l;)for(q in l=b.url,o)c=I(o[q].match(e)[1],d),b.url=b.url.replace(RegExp(o[q],"g"),c);q=!0;"string"===i.get(b.data)&&b.data.match(e)&&(b.data=I(b.data.match(e)[1],d));if("object"===i.get(b.data))for(;q;)for(w in q=!1,b.data)"string"===i.get(b.data[w])&&b.data[w].match(e)&&
(b.data[w]=I(b.data[w].match(e)[1],d),q=!0);b.success=function(b){y('Service "'+h.id+'" successfull.');var B,c,q,f,o={},l=[];f=[];var X={},m=!1,k=a.path||h.path,p=a.setter||h.setter,r=a.success||h.success;"string"===i.get(p)&&p.match(e)&&(p=I(p.match(e)[1],d));"string"===i.get(k)&&k.match(e)&&(k=I(k.match(e)[1],d));f=b;(k||"").match(/^(?:\w+\.)*\w+$/)?c=i.get(k,"string")?k.split("."):void 0:"string"===i.get(k)&&t('Path "'+k+'" does not match RegExp /^(?:\\w+\\.)*\\w+$/');if(c)for(B in c)f=f[c[B]],
void 0===f&&t('Wrong path "'+k+'" for service "'+h.id+'".');c=u.array(h.events);for(B in c)o[c[B]]=1,m=!0;c=u.array(a.events);for(B in c)o[c[B]]=1,m=!0;p&&z[p]&&void 0!==f&&(X[p]=f,m=!0);if("function"===i.get(r)){b=C(r,{parameters:[b,a],scope:{request:!0,dispatchEvent:!0}});c=u.array(b.events);for(w in c)m=!0,o[c[w].type]=1;for(w in b.update)void 0===X[w]?(X[w]=b.update[w],m=!0):t('The key "'+w+'" is nor a method neither a property.');if((b.services||[]).length)m=!0,l=l.concat(b.services)}f=[];for(q in o)x.dispatchEvent(q,
g()),f.push(x.getEvent(q,g()));m&&j({events:f,update:X,services:l})};q=a.before||h.before;null!=q&&"function"===i.get(q)&&C(q,{parameters:[a],loop:!0,scope:{dispatchEvent:!0}});a.abort&&Y[h.id]&&Y[h.id].abort();Y[h.id]=u.ajax(b)};return x}function k(b,h){var a,d={},c={},q,j,e;void 0===b&&m("Module class not specified.");"function"!==i.get(b)&&m("First parameter must be a function.");b.apply(d,(h||[]).concat(g()));q=d.triggers||{};for(e in q.events||{})K[e]=K[e]||[],K[e].push(q.events[e]);for(j in q.properties||
{}){for(a in Q[j]||[])L[j]=L[j]||[],L[j].push(q.properties[j]);void 0!==A[j]&&(o(j),C(q.properties[j],{parameters:[g()]}))}for(e in J||{})c[e]=1;for(e in G||{})c[e]=1;for(e in M||{})c[e]=1;for(e in c)d.addEventListener(e,f);S.push(d);return d}function d(b){j({update:b});return this}function f(b){j({events:[b]})}function j(b){var a,d,n,c,e,f,i,o=!1,l=[],k=[],b=b||{},m={},r={};b.loop=(+b.loop||0)+1;var s=u.array(b.events);f=u.array(b.services);var v=b.update||{};if(p.verbose){y("Iteration "+b.loop+
" (main loop)");if(s.length){i=[];for(d in s)i.push(s[d].type);y(" -> Events: ",i)}if(f.length){i=[];for(d in f)i.push(f[d].service);y(" -> Services: ",i)}i=[];for(d in v)i.push(d);i.length&&y(" -> Update: ",i)}for(a in v)if(void 0===z[a])t('The property "'+a+'" is not referenced.');else if(i=ea(a,v[a])||!!b.force){for(d in L[a])C(L[a][d],{parameters:[g(),{property:a}]});for(d in Q[a]||[])m[Q[a][d]]=1}for(d in f||[])H(f[d].service,f[d].params);for(d in s){e=s[d];for(n in f=e.data||{},a=J[e.type]||
[],a)void 0!==f[a[n]]&&(o=!0,r[a[n]]=f[a[n]]);for(c in K[e.type])C(K[e.type][c],{parameters:[g(),e]});for(n in G[e.type]||[]){f=C(G[e.type][n],{parameters:[e],scope:{request:!0,dispatchEvent:!0}});a=u.array(f.events);for(c in a)m[a[c].type]=1;for(c in f.update)void 0===r[c]?(o=!0,r[c]=f.update[c]):t('The property "'+c+'" is not a method nor a property.');if((f.services||[]).length)o=!0,k=k.concat(f.services)}for(n in M[e.type]||[])m[M[e.type][n]]=1}for(e in m)x.dispatchEvent(e,g()),l.push(x.getEvent(e,
g())),o=!0;o&&j({events:l,update:r,services:k,loop:b.loop})}function o(b){if(A[b]){if(ba[b]){for(var a=[],d={},c=1,e=arguments.length;c<e;c++)a.push(arguments[c]);d[b]=D[b];a=C(A[b],{parameters:a,inputValues:d});return p.clone?u.clone(a.returned):a.returned}return p.clone?u.clone(A[b]()):A[b]()}t('Property "'+b+'" not referenced.')}function ea(b,a){if(z[b]){if(aa[b]){var d,c;d=[];c={};p.clone&&(a=u.clone(a));c[b]=o(b);for(var e=1,f=arguments.length;e<f;e++)d.push(arguments[e]);c=C(z[b],{parameters:d,
inputValues:c});(d="boolean"!==i.get(c.returned)||c.returned)&&(D[b]=c.update[b]);return d}return z[b].call(g(),p.clone?u.clone(a):a)}t('Property "'+b+'" not referenced.');return!1}function H(b,a){if(R[b])R[b](a);else t('Service "'+b+'" not referenced.');return this}function C(b,a){var d,c,e=a||{},f=g(e.scope);"function"!==i.get(b)&&m("The first parameter must be a function");for(d in e.inputValues||{})f[d]=e.inputValues[d];c={returned:b.apply(f,e.parameters||[]),update:{},events:[],services:[]};
null!=f._events&&!i.check("array",f._events)?t("Events must be stored in an array."):c.events=f._events;for(d in f)void 0!==z[d]?c.update[d]=f[d]:void 0===W[d]&&t('The key "'+d+'" is not a method nor a property.');for(d in e.inputValues)c.update[d]=f[d];for(d in f._services)c.services[d]=f._services[d];if(e.loop){e=(c.services||[]).length||(c.events||[]).length;if(!e)for(d in c.update)e=!0;e&&j(c)}else return c}function N(b){return $[b]}function O(b){return F[b]}function I(b){var a=b,d=arguments.length,
c=(b||"").toString().match(RegExp("^"+p.shortcutPrefix+"(\\w+)$"));c&&c.length&&(t("Prefix in expand() calls is deprecated."),a=c[1]);if("function"===i.get(T[a]))return T[a].call(g());if("function"===i.get(A[a]))return o(a);for(c=1;c<d;c++)if(void 0!==(arguments[c]||{})[a])return arguments[c][a];if(p.strict)m('The shortcut "',a,'" has not been recognized.');else return a}function Z(){var b;y('Killing instance "'+v+'"');for(b in S)S[b].removeEventListener();T=Y=R=M=G=L=K=Q=J=S=aa=ba=D=z=A=F=$=E=S=
null;for(b in U)delete U[b];P[v]&&delete P[v]}function t(){var b=["["+v+"]"];p.strict||b.push("WARNING");for(var a in arguments)b.push(arguments[a]);ca.apply(x,b)}function m(){var b=["["+v+"]"],a;for(a in arguments)b.push(arguments[a]);V.apply(x,b)}function y(){var b=["["+v+"]"],a;for(a in arguments)b.push(arguments[a]);da.apply(x,b)}fa.call(this);var x=this,u=r.utils,i=r.struct,U,E={},$={},F={},A={},z={},D={},ba={},aa={},S=[],J={},Q={},K={},L={},G={},M={},R={},Y={},T={},W={events:1,services:1,hacks:1};
(function(){for(var a in Object.prototype)W[a]=1;for(a in g({full:!0}))W[a]=1})();U=g({full:!0});var s={},v;"string"===i.get(a)?v=a:void 0!==a&&"object"===i.get(a)?s=a:void 0!==c&&"object"===i.get(c)&&(s=c);(v=s.name)&&(P[v]?m('An instance named "'+v+'" is already running.'):P[v]=U);(function(){for(var a in s.properties||[])e(s.properties[a].id,s.properties[a]);for(a in s.hacks||[]){var d=void 0,c=void 0,f=s.hacks[a]||{};void 0===f.triggers&&m("A hack requires at least one trigger to be added");void 0===
f.method&&void 0===f.dispatch&&m('A hack requires at least a method or a "dispatch" value to be added');d=u.array(f.triggers);for(c in d)f.method&&(G[d[c]]=G[d[c]]||[],G[d[c]].push(f.method)),f.dispatch&&(M[d[c]]=(M[d[c]]||[]).concat(u.array(f.dispatch)))}for(a in s.services||[])l(s.services[a]);for(a in s.shortcuts||[])d=s.shortcuts[a].id,c=s.shortcuts[a].method,void 0===d&&m("Shortcut ID not specified."),T[d]&&m('Shortcut "'+d+'" already exists.'),void 0===c&&m("Shortcut method not specified."),
T[d]=c})();return U};var r=O.domino;r.utils={array:function(a,c){var g="string"===r.struct.get(a)?a.split(c||" "):"array"===r.struct.get(a)?a:[a],e=[],l;for(l in g)g[l]&&e.push(g[l]);return e},clone:function(a){if(!a)return a;var c,g;if("array"===H.get(a))for(g in c=[],a)c[g]=this.clone(a[g]);else if("date"===H.get(a))c=new Date(a.getTime());else if("object"===H.get(a))if(a.prototype)c=a;else{c={};for(var e in a)c[e]=this.clone(a[e])}else c=a;return c},ajax:function(a,c){"string"===typeof a?a={url:a,
ok:c}:"object"!==H.get(a)&&V("[domino.global] Invalid parameter given to AJAX");var g=a.type||"GET",e=a.url||"",l=a.contentType||"application/x-www-form-urlencoded",k=a.dataType||"json",d=new XMLHttpRequest,f,j,o;if(a.data){if("string"===typeof a.data)j=a.data;else if(/json/.test(l))j=JSON.stringify(a.data);else{j=[];for(o in a.data)j.push(encodeURIComponent(o)+"="+encodeURIComponent(a.data[o]));j=j.join("&")}/GET|DEL/i.test(g)&&(e+=/\?/.test(e)?"&"+j:"?"+j,j="")}d.onreadystatechange=function(){if(4==
d.readyState)if(f&&clearTimeout(f),/^2/.test(d.status)){j=d.responseText;if(/json/.test(k))try{j=JSON.parse(d.responseText)}catch(c){return a.error&&a.error("JSON parse error: "+c.message,d)}a.success&&a.success(j,d)}else{var e=+d.status?d.responseText:d.responseText.length?"Aborted: "+d.responseText:"Aborted";a.error&&a.error(e,d)}};d.open(g,e,!0);d.setRequestHeader("Content-Type",l);if(a.headers)for(o in a.headers)d.setRequestHeader(o,a.headers[o]);a.timeout&&(f=setTimeout(function(){d.onreadystatechange=
function(){};d.abort();a.error&&a.error&&a.error("timeout",d)},1E3*a.timeout));d.send(j);return d}};r.struct=function(){var a=["number","string","boolean","null","undefined"],c="Boolean,Number,String,Function,Array,Date,RegExp,Object".split(","),g={},e=["*"],l;for(l in c){var k=c[l];e.push(k.toLowerCase());g["[object "+k+"]"]=k.toLowerCase()}return{get:function(a){return null==a?""+a:g[Object.prototype.toString.call(a)]||"object"},check:function(a,c){var j,g,k=this.get(c);if("string"===this.get(a)){j=
a.replace(/^\?/,"").split(/\|/);for(g in j)0>e.indexOf(j[g])&&ca("[domino.global] Invalid type");if(null==c)return!!a.match(/^\?/,"");a=a.replace(/^\?/,"");g=a.split(/\|/);return!(!~g.indexOf("*")&&!~g.indexOf(k))}if("object"===this.get(a)){if("object"!==k)return!1;for(j in a)if(!this.check(a[j],c[j]))return!1;for(j in c)if(void 0===a[j])return!1;return!0}return!1},deepScalar:function(d){var c;if("string"===this.get(d)){d=d.replace(/^\?/,"").split(/\|/);for(c in d)if(0>a.indexOf(d[c]))return!1;return!0}if("object"===
this.get(d)){for(c in d)if(!this.deepScalar(d[c]))return!1;return!0}return!1},compare:function(a,c,e){this.get(a);this.get(c);var g;if(!this.deepScalar(e)||!this.check(e,a)||!this.check(e,c))return!1;if("string"===this.get(e))return a===c;if("object"===this.get(e)){for(g in e)if(!this.compare(a[g],c[g],e[g]))return!1;return!0}return!1},isValid:function(a){var c,g;if("string"===this.get(a)){a=a.replace(/^\?/,"").split(/\|/);for(g in a)if(0>e.indexOf(a[g]))return!1;return!0}if("object"===this.get(a)){for(c in a)if(!this.isValid(a[c]))return!1;
return!0}return!1}}}();var N=r.utils,H=r.struct,p={strict:!1,verbose:!1,shortcutPrefix:":",displayTime:!1,clone:!1};r.settings=function(a,c){if("string"===typeof a&&void 0===c)return p[a];var g="object"===typeof a&&void 0===c?a||{}:{};"string"===typeof a&&(g[a]=c);for(var e in g)void 0!==p[e]&&(p[e]=g[e]);return this};r.instances=function(a){if(arguments.length)return P[a];V("[domino.global] You need to indicate a name to get the instance.")};r.EventDispatcher=function(){var a={};this.removeEventListener=
function(c,g){if(!arguments.length)return this._handlers_={},this;var e,l,k,d,f=N.array(c);if(g)for(e in f){d=f[e];if(a[d]){k=[];for(l in a[d])a[d][l].handler!==g&&k.push(a[d][l]);a[d]=k}a[d]&&0===a[d].length&&delete a[d]}else for(e in f)delete a[f[e]];return this};this.addEventListener=function(c,g){if(arguments.length)if(1===arguments.length&&"object"===N.type.get(arguments[0]))for(c in arguments[0])this.addEventListener(c,arguments[0][c]);else if(1<arguments.length){var e,c=arguments[0],g=arguments[1],
l=N.array(c),k;for(k in l)e=l[k],a[e]||(a[e]=[]),a[e].push({handler:g})}return this};this.dispatchEvent=function(c,g){var e,l,k,d,f,j=N.array(c),g=void 0===g?{}:g;for(e in j)if(f=j[e],a[f]){d=this.getEvent(f,g);k=[];for(l in a[f])a[f][l].handler(d),a[f][l].one||k.push(a[f][l]);a[f]=k}return this};this.getEvent=function(a,g){return{type:a,data:g,target:this}}};var fa=r.EventDispatcher;r.module=function(){fa.call(this);this.triggers={properties:{},events:{}}}})(window);
